{
  "api_spec": {
    "openapi": "3.0.0",
    "info": {
      "title": "E-Commerce API",
      "version": "1.0.0"
    },
    "paths": {
      "/api/addresses": {
        "post": {
          "operationId": "addAddress",
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "city": {
                      "maxLength": 100,
                      "type": "string"
                    },
                    "country": {
                      "pattern": "^[A-Z]{2}$",
                      "type": "string"
                    },
                    "is_default": {
                      "default": false,
                      "type": "boolean"
                    },
                    "postal_code": {
                      "maxLength": 20,
                      "type": "string"
                    },
                    "recipient_name": {
                      "maxLength": 100,
                      "type": "string"
                    },
                    "state": {
                      "maxLength": 100,
                      "type": "string"
                    },
                    "street": {
                      "maxLength": 200,
                      "type": "string"
                    }
                  },
                  "required": [
                    "recipient_name",
                    "street",
                    "city",
                    "state",
                    "postal_code",
                    "country"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "201": {
              "description": "Address added"
            },
            "400": {
              "description": "Incomplete address or international shipping not available"
            }
          },
          "summary": "Add shipping address",
          "x-related-specs": [
            "TS-BR-ADDR-001",
            "TS-BR-SHIP-002"
          ]
        }
      },
      "/api/addresses/{addressId}": {
        "put": {
          "operationId": "updateAddress",
          "parameters": [
            {
              "in": "path",
              "name": "addressId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "city": {
                      "maxLength": 100,
                      "type": "string"
                    },
                    "country": {
                      "pattern": "^[A-Z]{2}$",
                      "type": "string"
                    },
                    "is_default": {
                      "type": "boolean"
                    },
                    "postal_code": {
                      "maxLength": 20,
                      "type": "string"
                    },
                    "recipient_name": {
                      "maxLength": 100,
                      "type": "string"
                    },
                    "state": {
                      "maxLength": 100,
                      "type": "string"
                    },
                    "street": {
                      "maxLength": 200,
                      "type": "string"
                    }
                  },
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Address updated"
            },
            "400": {
              "description": "Validation error"
            },
            "404": {
              "description": "Address not found"
            }
          },
          "summary": "Update shipping address",
          "x-related-specs": [
            "TS-BR-ADDR-001"
          ]
        }
      },
      "/api/admin/orders": {
        "get": {
          "operationId": "adminListOrders",
          "parameters": [
            {
              "in": "query",
              "name": "status",
              "schema": {
                "enum": [
                  "pending",
                  "confirmed",
                  "shipped",
                  "delivered",
                  "cancelled"
                ],
                "type": "string"
              }
            },
            {
              "in": "query",
              "name": "start_date",
              "schema": {
                "format": "date",
                "type": "string"
              }
            },
            {
              "in": "query",
              "name": "end_date",
              "schema": {
                "format": "date",
                "type": "string"
              }
            },
            {
              "in": "query",
              "name": "search",
              "schema": {
                "type": "string"
              }
            },
            {
              "in": "query",
              "name": "page",
              "schema": {
                "default": 1,
                "type": "integer"
              }
            },
            {
              "in": "query",
              "name": "limit",
              "schema": {
                "default": 20,
                "type": "integer"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Paginated order list with filters"
            },
            "401": {
              "description": "Admin authentication required"
            }
          },
          "summary": "List all orders (admin)",
          "x-related-specs": [
            "TS-BR-ORDER-001"
          ]
        }
      },
      "/api/cart": {
        "get": {
          "operationId": "getCart",
          "responses": {
            "200": {
              "description": "Cart with items and totals"
            },
            "410": {
              "description": "Cart expired"
            }
          },
          "summary": "Get current cart with current prices",
          "x-related-specs": [
            "TS-BR-CART-001",
            "TS-BR-CART-003"
          ]
        }
      },
      "/api/cart/items": {
        "post": {
          "operationId": "addCartItem",
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "product_id": {
                      "format": "uuid",
                      "type": "string"
                    },
                    "quantity": {
                      "minimum": 1,
                      "type": "integer"
                    },
                    "variant_id": {
                      "format": "uuid",
                      "type": "string"
                    }
                  },
                  "required": [
                    "product_id",
                    "quantity"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Quantity adjusted due to stock limits"
            },
            "201": {
              "description": "Item added to cart"
            },
            "400": {
              "description": "Variant required for this product"
            },
            "409": {
              "description": "Out of stock"
            }
          },
          "summary": "Add item to cart",
          "x-related-specs": [
            "TS-BR-STOCK-001",
            "TS-BR-VAR-002",
            "TS-BR-CART-002"
          ]
        }
      },
      "/api/cart/items/{itemId}": {
        "delete": {
          "operationId": "removeCartItem",
          "parameters": [
            {
              "in": "path",
              "name": "itemId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Item removed with undo token"
            },
            "404": {
              "description": "Cart item not found"
            }
          },
          "summary": "Remove item from cart",
          "x-related-specs": [
            "TS-BR-CART-002"
          ]
        },
        "put": {
          "operationId": "updateCartItem",
          "parameters": [
            {
              "in": "path",
              "name": "itemId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "quantity": {
                      "minimum": 0,
                      "type": "integer"
                    }
                  },
                  "required": [
                    "quantity"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Cart item updated"
            },
            "404": {
              "description": "Cart item not found"
            }
          },
          "summary": "Update cart item quantity",
          "x-related-specs": [
            "TS-BR-CART-002"
          ]
        }
      },
      "/api/cart/merge": {
        "post": {
          "operationId": "mergeCart",
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "guest_session_id": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "guest_session_id"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Carts merged"
            },
            "404": {
              "description": "Guest cart not found"
            }
          },
          "summary": "Merge guest cart with authenticated user cart",
          "x-related-specs": [
            "TS-BR-CART-002"
          ]
        }
      },
      "/api/categories": {
        "get": {
          "operationId": "listCategories",
          "responses": {
            "200": {
              "description": "Category tree up to 3 levels"
            }
          },
          "summary": "List categories with hierarchy",
          "x-related-specs": [
            "TS-BR-CAT-001"
          ]
        },
        "post": {
          "operationId": "createCategory",
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "is_active": {
                      "default": true,
                      "type": "boolean"
                    },
                    "name": {
                      "type": "string"
                    },
                    "parent_id": {
                      "format": "uuid",
                      "type": "string"
                    }
                  },
                  "required": [
                    "name"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "201": {
              "description": "Category created"
            },
            "400": {
              "description": "Category depth exceeded"
            }
          },
          "summary": "Create category",
          "x-related-specs": [
            "TS-BR-CAT-001"
          ]
        }
      },
      "/api/checkout/shipping": {
        "get": {
          "operationId": "calculateShipping",
          "parameters": [
            {
              "in": "query",
              "name": "address_id",
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Shipping cost (0 if subtotal \u003e= $50)"
            }
          },
          "summary": "Calculate shipping cost",
          "x-related-specs": [
            "TS-BR-SHIP-001"
          ]
        }
      },
      "/api/checkout/tax": {
        "get": {
          "operationId": "calculateTax",
          "parameters": [
            {
              "in": "query",
              "name": "address_id",
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Tax amount based on shipping state"
            },
            "400": {
              "description": "Address missing state"
            }
          },
          "summary": "Calculate tax based on shipping address",
          "x-related-specs": [
            "TS-BR-SHIP-001"
          ]
        }
      },
      "/api/customers": {
        "post": {
          "operationId": "registerCustomer",
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "email": {
                      "format": "email",
                      "type": "string"
                    },
                    "first_name": {
                      "type": "string"
                    },
                    "last_name": {
                      "type": "string"
                    },
                    "password": {
                      "minLength": 8,
                      "type": "string"
                    }
                  },
                  "required": [
                    "email",
                    "password",
                    "first_name",
                    "last_name"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "201": {
              "description": "Customer registered, verification email sent"
            },
            "400": {
              "description": "Validation error (weak password)"
            },
            "409": {
              "description": "Email already registered"
            }
          },
          "summary": "Register new customer",
          "x-related-specs": [
            "TS-BR-CUST-001",
            "TS-BR-CUST-002"
          ]
        }
      },
      "/api/customers/{customerId}": {
        "delete": {
          "operationId": "deleteCustomer",
          "parameters": [
            {
              "in": "path",
              "name": "customerId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "confirmation": {
                      "type": "boolean"
                    },
                    "deletion_type": {
                      "enum": [
                        "soft_delete",
                        "full_erasure"
                      ],
                      "type": "string"
                    }
                  },
                  "required": [
                    "deletion_type",
                    "confirmation"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Account deleted"
            },
            "400": {
              "description": "Confirmation required"
            },
            "409": {
              "description": "Has pending orders"
            }
          },
          "summary": "Delete customer account",
          "x-related-specs": [
            "TS-BR-CUST-001"
          ]
        }
      },
      "/api/customers/{customerId}/password": {
        "put": {
          "operationId": "changePassword",
          "parameters": [
            {
              "in": "path",
              "name": "customerId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "current_password": {
                      "type": "string"
                    },
                    "new_password": {
                      "minLength": 8,
                      "type": "string"
                    }
                  },
                  "required": [
                    "current_password",
                    "new_password"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Password changed"
            },
            "400": {
              "description": "Weak password"
            },
            "401": {
              "description": "Current password incorrect"
            }
          },
          "summary": "Change customer password",
          "x-related-specs": [
            "TS-BR-CUST-002"
          ]
        }
      },
      "/api/customers/{customerId}/verify-email": {
        "post": {
          "operationId": "verifyEmail",
          "parameters": [
            {
              "in": "path",
              "name": "customerId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "verification_token": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "verification_token"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Email verified"
            },
            "400": {
              "description": "Invalid or expired token"
            }
          },
          "summary": "Verify customer email",
          "x-related-specs": [
            "TS-BR-CUST-003"
          ]
        }
      },
      "/api/inventory/import": {
        "post": {
          "operationId": "importInventory",
          "requestBody": {
            "content": {
              "multipart/form-data": {
                "schema": {
                  "properties": {
                    "file": {
                      "format": "binary",
                      "type": "string"
                    }
                  },
                  "required": [
                    "file"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Import results with row-by-row errors"
            },
            "400": {
              "description": "Invalid file format"
            }
          },
          "summary": "Bulk import inventory from CSV",
          "x-related-specs": [
            "TS-BR-INV-001",
            "TS-BR-AUDIT-002"
          ]
        }
      },
      "/api/inventory/{variantId}": {
        "put": {
          "operationId": "adjustInventory",
          "parameters": [
            {
              "in": "path",
              "name": "variantId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "adjustment_type": {
                      "enum": [
                        "absolute",
                        "delta"
                      ],
                      "type": "string"
                    },
                    "reason": {
                      "maxLength": 200,
                      "type": "string"
                    },
                    "value": {
                      "type": "integer"
                    }
                  },
                  "required": [
                    "adjustment_type",
                    "value"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Inventory adjusted"
            },
            "400": {
              "description": "Would result in negative inventory"
            },
            "404": {
              "description": "Variant not found"
            }
          },
          "summary": "Adjust inventory",
          "x-related-specs": [
            "TS-BR-INV-001",
            "TS-BR-AUDIT-002"
          ]
        }
      },
      "/api/orders": {
        "get": {
          "operationId": "listOrders",
          "parameters": [
            {
              "in": "query",
              "name": "page",
              "schema": {
                "default": 1,
                "type": "integer"
              }
            },
            {
              "in": "query",
              "name": "limit",
              "schema": {
                "default": 20,
                "type": "integer"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Paginated order list"
            },
            "401": {
              "description": "Not authenticated"
            }
          },
          "summary": "List customer orders",
          "x-related-specs": [
            "TS-BR-ORDER-001"
          ]
        },
        "post": {
          "operationId": "createOrder",
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "payment_method_id": {
                      "format": "uuid",
                      "type": "string"
                    },
                    "shipping_address_id": {
                      "format": "uuid",
                      "type": "string"
                    }
                  },
                  "required": [
                    "shipping_address_id",
                    "payment_method_id"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "201": {
              "description": "Order created"
            },
            "400": {
              "description": "Empty cart"
            },
            "401": {
              "description": "Registration required"
            },
            "402": {
              "description": "Payment authorization failed"
            },
            "403": {
              "description": "Email not verified"
            },
            "409": {
              "description": "Insufficient stock or backorder not supported"
            }
          },
          "summary": "Place order",
          "x-related-specs": [
            "TS-BR-AUTH-001",
            "TS-BR-STOCK-001",
            "TS-BR-INV-002",
            "TS-BR-PAY-001",
            "TS-BR-PRICE-002",
            "TS-BR-AUDIT-001"
          ]
        }
      },
      "/api/orders/{orderId}": {
        "get": {
          "operationId": "getOrder",
          "parameters": [
            {
              "in": "path",
              "name": "orderId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Order details with captured prices"
            },
            "404": {
              "description": "Order not found"
            }
          },
          "summary": "Get order details",
          "x-related-specs": [
            "TS-BR-ORDER-002",
            "TS-BR-PRICE-002"
          ]
        }
      },
      "/api/orders/{orderId}/cancel": {
        "post": {
          "operationId": "cancelOrder",
          "parameters": [
            {
              "in": "path",
              "name": "orderId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Order cancelled, refund initiated"
            },
            "409": {
              "description": "Order cannot be cancelled (already shipped)"
            }
          },
          "summary": "Cancel order",
          "x-related-specs": [
            "TS-BR-CANCEL-001",
            "TS-BR-INV-003",
            "TS-BR-PAY-002",
            "TS-BR-AUDIT-001"
          ]
        }
      },
      "/api/orders/{orderId}/status": {
        "put": {
          "operationId": "updateOrderStatus",
          "parameters": [
            {
              "in": "path",
              "name": "orderId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "status": {
                      "enum": [
                        "confirmed",
                        "shipped",
                        "delivered"
                      ],
                      "type": "string"
                    },
                    "tracking_number": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "status"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Status updated"
            },
            "409": {
              "description": "Invalid status transition"
            }
          },
          "summary": "Update order status (admin)",
          "x-related-specs": [
            "TS-BR-ORDER-001",
            "TS-BR-AUDIT-001"
          ]
        }
      },
      "/api/payment-methods": {
        "post": {
          "operationId": "addPaymentMethod",
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "is_default": {
                      "default": false,
                      "type": "boolean"
                    },
                    "payment_type": {
                      "enum": [
                        "card",
                        "paypal"
                      ],
                      "type": "string"
                    },
                    "paypal_authorization": {
                      "type": "string"
                    },
                    "stripe_token": {
                      "type": "string"
                    }
                  },
                  "required": [
                    "payment_type"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "201": {
              "description": "Payment method added"
            },
            "400": {
              "description": "Invalid card or unsupported type"
            }
          },
          "summary": "Add payment method",
          "x-related-specs": [
            "TS-BR-PAY-001"
          ]
        }
      },
      "/api/products": {
        "get": {
          "operationId": "listProducts",
          "parameters": [
            {
              "in": "query",
              "name": "category",
              "schema": {
                "type": "string"
              }
            },
            {
              "in": "query",
              "name": "priceMin",
              "schema": {
                "minimum": 0,
                "type": "number"
              }
            },
            {
              "in": "query",
              "name": "priceMax",
              "schema": {
                "type": "number"
              }
            },
            {
              "in": "query",
              "name": "availability",
              "schema": {
                "enum": [
                  "inStock",
                  "all"
                ],
                "type": "string"
              }
            },
            {
              "in": "query",
              "name": "sortBy",
              "schema": {
                "enum": [
                  "price_asc",
                  "price_desc",
                  "name_asc",
                  "name_desc"
                ],
                "type": "string"
              }
            },
            {
              "in": "query",
              "name": "page",
              "schema": {
                "default": 1,
                "type": "integer"
              }
            },
            {
              "in": "query",
              "name": "limit",
              "schema": {
                "default": 20,
                "maximum": 100,
                "type": "integer"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Paginated product list"
            },
            "400": {
              "description": "Invalid filter parameters"
            }
          },
          "summary": "List products with filtering and pagination",
          "x-related-specs": [
            "TS-BR-PROD-001",
            "TS-BR-PROD-002"
          ]
        },
        "post": {
          "operationId": "createProduct",
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "category_id": {
                      "format": "uuid",
                      "type": "string"
                    },
                    "description": {
                      "maxLength": 5000,
                      "type": "string"
                    },
                    "name": {
                      "maxLength": 200,
                      "minLength": 2,
                      "type": "string"
                    },
                    "price": {
                      "minimum": 0.01,
                      "type": "number"
                    }
                  },
                  "required": [
                    "name",
                    "price",
                    "category_id"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "201": {
              "description": "Product created"
            },
            "400": {
              "description": "Validation error"
            }
          },
          "summary": "Create new product",
          "x-related-specs": [
            "TS-BR-PRICE-001",
            "TS-BR-PROD-002",
            "TS-BR-PROD-003"
          ]
        }
      },
      "/api/products/{productId}": {
        "delete": {
          "operationId": "deleteProduct",
          "parameters": [
            {
              "in": "path",
              "name": "productId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "responses": {
            "204": {
              "description": "Product deleted"
            },
            "404": {
              "description": "Product not found"
            }
          },
          "summary": "Delete product (soft delete if has orders)",
          "x-related-specs": [
            "TS-BR-PROD-001"
          ]
        },
        "get": {
          "operationId": "getProduct",
          "parameters": [
            {
              "in": "path",
              "name": "productId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "responses": {
            "200": {
              "description": "Product details with variants and stock status"
            },
            "404": {
              "description": "Product not found"
            }
          },
          "summary": "Get product details",
          "x-related-specs": [
            "TS-BR-STOCK-001"
          ]
        },
        "put": {
          "operationId": "updateProduct",
          "parameters": [
            {
              "in": "path",
              "name": "productId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "category_id": {
                      "format": "uuid",
                      "type": "string"
                    },
                    "description": {
                      "maxLength": 5000,
                      "type": "string"
                    },
                    "name": {
                      "maxLength": 200,
                      "minLength": 2,
                      "type": "string"
                    },
                    "price": {
                      "minimum": 0.01,
                      "type": "number"
                    }
                  },
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "200": {
              "description": "Product updated"
            },
            "400": {
              "description": "Validation error"
            },
            "404": {
              "description": "Product not found"
            }
          },
          "summary": "Update product",
          "x-related-specs": [
            "TS-BR-PRICE-001",
            "TS-BR-PROD-002",
            "TS-BR-AUDIT-003"
          ]
        }
      },
      "/api/products/{productId}/images": {
        "post": {
          "operationId": "uploadProductImage",
          "parameters": [
            {
              "in": "path",
              "name": "productId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "multipart/form-data": {
                "schema": {
                  "properties": {
                    "image": {
                      "format": "binary",
                      "type": "string"
                    },
                    "is_primary": {
                      "default": false,
                      "type": "boolean"
                    }
                  },
                  "required": [
                    "image"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "201": {
              "description": "Image uploaded"
            },
            "400": {
              "description": "Image limit exceeded or invalid format"
            }
          },
          "summary": "Upload product image",
          "x-related-specs": [
            "TS-BR-PROD-004"
          ]
        }
      },
      "/api/products/{productId}/variants": {
        "post": {
          "operationId": "createVariant",
          "parameters": [
            {
              "in": "path",
              "name": "productId",
              "required": true,
              "schema": {
                "format": "uuid",
                "type": "string"
              }
            }
          ],
          "requestBody": {
            "content": {
              "application/json": {
                "schema": {
                  "properties": {
                    "options": {
                      "additionalProperties": {
                        "type": "string"
                      },
                      "type": "object"
                    },
                    "price_override": {
                      "minimum": 0.01,
                      "type": "number"
                    },
                    "sku": {
                      "maxLength": 100,
                      "type": "string"
                    }
                  },
                  "required": [
                    "sku",
                    "options"
                  ],
                  "type": "object"
                }
              }
            }
          },
          "responses": {
            "201": {
              "description": "Variant created"
            },
            "400": {
              "description": "Validation error"
            },
            "409": {
              "description": "Duplicate SKU"
            }
          },
          "summary": "Create product variant",
          "x-related-specs": [
            "TS-BR-VAR-001"
          ]
        }
      }
    }
  },
  "implementation_skeletons": [
    {
      "name": "ProductService",
      "type": "service",
      "functions": [
        {
          "name": "create",
          "signature": "create(data: CreateProductDTO): Product",
          "description": "Create new product with validation",
          "steps": [
            "Validate name length (2-200 chars)",
            "Validate price \u003e= $0.01",
            "Validate category exists",
            "Check for duplicate name (warn only)",
            "Generate UUID",
            "Set status to draft",
            "Set created_by and timestamps",
            "Persist product"
          ],
          "error_cases": [
            "INVALID_PRODUCT_NAME",
            "INVALID_PRICE",
            "CATEGORY_NOT_FOUND"
          ]
        },
        {
          "name": "update",
          "signature": "update(productId: UUID, data: UpdateProductDTO): Product",
          "description": "Update product with price audit trail",
          "steps": [
            "Fetch existing product",
            "Validate name length if provided",
            "Validate price \u003e= $0.01 if provided",
            "Detect price change for audit",
            "Update fields",
            "Set modified_by and timestamps",
            "Log price change to audit trail if changed",
            "Persist product"
          ],
          "error_cases": [
            "PRODUCT_NOT_FOUND",
            "INVALID_PRODUCT_NAME",
            "INVALID_PRICE"
          ]
        },
        {
          "name": "delete",
          "signature": "delete(productId: UUID): void",
          "description": "Soft delete product, remove from active carts",
          "steps": [
            "Check if product has order history",
            "If has orders, set deleted_at timestamp (soft delete)",
            "If no orders, perform hard delete",
            "Remove product from all active carts",
            "Notify affected cart owners"
          ],
          "error_cases": [
            "PRODUCT_NOT_FOUND"
          ]
        },
        {
          "name": "addImage",
          "signature": "addImage(productId: UUID, image: File, isPrimary: boolean): ProductImage",
          "description": "Upload product image with limit check",
          "steps": [
            "Count existing images",
            "Reject if count \u003e= 10",
            "Upload image to storage",
            "If isPrimary, unset other primary flags",
            "Create ProductImage record"
          ],
          "error_cases": [
            "IMAGE_LIMIT_EXCEEDED",
            "PRODUCT_NOT_FOUND"
          ]
        }
      ],
      "dependencies": [
        "CategoryService",
        "AuditLogService",
        "CartService",
        "StorageService"
      ],
      "related_specs": [
        "TS-BR-PROD-001",
        "TS-BR-PROD-002",
        "TS-BR-PROD-003",
        "TS-BR-PROD-004",
        "TS-BR-AUDIT-003"
      ]
    },
    {
      "name": "VariantService",
      "type": "service",
      "functions": [
        {
          "name": "create",
          "signature": "create(productId: UUID, data: CreateVariantDTO): ProductVariant",
          "description": "Create product variant with unique SKU",
          "steps": [
            "Validate product exists",
            "Check SKU uniqueness",
            "Create variant with options",
            "Initialize inventory record with 0 stock"
          ],
          "error_cases": [
            "PRODUCT_NOT_FOUND",
            "DUPLICATE_SKU"
          ]
        }
      ],
      "dependencies": [
        "ProductService",
        "InventoryService"
      ],
      "related_specs": [
        "TS-BR-VAR-001"
      ]
    },
    {
      "name": "CartService",
      "type": "service",
      "functions": [
        {
          "name": "getCart",
          "signature": "getCart(sessionOrCustomerId: string): Cart",
          "description": "Get cart with current product prices",
          "steps": [
            "Find cart by session or customer ID",
            "Check cart expiration (7 days guest, 30 days authenticated)",
            "If expired, return CART_EXPIRED error",
            "For each item, fetch current price from Product/Variant",
            "Detect and flag price changes since item was added",
            "Calculate totals with current prices"
          ],
          "error_cases": [
            "CART_EXPIRED"
          ]
        },
        {
          "name": "addItem",
          "signature": "addItem(cartId: UUID, productId: UUID, variantId: UUID | null, quantity: number): CartItem",
          "description": "Add item to cart with stock validation",
          "steps": [
            "Validate product exists and not deleted",
            "If product has variants, require variantId",
            "Check available stock",
            "If stock == 0, return OUT_OF_STOCK error",
            "Check for existing cart item (same product/variant)",
            "If exists, increment quantity (cap at stock)",
            "If new, create cart item",
            "Store price_at_add for change detection",
            "Update cart last_activity_at",
            "Return actual quantity added (may be capped)"
          ],
          "error_cases": [
            "OUT_OF_STOCK",
            "VARIANT_REQUIRED",
            "PRODUCT_NOT_FOUND",
            "QUANTITY_EXCEEDS_STOCK"
          ]
        },
        {
          "name": "updateQuantity",
          "signature": "updateQuantity(itemId: UUID, quantity: number): CartItem",
          "description": "Update cart item quantity with stock limit",
          "steps": [
            "Find cart item",
            "If quantity == 0, remove item",
            "Check available stock",
            "Cap quantity at available stock",
            "Update quantity",
            "Update cart last_activity_at",
            "Notify if quantity was capped"
          ],
          "error_cases": [
            "CART_ITEM_NOT_FOUND",
            "QUANTITY_EXCEEDS_STOCK"
          ]
        },
        {
          "name": "removeItem",
          "signature": "removeItem(itemId: UUID): UndoToken",
          "description": "Remove item immediately with undo option",
          "steps": [
            "Find and remove cart item",
            "Store removed item in temporary undo buffer",
            "Generate undo token with TTL",
            "Update cart last_activity_at"
          ],
          "error_cases": [
            "CART_ITEM_NOT_FOUND"
          ]
        },
        {
          "name": "mergeGuestCart",
          "signature": "mergeGuestCart(customerId: UUID, guestSessionId: string): Cart",
          "description": "Merge guest cart into authenticated user cart",
          "steps": [
            "Find guest cart by session",
            "Find or create customer cart",
            "For each guest item:",
            "  - Check if product/variant exists in customer cart",
            "  - If exists, combine quantities (cap at stock)",
            "  - If new, add to customer cart",
            "Delete guest cart",
            "Notify if any quantities were capped"
          ],
          "error_cases": [
            "GUEST_CART_NOT_FOUND"
          ]
        }
      ],
      "dependencies": [
        "ProductService",
        "InventoryService"
      ],
      "related_specs": [
        "TS-BR-CART-001",
        "TS-BR-CART-002",
        "TS-BR-CART-003",
        "TS-BR-STOCK-001",
        "TS-BR-VAR-002"
      ]
    },
    {
      "name": "CustomerService",
      "type": "service",
      "functions": [
        {
          "name": "register",
          "signature": "register(data: RegisterDTO): Customer",
          "description": "Register new customer with email verification",
          "steps": [
            "Validate email format",
            "Check email uniqueness",
            "Validate password (8+ chars, at least one digit)",
            "Hash password",
            "Create customer with emailVerified=false",
            "Generate verification token",
            "Queue verification email"
          ],
          "error_cases": [
            "EMAIL_ALREADY_REGISTERED",
            "WEAK_PASSWORD"
          ]
        },
        {
          "name": "verifyEmail",
          "signature": "verifyEmail(customerId: UUID, token: string): void",
          "description": "Verify customer email address",
          "steps": [
            "Find customer",
            "Validate token matches and not expired",
            "Set emailVerified=true",
            "Clear verification token"
          ],
          "error_cases": [
            "INVALID_TOKEN",
            "TOKEN_EXPIRED"
          ]
        },
        {
          "name": "changePassword",
          "signature": "changePassword(customerId: UUID, currentPassword: string, newPassword: string): void",
          "description": "Change customer password with validation",
          "steps": [
            "Find customer",
            "Verify current password",
            "Validate new password strength",
            "Hash new password",
            "Update password"
          ],
          "error_cases": [
            "INVALID_CURRENT_PASSWORD",
            "WEAK_PASSWORD"
          ]
        },
        {
          "name": "deleteAccount",
          "signature": "deleteAccount(customerId: UUID, deletionType: 'soft_delete' | 'full_erasure', confirmed: boolean): void",
          "description": "Delete customer account with pending order check",
          "steps": [
            "Verify confirmation flag is true",
            "Check for pending/processing orders",
            "If has incomplete orders, reject deletion",
            "If soft_delete, set deactivated status",
            "If full_erasure, anonymize all personal data"
          ],
          "error_cases": [
            "CONFIRMATION_REQUIRED",
            "HAS_PENDING_ORDERS"
          ]
        }
      ],
      "dependencies": [
        "EmailService"
      ],
      "related_specs": [
        "TS-BR-CUST-001",
        "TS-BR-CUST-002",
        "TS-BR-CUST-003"
      ]
    },
    {
      "name": "AddressService",
      "type": "service",
      "functions": [
        {
          "name": "create",
          "signature": "create(customerId: UUID, data: CreateAddressDTO): ShippingAddress",
          "description": "Add shipping address with validation",
          "steps": [
            "Validate all required fields present",
            "Validate country is domestic",
            "Validate postal code format for country",
            "If is_default, unset other defaults",
            "Create address"
          ],
          "error_cases": [
            "INCOMPLETE_ADDRESS",
            "INTERNATIONAL_SHIPPING_NOT_AVAILABLE",
            "INVALID_POSTAL_CODE"
          ]
        },
        {
          "name": "validate",
          "signature": "validate(address: ShippingAddress): ValidationResult",
          "description": "Validate address fields",
          "steps": [
            "Check recipient_name not empty",
            "Check street not empty",
            "Check city not empty",
            "Check state not empty",
            "Check postal_code not empty",
            "Check country is valid ISO code",
            "Check country matches domestic config"
          ],
          "error_cases": [
            "INCOMPLETE_ADDRESS"
          ]
        }
      ],
      "dependencies": [
        "ConfigService"
      ],
      "related_specs": [
        "TS-BR-ADDR-001",
        "TS-BR-SHIP-002"
      ]
    },
    {
      "name": "OrderService",
      "type": "service",
      "functions": [
        {
          "name": "create",
          "signature": "create(customerId: UUID, addressId: UUID, paymentMethodId: UUID): Order",
          "description": "Create order with full validation flow",
          "steps": [
            "Validate customer is registered",
            "Validate customer email is verified",
            "Get cart and validate not empty",
            "Validate all items have sufficient stock",
            "Authorize payment",
            "If payment fails, return PAYMENT_REQUIRED error",
            "Create order with status=pending",
            "For each cart item:",
            "  - Create OrderItem with captured price",
            "  - Decrement inventory atomically",
            "Calculate shipping (free if subtotal \u003e= $50)",
            "Calculate tax based on shipping state",
            "Clear cart",
            "Queue confirmation email",
            "Log order creation to audit"
          ],
          "error_cases": [
            "REGISTRATION_REQUIRED",
            "EMAIL_NOT_VERIFIED",
            "EMPTY_CART",
            "INSUFFICIENT_STOCK",
            "BACKORDER_NOT_SUPPORTED",
            "PAYMENT_REQUIRED"
          ]
        },
        {
          "name": "cancel",
          "signature": "cancel(orderId: UUID, customerId: UUID): void",
          "description": "Cancel order with inventory restoration and refund",
          "steps": [
            "Find order",
            "Verify customer owns order",
            "Validate status is pending or confirmed",
            "Set status to cancelled",
            "For each order item, restore inventory",
            "Initiate refund via payment gateway",
            "Queue cancellation email",
            "Log cancellation to audit"
          ],
          "error_cases": [
            "ORDER_NOT_FOUND",
            "CANCELLATION_NOT_ALLOWED",
            "UNAUTHORIZED"
          ]
        },
        {
          "name": "updateStatus",
          "signature": "updateStatus(orderId: UUID, newStatus: OrderStatus, trackingNumber?: string): Order",
          "description": "Update order status following state machine",
          "steps": [
            "Find order",
            "Validate transition is allowed by state machine",
            "Update status",
            "If shipped, optionally set tracking number",
            "Log status change to audit",
            "Queue notification email to customer"
          ],
          "error_cases": [
            "ORDER_NOT_FOUND",
            "INVALID_STATUS_TRANSITION"
          ]
        }
      ],
      "dependencies": [
        "CartService",
        "CustomerService",
        "InventoryService",
        "PaymentService",
        "ShippingService",
        "TaxService",
        "EmailService",
        "AuditLogService"
      ],
      "related_specs": [
        "TS-BR-AUTH-001",
        "TS-BR-STOCK-001",
        "TS-BR-INV-002",
        "TS-BR-INV-003",
        "TS-BR-ORDER-001",
        "TS-BR-ORDER-002",
        "TS-BR-PRICE-002",
        "TS-BR-PAY-001",
        "TS-BR-PAY-002",
        "TS-BR-CANCEL-001",
        "TS-BR-AUDIT-001"
      ]
    },
    {
      "name": "OrderStateMachine",
      "type": "utility",
      "functions": [
        {
          "name": "validateTransition",
          "signature": "validateTransition(currentStatus: OrderStatus, newStatus: OrderStatus): boolean",
          "description": "Check if status transition is valid",
          "steps": [
            "Define allowed transitions map:",
            "  - pending  [confirmed, cancelled]",
            "  - confirmed  [shipped, cancelled]",
            "  - shipped  [delivered]",
            "  - delivered  []",
            "  - cancelled  []",
            "Check if newStatus is in allowed transitions for currentStatus"
          ],
          "error_cases": [
            "INVALID_STATUS_TRANSITION"
          ]
        }
      ],
      "dependencies": [],
      "related_specs": [
        "TS-BR-ORDER-001"
      ]
    },
    {
      "name": "InventoryService",
      "type": "service",
      "functions": [
        {
          "name": "adjust",
          "signature": "adjust(variantId: UUID, adjustmentType: 'absolute' | 'delta', value: number, reason?: string): Inventory",
          "description": "Adjust inventory with audit trail",
          "steps": [
            "Find inventory record",
            "Calculate new stock level",
            "If result would be negative, reject",
            "Check low stock threshold",
            "Update available_stock",
            "Log adjustment to audit with before/after values",
            "If crossed low stock threshold, trigger alert"
          ],
          "error_cases": [
            "VARIANT_NOT_FOUND",
            "INSUFFICIENT_STOCK"
          ]
        },
        {
          "name": "decrement",
          "signature": "decrement(variantId: UUID, quantity: number): void",
          "description": "Atomically decrement inventory for order",
          "steps": [
            "Execute atomic UPDATE with WHERE available_stock \u003e= quantity",
            "If no rows affected, throw INSUFFICIENT_STOCK"
          ],
          "error_cases": [
            "INSUFFICIENT_STOCK"
          ]
        },
        {
          "name": "restore",
          "signature": "restore(variantId: UUID, quantity: number): void",
          "description": "Restore inventory on order cancellation",
          "steps": [
            "Increment available_stock by quantity",
            "Log restoration to audit"
          ],
          "error_cases": [
            "VARIANT_NOT_FOUND"
          ]
        },
        {
          "name": "importFromCSV",
          "signature": "importFromCSV(file: File): ImportResult",
          "description": "Bulk import inventory from CSV",
          "steps": [
            "Parse CSV file",
            "For each row:",
            "  - Validate variant exists",
            "  - Validate quantity is non-negative number",
            "  - Apply adjustment",
            "  - Track success/failure per row",
            "Return results with row-by-row errors"
          ],
          "error_cases": [
            "INVALID_FILE_FORMAT"
          ]
        }
      ],
      "dependencies": [
        "AuditLogService",
        "AlertService"
      ],
      "related_specs": [
        "TS-BR-INV-001",
        "TS-BR-INV-002",
        "TS-BR-INV-003",
        "TS-BR-AUDIT-002"
      ]
    },
    {
      "name": "ShippingService",
      "type": "service",
      "functions": [
        {
          "name": "calculateCost",
          "signature": "calculateCost(subtotal: number): number",
          "description": "Calculate shipping cost with free shipping threshold",
          "steps": [
            "If subtotal \u003e= 50.00, return 0",
            "Otherwise return 5.99"
          ],
          "error_cases": []
        }
      ],
      "dependencies": [],
      "related_specs": [
        "TS-BR-SHIP-001"
      ]
    },
    {
      "name": "TaxService",
      "type": "service",
      "functions": [
        {
          "name": "calculateTax",
          "signature": "calculateTax(subtotal: number, shippingAddress: ShippingAddress): number",
          "description": "Calculate tax based on shipping state",
          "steps": [
            "Validate state is provided",
            "Look up tax rate for state",
            "Calculate tax = subtotal * rate",
            "Return tax amount (0 for no-tax states)"
          ],
          "error_cases": [
            "STATE_REQUIRED",
            "INVALID_STATE"
          ]
        }
      ],
      "dependencies": [
        "TaxRateRepository"
      ],
      "related_specs": [
        "TS-BR-SHIP-001"
      ]
    },
    {
      "name": "PaymentService",
      "type": "service",
      "functions": [
        {
          "name": "authorize",
          "signature": "authorize(paymentMethodId: UUID, amount: number): PaymentAuthorization",
          "description": "Authorize payment before order creation",
          "steps": [
            "Get payment method (tokenized card or PayPal)",
            "Call payment gateway to authorize amount",
            "Return authorization ID on success"
          ],
          "error_cases": [
            "PAYMENT_FAILED",
            "CARD_DECLINED"
          ]
        },
        {
          "name": "refund",
          "signature": "refund(authorizationId: string, amount: number): RefundResult",
          "description": "Initiate refund for cancelled order",
          "steps": [
            "Call payment gateway to refund",
            "Track refund status (async completion)"
          ],
          "error_cases": [
            "REFUND_FAILED"
          ]
        }
      ],
      "dependencies": [
        "PaymentGateway (Stripe)"
      ],
      "related_specs": [
        "TS-BR-PAY-001",
        "TS-BR-PAY-002"
      ]
    },
    {
      "name": "CheckoutService",
      "type": "service",
      "functions": [
        {
          "name": "placeOrder",
          "signature": "placeOrder(customerId: UUID, shippingAddressId: UUID, paymentMethodId: UUID): Order",
          "description": "Orchestrate complete checkout flow",
          "steps": [
            "Validate customer registered and email verified",
            "Get and validate cart (not empty, items in stock)",
            "Get shipping address",
            "Calculate subtotal, shipping, tax",
            "Authorize payment for total",
            "Create order via OrderService",
            "Return order with confirmation"
          ],
          "error_cases": [
            "REGISTRATION_REQUIRED",
            "EMAIL_NOT_VERIFIED",
            "EMPTY_CART",
            "INSUFFICIENT_STOCK",
            "PAYMENT_REQUIRED"
          ]
        },
        {
          "name": "validateCart",
          "signature": "validateCart(cart: Cart): ValidationResult",
          "description": "Validate all cart items for checkout",
          "steps": [
            "Check cart not empty",
            "For each item, check stock availability",
            "Collect any out-of-stock items",
            "Return validation result with issues"
          ],
          "error_cases": [
            "EMPTY_CART",
            "ITEMS_OUT_OF_STOCK"
          ]
        }
      ],
      "dependencies": [
        "CustomerService",
        "CartService",
        "AddressService",
        "ShippingService",
        "TaxService",
        "PaymentService",
        "OrderService"
      ],
      "related_specs": [
        "TS-BR-AUTH-001",
        "TS-BR-STOCK-001",
        "TS-BR-CUST-003"
      ]
    },
    {
      "name": "CategoryService",
      "type": "service",
      "functions": [
        {
          "name": "create",
          "signature": "create(name: string, parentId: UUID | null, isActive: boolean): Category",
          "description": "Create category with depth validation",
          "steps": [
            "If parentId provided, fetch parent",
            "Calculate depth = parent.depth + 1",
            "If depth \u003e 3, reject",
            "Create category"
          ],
          "error_cases": [
            "PARENT_NOT_FOUND",
            "CATEGORY_DEPTH_EXCEEDED"
          ]
        },
        {
          "name": "getHierarchy",
          "signature": "getHierarchy(): CategoryTree",
          "description": "Get full category tree for display",
          "steps": [
            "Fetch all active categories",
            "Build tree structure by parent relationships",
            "Return nested tree"
          ],
          "error_cases": []
        }
      ],
      "dependencies": [],
      "related_specs": [
        "TS-BR-CAT-001"
      ]
    },
    {
      "name": "AuditLogService",
      "type": "service",
      "functions": [
        {
          "name": "log",
          "signature": "log(entityType: string, entityId: UUID, action: string, beforeValue: object | null, afterValue: object, userId: UUID, reason?: string): void",
          "description": "Log audit event",
          "steps": [
            "Create audit log entry with timestamp",
            "Store before/after as JSONB",
            "Persist to audit_log table"
          ],
          "error_cases": []
        }
      ],
      "dependencies": [],
      "related_specs": [
        "TS-BR-AUDIT-001",
        "TS-BR-AUDIT-002",
        "TS-BR-AUDIT-003"
      ]
    },
    {
      "name": "EmailService",
      "type": "service",
      "functions": [
        {
          "name": "queueOrderConfirmation",
          "signature": "queueOrderConfirmation(order: Order): void",
          "description": "Queue order confirmation email asynchronously",
          "steps": [
            "Build email with order details",
            "Add to email queue",
            "Do not block on send"
          ],
          "error_cases": []
        },
        {
          "name": "queueCancellationConfirmation",
          "signature": "queueCancellationConfirmation(order: Order): void",
          "description": "Queue cancellation confirmation email",
          "steps": [
            "Build cancellation email",
            "Add to email queue"
          ],
          "error_cases": []
        },
        {
          "name": "queueStatusNotification",
          "signature": "queueStatusNotification(order: Order, newStatus: OrderStatus): void",
          "description": "Queue order status update notification",
          "steps": [
            "Build status update email",
            "Add to email queue"
          ],
          "error_cases": []
        }
      ],
      "dependencies": [
        "EmailQueue"
      ],
      "related_specs": [
        "TS-BR-PAY-002"
      ]
    },
    {
      "name": "CartExpirationJob",
      "type": "scheduled_job",
      "functions": [
        {
          "name": "run",
          "signature": "run(): void",
          "description": "Clean up expired carts daily",
          "steps": [
            "Find carts where:",
            "  - Guest carts with last_activity_at + 7 days \u003c now",
            "  - Authenticated carts with last_activity_at + 30 days \u003c now",
            "Delete expired carts"
          ],
          "error_cases": []
        }
      ],
      "dependencies": [
        "CartRepository"
      ],
      "related_specs": [
        "TS-BR-CART-003"
      ]
    }
  ],
  "summary": {
    "endpoints_count": 28,
    "services_count": 16,
    "functions_count": 42
  }
}