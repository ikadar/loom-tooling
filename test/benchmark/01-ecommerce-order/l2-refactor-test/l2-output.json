{
  "aggregates": [
    {
      "id": "AGG-CUSTOMER-001",
      "name": "Customer",
      "purpose": "Manages customer identity, registration status, and profile for order placement eligibility",
      "invariants": [
        {
          "id": "INV-CUST-001",
          "rule": "Customer must have a valid email address",
          "enforcement": "Email value object validates format on creation; registration rejects invalid emails"
        },
        {
          "id": "INV-CUST-002",
          "rule": "Email addresses must be unique across all customer accounts",
          "enforcement": "Registration validates email uniqueness via repository lookup before account creation"
        },
        {
          "id": "INV-CUST-003",
          "rule": "Password must meet minimum security requirements",
          "enforcement": "Password value object validates strength on creation and change operations"
        },
        {
          "id": "INV-CUST-004",
          "rule": "Customer must be registered and email verified to place orders",
          "enforcement": "Order placement checks registration status and emailVerified flag before proceeding"
        }
      ],
      "root": {
        "entity": "Customer",
        "identity": "CustomerId (UUID)",
        "attributes": [
          {
            "name": "customerId",
            "type": "CustomerId",
            "mutable": false
          },
          {
            "name": "email",
            "type": "Email",
            "mutable": true
          },
          {
            "name": "passwordHash",
            "type": "string",
            "mutable": true
          },
          {
            "name": "registrationStatus",
            "type": "RegistrationStatus",
            "mutable": true
          },
          {
            "name": "emailVerified",
            "type": "boolean",
            "mutable": true
          },
          {
            "name": "createdAt",
            "type": "DateTime",
            "mutable": false
          }
        ]
      },
      "entities": [],
      "valueObjects": [
        "CustomerId",
        "Email",
        "Password",
        "RegistrationStatus"
      ],
      "behaviors": [
        {
          "name": "register",
          "command": "RegisterCustomer",
          "preconditions": [
            "Email not already registered",
            "Password meets strength requirements"
          ],
          "postconditions": [
            "Customer created with REGISTERED status",
            "emailVerified set to false"
          ],
          "emits": "CustomerRegistered"
        },
        {
          "name": "verifyEmail",
          "command": "VerifyCustomerEmail",
          "preconditions": [
            "Valid verification token",
            "Customer exists"
          ],
          "postconditions": [
            "emailVerified set to true"
          ],
          "emits": "CustomerEmailVerified"
        },
        {
          "name": "changeEmail",
          "command": "ChangeCustomerEmail",
          "preconditions": [
            "New email not already registered",
            "New email is valid format"
          ],
          "postconditions": [
            "Email updated",
            "emailVerified reset to false"
          ],
          "emits": "CustomerEmailChanged"
        },
        {
          "name": "changePassword",
          "command": "ChangeCustomerPassword",
          "preconditions": [
            "New password meets strength requirements"
          ],
          "postconditions": [
            "Password hash updated"
          ],
          "emits": "CustomerPasswordChanged"
        }
      ],
      "events": [
        {
          "name": "CustomerRegistered",
          "payload": [
            "customerId",
            "email",
            "registeredAt"
          ]
        },
        {
          "name": "CustomerEmailVerified",
          "payload": [
            "customerId",
            "verifiedAt"
          ]
        },
        {
          "name": "CustomerEmailChanged",
          "payload": [
            "customerId",
            "oldEmail",
            "newEmail"
          ]
        },
        {
          "name": "CustomerPasswordChanged",
          "payload": [
            "customerId",
            "changedAt"
          ]
        }
      ],
      "repository": {
        "name": "CustomerRepository",
        "methods": [
          {
            "name": "findById",
            "params": "CustomerId",
            "returns": "Customer?"
          },
          {
            "name": "findByEmail",
            "params": "Email",
            "returns": "Customer?"
          },
          {
            "name": "existsByEmail",
            "params": "Email",
            "returns": "boolean"
          },
          {
            "name": "save",
            "params": "Customer",
            "returns": "void"
          }
        ],
        "loadStrategy": "Eager load all attributes; no child entities",
        "concurrency": "Optimistic locking with version field"
      },
      "externalReferences": []
    },
    {
      "id": "AGG-CART-001",
      "name": "Cart",
      "purpose": "Holds products a customer intends to purchase with current pricing before checkout",
      "invariants": [
        {
          "id": "INV-CART-001",
          "rule": "Total price equals sum of all item subtotals",
          "enforcement": "Total recalculated on every item add/update/remove operation"
        },
        {
          "id": "INV-CART-002",
          "rule": "Each product can appear only once in cart",
          "enforcement": "AddItem checks for existing item and updates quantity instead of adding duplicate"
        },
        {
          "id": "INV-CART-003",
          "rule": "Cart item quantity must be at least 1",
          "enforcement": "Quantity validation on add and update; remove item if quantity would be 0"
        },
        {
          "id": "INV-CART-004",
          "rule": "Cart item quantity cannot exceed available stock",
          "enforcement": "Add and update operations query inventory and cap quantity at available stock"
        },
        {
          "id": "INV-CART-005",
          "rule": "Cannot add inactive or out-of-stock products",
          "enforcement": "AddItem validates product is active and has available stock before adding"
        }
      ],
      "root": {
        "entity": "Cart",
        "identity": "CartId (UUID)",
        "attributes": [
          {
            "name": "cartId",
            "type": "CartId",
            "mutable": false
          },
          {
            "name": "customerId",
            "type": "CustomerId",
            "mutable": false
          },
          {
            "name": "totalPrice",
            "type": "Money",
            "mutable": true
          },
          {
            "name": "lastActivityAt",
            "type": "DateTime",
            "mutable": true
          }
        ]
      },
      "entities": [
        {
          "name": "CartItem",
          "identity": "CartItemId (UUID)",
          "purpose": "Represents a product and quantity within the shopping cart with price snapshot",
          "attributes": [
            {
              "name": "cartItemId",
              "type": "CartItemId",
              "mutable": false
            },
            {
              "name": "productId",
              "type": "ProductId",
              "mutable": false
            },
            {
              "name": "variantId",
              "type": "VariantId?",
              "mutable": false
            },
            {
              "name": "productName",
              "type": "string",
              "mutable": false
            },
            {
              "name": "unitPrice",
              "type": "Money",
              "mutable": false
            },
            {
              "name": "quantity",
              "type": "integer",
              "mutable": false
            },
            {
              "name": "subtotal",
              "type": "Money",
              "mutable": false
            }
          ]
        }
      ],
      "valueObjects": [
        "CartId",
        "CartItemId",
        "Money",
        "ProductId",
        "VariantId"
      ],
      "behaviors": [
        {
          "name": "addItem",
          "command": "AddItemToCart",
          "preconditions": [
            "Product is active",
            "Product/variant is in stock",
            "Quantity \u003e 0"
          ],
          "postconditions": [
            "CartItem added or quantity updated",
            "Total recalculated",
            "lastActivityAt updated"
          ],
          "emits": "ItemAddedToCart"
        },
        {
          "name": "updateQuantity",
          "command": "UpdateCartItemQuantity",
          "preconditions": [
            "Item exists in cart",
            "New quantity \u003e= 1",
            "Stock available for new quantity"
          ],
          "postconditions": [
            "Quantity updated",
            "Subtotal recalculated",
            "Total recalculated"
          ],
          "emits": "CartQuantityUpdated"
        },
        {
          "name": "removeItem",
          "command": "RemoveItemFromCart",
          "preconditions": [
            "Item exists in cart"
          ],
          "postconditions": [
            "Item removed from cart",
            "Total recalculated"
          ],
          "emits": "ItemRemovedFromCart"
        },
        {
          "name": "clear",
          "command": "ClearCart",
          "preconditions": [],
          "postconditions": [
            "All items removed",
            "Total set to zero"
          ],
          "emits": "CartCleared"
        },
        {
          "name": "refreshPrices",
          "command": "RefreshCartPrices",
          "preconditions": [],
          "postconditions": [
            "All item prices updated to current product prices",
            "Total recalculated"
          ],
          "emits": "CartPricesRefreshed"
        }
      ],
      "events": [
        {
          "name": "ItemAddedToCart",
          "payload": [
            "cartId",
            "productId",
            "variantId",
            "quantity",
            "unitPrice"
          ]
        },
        {
          "name": "CartQuantityUpdated",
          "payload": [
            "cartId",
            "cartItemId",
            "oldQuantity",
            "newQuantity"
          ]
        },
        {
          "name": "ItemRemovedFromCart",
          "payload": [
            "cartId",
            "productId",
            "variantId"
          ]
        },
        {
          "name": "CartCleared",
          "payload": [
            "cartId",
            "itemCount"
          ]
        },
        {
          "name": "CartPricesRefreshed",
          "payload": [
            "cartId",
            "priceChanges"
          ]
        }
      ],
      "repository": {
        "name": "CartRepository",
        "methods": [
          {
            "name": "findById",
            "params": "CartId",
            "returns": "Cart?"
          },
          {
            "name": "findByCustomerId",
            "params": "CustomerId",
            "returns": "Cart?"
          },
          {
            "name": "save",
            "params": "Cart",
            "returns": "void"
          },
          {
            "name": "deleteExpired",
            "params": "DateTime cutoff",
            "returns": "integer"
          }
        ],
        "loadStrategy": "Eager load cart with all cart items",
        "concurrency": "Optimistic locking with version field"
      },
      "externalReferences": [
        {
          "aggregate": "Customer",
          "via": "customerId",
          "type": "reference"
        },
        {
          "aggregate": "Product",
          "via": "productId in CartItem",
          "type": "snapshot"
        },
        {
          "aggregate": "Inventory",
          "via": "productId",
          "type": "reference"
        }
      ]
    },
    {
      "id": "AGG-ORDER-001",
      "name": "Order",
      "purpose": "Represents an immutable purchase transaction with line items, shipping, and payment details",
      "invariants": [
        {
          "id": "INV-ORD-001",
          "rule": "Order must have at least one line item",
          "enforcement": "Order creation validates lineItems is not empty; no operation allows removal of last item"
        },
        {
          "id": "INV-ORD-002",
          "rule": "Total amount equals subtotal plus shipping cost",
          "enforcement": "Calculated on creation; all values are immutable after creation"
        },
        {
          "id": "INV-ORD-003",
          "rule": "Shipping is free when subtotal exceeds $50",
          "enforcement": "Shipping cost calculation during order creation applies rule automatically"
        },
        {
          "id": "INV-ORD-004",
          "rule": "Orders cannot be modified after placement",
          "enforcement": "No edit operations exposed; only status transitions allowed"
        },
        {
          "id": "INV-ORD-005",
          "rule": "Status transitions must follow valid state machine",
          "enforcement": "Status update validates transition is allowed from current state"
        },
        {
          "id": "INV-ORD-006",
          "rule": "Can only cancel order before shipped status",
          "enforcement": "Cancel operation validates current status is PENDING or CONFIRMED"
        },
        {
          "id": "INV-ORD-007",
          "rule": "Line item subtotal equals unitPrice times quantity",
          "enforcement": "Calculated on line item creation; immutable thereafter"
        },
        {
          "id": "INV-ORD-008",
          "rule": "Prices captured at time of order placement",
          "enforcement": "Order creation copies current prices from cart to order line items"
        }
      ],
      "root": {
        "entity": "Order",
        "identity": "OrderId (UUID)",
        "attributes": [
          {
            "name": "orderId",
            "type": "OrderId",
            "mutable": false
          },
          {
            "name": "customerId",
            "type": "CustomerId",
            "mutable": false
          },
          {
            "name": "status",
            "type": "OrderStatus",
            "mutable": true
          },
          {
            "name": "shippingAddress",
            "type": "ShippingAddress",
            "mutable": false
          },
          {
            "name": "paymentMethod",
            "type": "PaymentMethod",
            "mutable": false
          },
          {
            "name": "subtotal",
            "type": "Money",
            "mutable": false
          },
          {
            "name": "shippingCost",
            "type": "Money",
            "mutable": false
          },
          {
            "name": "totalAmount",
            "type": "Money",
            "mutable": false
          },
          {
            "name": "createdAt",
            "type": "DateTime",
            "mutable": false
          },
          {
            "name": "trackingNumber",
            "type": "string?",
            "mutable": true
          }
        ]
      },
      "entities": [
        {
          "name": "OrderLineItem",
          "identity": "LineItemId (UUID)",
          "purpose": "Immutable snapshot of a product at time of order with quantity and pricing",
          "attributes": [
            {
              "name": "lineItemId",
              "type": "LineItemId",
              "mutable": false
            },
            {
              "name": "productId",
              "type": "ProductId",
              "mutable": false
            },
            {
              "name": "variantId",
              "type": "VariantId?",
              "mutable": false
            },
            {
              "name": "productName",
              "type": "string",
              "mutable": false
            },
            {
              "name": "sku",
              "type": "string?",
              "mutable": false
            },
            {
              "name": "unitPrice",
              "type": "Money",
              "mutable": false
            },
            {
              "name": "quantity",
              "type": "integer",
              "mutable": false
            },
            {
              "name": "subtotal",
              "type": "Money",
              "mutable": false
            }
          ]
        }
      ],
      "valueObjects": [
        "OrderId",
        "LineItemId",
        "OrderStatus",
        "Money",
        "ShippingAddress",
        "PaymentMethod",
        "ProductId",
        "VariantId"
      ],
      "behaviors": [
        {
          "name": "create",
          "command": "PlaceOrder",
          "preconditions": [
            "Customer is registered",
            "Customer email is verified",
            "Cart has items",
            "All items in stock",
            "Payment authorized"
          ],
          "postconditions": [
            "Order created with PENDING status",
            "Line items captured with price snapshots",
            "Inventory reserved"
          ],
          "emits": "OrderPlaced"
        },
        {
          "name": "confirm",
          "command": "ConfirmOrder",
          "preconditions": [
            "Status is PENDING"
          ],
          "postconditions": [
            "Status changed to CONFIRMED"
          ],
          "emits": "OrderConfirmed"
        },
        {
          "name": "ship",
          "command": "ShipOrder",
          "preconditions": [
            "Status is CONFIRMED",
            "Tracking number provided"
          ],
          "postconditions": [
            "Status changed to SHIPPED",
            "Tracking number recorded",
            "Inventory deducted"
          ],
          "emits": "OrderShipped"
        },
        {
          "name": "deliver",
          "command": "DeliverOrder",
          "preconditions": [
            "Status is SHIPPED"
          ],
          "postconditions": [
            "Status changed to DELIVERED"
          ],
          "emits": "OrderDelivered"
        },
        {
          "name": "cancel",
          "command": "CancelOrder",
          "preconditions": [
            "Status is PENDING or CONFIRMED"
          ],
          "postconditions": [
            "Status changed to CANCELLED",
            "Inventory released",
            "Refund initiated"
          ],
          "emits": "OrderCancelled"
        }
      ],
      "events": [
        {
          "name": "OrderPlaced",
          "payload": [
            "orderId",
            "customerId",
            "lineItems",
            "totalAmount",
            "createdAt"
          ]
        },
        {
          "name": "OrderConfirmed",
          "payload": [
            "orderId",
            "confirmedAt"
          ]
        },
        {
          "name": "OrderShipped",
          "payload": [
            "orderId",
            "trackingNumber",
            "shippedAt"
          ]
        },
        {
          "name": "OrderDelivered",
          "payload": [
            "orderId",
            "deliveredAt"
          ]
        },
        {
          "name": "OrderCancelled",
          "payload": [
            "orderId",
            "reason",
            "cancelledAt"
          ]
        }
      ],
      "repository": {
        "name": "OrderRepository",
        "methods": [
          {
            "name": "findById",
            "params": "OrderId",
            "returns": "Order?"
          },
          {
            "name": "findByCustomerId",
            "params": "CustomerId",
            "returns": "List\u003cOrder\u003e"
          },
          {
            "name": "findByStatus",
            "params": "OrderStatus",
            "returns": "List\u003cOrder\u003e"
          },
          {
            "name": "save",
            "params": "Order",
            "returns": "void"
          },
          {
            "name": "nextId",
            "params": "void",
            "returns": "OrderId"
          }
        ],
        "loadStrategy": "Eager load order with all line items",
        "concurrency": "Optimistic locking with version field for status transitions"
      },
      "externalReferences": [
        {
          "aggregate": "Customer",
          "via": "customerId",
          "type": "reference"
        },
        {
          "aggregate": "Product",
          "via": "productId in LineItem",
          "type": "snapshot"
        },
        {
          "aggregate": "Inventory",
          "via": "productId",
          "type": "reference"
        }
      ]
    },
    {
      "id": "AGG-PRODUCT-001",
      "name": "Product",
      "purpose": "Represents an item available for sale with variants, pricing, and categorization",
      "invariants": [
        {
          "id": "INV-PROD-001",
          "rule": "Price must be at least $0.01",
          "enforcement": "Money value object validates minimum amount on creation and update"
        },
        {
          "id": "INV-PROD-002",
          "rule": "Product must belong to a category",
          "enforcement": "Product creation requires valid categoryId; category existence checked"
        },
        {
          "id": "INV-PROD-003",
          "rule": "Product name must be 2-200 characters",
          "enforcement": "Name validation on creation and update operations"
        },
        {
          "id": "INV-PROD-004",
          "rule": "Product description must not exceed 5000 characters",
          "enforcement": "Description validation on creation and update operations"
        },
        {
          "id": "INV-PROD-005",
          "rule": "Variant SKU must be unique across all variants",
          "enforcement": "Variant creation validates SKU uniqueness via repository"
        },
        {
          "id": "INV-PROD-006",
          "rule": "Products with order history must be soft-deleted",
          "enforcement": "Delete operation checks for order history and performs soft delete if found"
        },
        {
          "id": "INV-PROD-007",
          "rule": "Products can have up to 10 images with one primary",
          "enforcement": "Image upload validates count limit; primary image selection enforced"
        }
      ],
      "root": {
        "entity": "Product",
        "identity": "ProductId (UUID)",
        "attributes": [
          {
            "name": "productId",
            "type": "ProductId",
            "mutable": false
          },
          {
            "name": "name",
            "type": "string",
            "mutable": true
          },
          {
            "name": "description",
            "type": "string?",
            "mutable": true
          },
          {
            "name": "price",
            "type": "Money",
            "mutable": true
          },
          {
            "name": "categoryId",
            "type": "CategoryId",
            "mutable": true
          },
          {
            "name": "isActive",
            "type": "boolean",
            "mutable": true
          },
          {
            "name": "deletedAt",
            "type": "DateTime?",
            "mutable": true
          },
          {
            "name": "createdAt",
            "type": "DateTime",
            "mutable": false
          }
        ]
      },
      "entities": [
        {
          "name": "ProductVariant",
          "identity": "VariantId (UUID)",
          "purpose": "Represents a specific variation of a product (size, color combination)",
          "attributes": [
            {
              "name": "variantId",
              "type": "VariantId",
              "mutable": false
            },
            {
              "name": "sku",
              "type": "string",
              "mutable": false
            },
            {
              "name": "size",
              "type": "string?",
              "mutable": false
            },
            {
              "name": "color",
              "type": "string?",
              "mutable": false
            },
            {
              "name": "priceAdjustment",
              "type": "Money?",
              "mutable": false
            }
          ]
        },
        {
          "name": "ProductImage",
          "identity": "ImageId (UUID)",
          "purpose": "Product image with primary flag",
          "attributes": [
            {
              "name": "imageId",
              "type": "ImageId",
              "mutable": false
            },
            {
              "name": "url",
              "type": "string",
              "mutable": false
            },
            {
              "name": "altText",
              "type": "string?",
              "mutable": false
            },
            {
              "name": "isPrimary",
              "type": "boolean",
              "mutable": false
            },
            {
              "name": "sortOrder",
              "type": "integer",
              "mutable": false
            }
          ]
        }
      ],
      "valueObjects": [
        "ProductId",
        "VariantId",
        "ImageId",
        "CategoryId",
        "Money",
        "Sku"
      ],
      "behaviors": [
        {
          "name": "create",
          "command": "CreateProduct",
          "preconditions": [
            "Price \u003e 0",
            "Category exists",
            "Name length valid"
          ],
          "postconditions": [
            "Product created as active"
          ],
          "emits": "ProductCreated"
        },
        {
          "name": "update",
          "command": "UpdateProduct",
          "preconditions": [
            "If price provided, price \u003e 0",
            "If name provided, length valid"
          ],
          "postconditions": [
            "Product attributes updated",
            "Price change logged if applicable"
          ],
          "emits": "ProductUpdated"
        },
        {
          "name": "deactivate",
          "command": "DeactivateProduct",
          "preconditions": [
            "Product is active"
          ],
          "postconditions": [
            "isActive set to false"
          ],
          "emits": "ProductDeactivated"
        },
        {
          "name": "activate",
          "command": "ActivateProduct",
          "preconditions": [
            "Product is inactive",
            "Product not deleted"
          ],
          "postconditions": [
            "isActive set to true"
          ],
          "emits": "ProductActivated"
        },
        {
          "name": "delete",
          "command": "DeleteProduct",
          "preconditions": [],
          "postconditions": [
            "If has orders: deletedAt set (soft delete); else: permanently removed"
          ],
          "emits": "ProductDeleted"
        },
        {
          "name": "addVariant",
          "command": "AddProductVariant",
          "preconditions": [
            "SKU is unique",
            "At least size or color specified"
          ],
          "postconditions": [
            "Variant added to product"
          ],
          "emits": "ProductVariantAdded"
        },
        {
          "name": "removeVariant",
          "command": "RemoveProductVariant",
          "preconditions": [
            "Variant exists",
            "No pending orders with this variant"
          ],
          "postconditions": [
            "Variant removed"
          ],
          "emits": "ProductVariantRemoved"
        },
        {
          "name": "addImage",
          "command": "AddProductImage",
          "preconditions": [
            "Image count \u003c 10"
          ],
          "postconditions": [
            "Image added",
            "If first image, set as primary"
          ],
          "emits": "ProductImageAdded"
        },
        {
          "name": "setPrimaryImage",
          "command": "SetPrimaryProductImage",
          "preconditions": [
            "Image exists on product"
          ],
          "postconditions": [
            "Specified image set as primary",
            "Previous primary cleared"
          ],
          "emits": "ProductPrimaryImageChanged"
        }
      ],
      "events": [
        {
          "name": "ProductCreated",
          "payload": [
            "productId",
            "name",
            "price",
            "categoryId"
          ]
        },
        {
          "name": "ProductUpdated",
          "payload": [
            "productId",
            "changedFields"
          ]
        },
        {
          "name": "ProductDeactivated",
          "payload": [
            "productId",
            "deactivatedAt"
          ]
        },
        {
          "name": "ProductActivated",
          "payload": [
            "productId",
            "activatedAt"
          ]
        },
        {
          "name": "ProductDeleted",
          "payload": [
            "productId",
            "deletedAt",
            "isSoftDelete"
          ]
        },
        {
          "name": "ProductVariantAdded",
          "payload": [
            "productId",
            "variantId",
            "sku"
          ]
        },
        {
          "name": "ProductVariantRemoved",
          "payload": [
            "productId",
            "variantId"
          ]
        },
        {
          "name": "ProductImageAdded",
          "payload": [
            "productId",
            "imageId",
            "url"
          ]
        },
        {
          "name": "ProductPrimaryImageChanged",
          "payload": [
            "productId",
            "imageId"
          ]
        }
      ],
      "repository": {
        "name": "ProductRepository",
        "methods": [
          {
            "name": "findById",
            "params": "ProductId",
            "returns": "Product?"
          },
          {
            "name": "findByCategory",
            "params": "CategoryId",
            "returns": "List\u003cProduct\u003e"
          },
          {
            "name": "findActive",
            "params": "void",
            "returns": "List\u003cProduct\u003e"
          },
          {
            "name": "existsBySku",
            "params": "string sku",
            "returns": "boolean"
          },
          {
            "name": "hasOrders",
            "params": "ProductId",
            "returns": "boolean"
          },
          {
            "name": "save",
            "params": "Product",
            "returns": "void"
          },
          {
            "name": "delete",
            "params": "ProductId",
            "returns": "void"
          }
        ],
        "loadStrategy": "Eager load product with variants and images",
        "concurrency": "Optimistic locking with version field"
      },
      "externalReferences": [
        {
          "aggregate": "Category",
          "via": "categoryId",
          "type": "reference"
        }
      ]
    },
    {
      "id": "AGG-CATEGORY-001",
      "name": "Category",
      "purpose": "Organizes products into browsable hierarchical groupings",
      "invariants": [
        {
          "id": "INV-CAT-001",
          "rule": "Category name must be unique",
          "enforcement": "Category creation validates name uniqueness via repository"
        },
        {
          "id": "INV-CAT-002",
          "rule": "Category cannot be its own parent",
          "enforcement": "Parent assignment validates parentCategoryId != categoryId"
        },
        {
          "id": "INV-CAT-003",
          "rule": "Category hierarchy limited to 3 levels deep",
          "enforcement": "Category creation validates parent hierarchy depth before assignment"
        }
      ],
      "root": {
        "entity": "Category",
        "identity": "CategoryId (UUID)",
        "attributes": [
          {
            "name": "categoryId",
            "type": "CategoryId",
            "mutable": false
          },
          {
            "name": "name",
            "type": "string",
            "mutable": true
          },
          {
            "name": "description",
            "type": "string?",
            "mutable": true
          },
          {
            "name": "parentCategoryId",
            "type": "CategoryId?",
            "mutable": true
          },
          {
            "name": "depth",
            "type": "integer",
            "mutable": true
          }
        ]
      },
      "entities": [],
      "valueObjects": [
        "CategoryId"
      ],
      "behaviors": [
        {
          "name": "create",
          "command": "CreateCategory",
          "preconditions": [
            "Name is unique",
            "If parent specified, parent exists and depth \u003c 3"
          ],
          "postconditions": [
            "Category created with calculated depth"
          ],
          "emits": "CategoryCreated"
        },
        {
          "name": "rename",
          "command": "RenameCategory",
          "preconditions": [
            "New name is unique"
          ],
          "postconditions": [
            "Category name updated"
          ],
          "emits": "CategoryRenamed"
        },
        {
          "name": "moveToParent",
          "command": "MoveCategoryToParent",
          "preconditions": [
            "New parent exists",
            "Would not exceed depth limit",
            "Not creating cycle"
          ],
          "postconditions": [
            "Parent updated",
            "Depth recalculated for self and descendants"
          ],
          "emits": "CategoryMoved"
        },
        {
          "name": "delete",
          "command": "DeleteCategory",
          "preconditions": [
            "No products in category",
            "No child categories"
          ],
          "postconditions": [
            "Category removed"
          ],
          "emits": "CategoryDeleted"
        }
      ],
      "events": [
        {
          "name": "CategoryCreated",
          "payload": [
            "categoryId",
            "name",
            "parentCategoryId",
            "depth"
          ]
        },
        {
          "name": "CategoryRenamed",
          "payload": [
            "categoryId",
            "oldName",
            "newName"
          ]
        },
        {
          "name": "CategoryMoved",
          "payload": [
            "categoryId",
            "oldParentId",
            "newParentId",
            "newDepth"
          ]
        },
        {
          "name": "CategoryDeleted",
          "payload": [
            "categoryId"
          ]
        }
      ],
      "repository": {
        "name": "CategoryRepository",
        "methods": [
          {
            "name": "findById",
            "params": "CategoryId",
            "returns": "Category?"
          },
          {
            "name": "findByName",
            "params": "string",
            "returns": "Category?"
          },
          {
            "name": "findRoots",
            "params": "void",
            "returns": "List\u003cCategory\u003e"
          },
          {
            "name": "findChildren",
            "params": "CategoryId",
            "returns": "List\u003cCategory\u003e"
          },
          {
            "name": "existsByName",
            "params": "string",
            "returns": "boolean"
          },
          {
            "name": "hasProducts",
            "params": "CategoryId",
            "returns": "boolean"
          },
          {
            "name": "hasChildren",
            "params": "CategoryId",
            "returns": "boolean"
          },
          {
            "name": "getDepth",
            "params": "CategoryId",
            "returns": "integer"
          },
          {
            "name": "save",
            "params": "Category",
            "returns": "void"
          },
          {
            "name": "delete",
            "params": "CategoryId",
            "returns": "void"
          }
        ],
        "loadStrategy": "Lazy load children on demand",
        "concurrency": "Optimistic locking with version field"
      },
      "externalReferences": [
        {
          "aggregate": "Category",
          "via": "parentCategoryId",
          "type": "reference"
        }
      ]
    },
    {
      "id": "AGG-INVENTORY-001",
      "name": "Inventory",
      "purpose": "Tracks stock levels for products and manages availability with reservations",
      "invariants": [
        {
          "id": "INV-INV-001",
          "rule": "Available quantity cannot be negative",
          "enforcement": "All operations validate resulting availableQuantity \u003e= 0 before committing"
        },
        {
          "id": "INV-INV-002",
          "rule": "Reserved quantity cannot exceed quantity on hand",
          "enforcement": "Reserve operation validates reservedQuantity + requested \u003c= quantityOnHand"
        },
        {
          "id": "INV-INV-003",
          "rule": "No backorders allowed",
          "enforcement": "Reserve operation rejects if requested \u003e availableQuantity"
        },
        {
          "id": "INV-INV-004",
          "rule": "Each product has exactly one inventory record",
          "enforcement": "Inventory creation validates no existing record for productId"
        }
      ],
      "root": {
        "entity": "Inventory",
        "identity": "InventoryId (UUID), also keyed by ProductId",
        "attributes": [
          {
            "name": "inventoryId",
            "type": "InventoryId",
            "mutable": false
          },
          {
            "name": "productId",
            "type": "ProductId",
            "mutable": false
          },
          {
            "name": "quantityOnHand",
            "type": "integer",
            "mutable": true
          },
          {
            "name": "reservedQuantity",
            "type": "integer",
            "mutable": true
          },
          {
            "name": "availableQuantity",
            "type": "integer",
            "mutable": true
          }
        ]
      },
      "entities": [],
      "valueObjects": [
        "InventoryId",
        "ProductId",
        "Quantity"
      ],
      "behaviors": [
        {
          "name": "reserve",
          "command": "ReserveInventory",
          "preconditions": [
            "Available quantity \u003e= requested quantity"
          ],
          "postconditions": [
            "Reserved quantity increased",
            "Available quantity decreased"
          ],
          "emits": "InventoryReserved"
        },
        {
          "name": "release",
          "command": "ReleaseInventory",
          "preconditions": [
            "Reserved quantity \u003e= requested quantity"
          ],
          "postconditions": [
            "Reserved quantity decreased",
            "Available quantity increased"
          ],
          "emits": "InventoryReleased"
        },
        {
          "name": "deduct",
          "command": "DeductInventory",
          "preconditions": [
            "Reserved quantity \u003e= requested quantity"
          ],
          "postconditions": [
            "Quantity on hand decreased",
            "Reserved quantity decreased"
          ],
          "emits": "InventoryDeducted"
        },
        {
          "name": "restock",
          "command": "RestockInventory",
          "preconditions": [
            "Quantity \u003e 0"
          ],
          "postconditions": [
            "Quantity on hand increased",
            "Available quantity increased"
          ],
          "emits": "InventoryRestocked"
        },
        {
          "name": "adjust",
          "command": "AdjustInventory",
          "preconditions": [
            "Resulting quantities would be valid"
          ],
          "postconditions": [
            "Quantities adjusted",
            "Audit log entry created"
          ],
          "emits": "InventoryAdjusted"
        }
      ],
      "events": [
        {
          "name": "InventoryReserved",
          "payload": [
            "inventoryId",
            "productId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryReleased",
          "payload": [
            "inventoryId",
            "productId",
            "quantity",
            "reason"
          ]
        },
        {
          "name": "InventoryDeducted",
          "payload": [
            "inventoryId",
            "productId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryRestocked",
          "payload": [
            "inventoryId",
            "productId",
            "quantity",
            "previousQuantity"
          ]
        },
        {
          "name": "InventoryAdjusted",
          "payload": [
            "inventoryId",
            "productId",
            "oldQuantity",
            "newQuantity",
            "reason",
            "operator"
          ]
        },
        {
          "name": "OutOfStock",
          "payload": [
            "inventoryId",
            "productId"
          ]
        }
      ],
      "repository": {
        "name": "InventoryRepository",
        "methods": [
          {
            "name": "findById",
            "params": "InventoryId",
            "returns": "Inventory?"
          },
          {
            "name": "findByProductId",
            "params": "ProductId",
            "returns": "Inventory?"
          },
          {
            "name": "findLowStock",
            "params": "integer threshold",
            "returns": "List\u003cInventory\u003e"
          },
          {
            "name": "findOutOfStock",
            "params": "void",
            "returns": "List\u003cInventory\u003e"
          },
          {
            "name": "save",
            "params": "Inventory",
            "returns": "void"
          },
          {
            "name": "saveWithLock",
            "params": "Inventory",
            "returns": "void"
          }
        ],
        "loadStrategy": "Eager load single record",
        "concurrency": "Pessimistic locking for reserve/deduct operations to prevent overselling"
      },
      "externalReferences": [
        {
          "aggregate": "Product",
          "via": "productId",
          "type": "reference"
        }
      ]
    }
  ],
  "enums": [
    {
      "name": "registration_status_enum",
      "values": [
        "REGISTERED",
        "UNREGISTERED"
      ]
    },
    {
      "name": "order_status_enum",
      "values": [
        "PENDING",
        "CONFIRMED",
        "SHIPPED",
        "DELIVERED",
        "CANCELLED"
      ]
    },
    {
      "name": "payment_type_enum",
      "values": [
        "CREDIT_CARD",
        "PAYPAL"
      ]
    }
  ],
  "interface_contracts": [
    {
      "id": "IC-CUST-001",
      "serviceName": "Customer Service",
      "purpose": "Manages customer registration, authentication, addresses, and payment methods",
      "baseUrl": "/api/v1/customers",
      "operations": [
        {
          "id": "OP-CUST-001",
          "name": "registerCustomer",
          "method": "POST",
          "path": "/",
          "description": "Register a new customer account with email and password",
          "inputSchema": {
            "email": {
              "type": "Email",
              "required": true
            },
            "firstName": {
              "type": "string",
              "required": true
            },
            "lastName": {
              "type": "string",
              "required": true
            },
            "password": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "createdAt": {
              "type": "DateTime"
            },
            "customerId": {
              "type": "CustomerId"
            },
            "email": {
              "type": "Email"
            },
            "registrationStatus": {
              "type": "RegistrationStatus"
            }
          },
          "errors": [
            {
              "code": "EMAIL_ALREADY_REGISTERED",
              "httpStatus": 409,
              "message": "Email address is already registered"
            },
            {
              "code": "WEAK_PASSWORD",
              "httpStatus": 400,
              "message": "Password must be at least 8 characters and contain at least one number"
            },
            {
              "code": "INVALID_EMAIL",
              "httpStatus": 400,
              "message": "Email format is invalid"
            },
            {
              "code": "MISSING_REQUIRED_FIELDS",
              "httpStatus": 400,
              "message": "First name, last name, email, and password are required"
            }
          ],
          "preconditions": [
            "Email not already registered"
          ],
          "postconditions": [
            "Customer account created with REGISTERED status",
            "Verification email sent",
            "CustomerRegistered event emitted"
          ],
          "relatedACs": [
            "AC-CUST-001"
          ],
          "relatedBRs": [
            "BR-CUST-001",
            "BR-CUST-002",
            "BR-CUST-003"
          ]
        },
        {
          "id": "OP-CUST-002",
          "name": "verifyEmail",
          "method": "POST",
          "path": "/{customerId}/verify-email",
          "description": "Verify customer email address using verification token",
          "inputSchema": {
            "customerId": {
              "type": "CustomerId",
              "required": true
            },
            "verificationToken": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "customerId": {
              "type": "CustomerId"
            },
            "emailVerified": {
              "type": "boolean"
            }
          },
          "errors": [
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            },
            {
              "code": "INVALID_VERIFICATION_TOKEN",
              "httpStatus": 400,
              "message": "Verification token is invalid or expired"
            },
            {
              "code": "EMAIL_ALREADY_VERIFIED",
              "httpStatus": 409,
              "message": "Email is already verified"
            }
          ],
          "preconditions": [
            "Customer exists",
            "Token is valid and not expired"
          ],
          "postconditions": [
            "Customer emailVerified set to true",
            "EmailVerified event emitted"
          ],
          "relatedACs": [
            "AC-CUST-001"
          ],
          "relatedBRs": [
            "BR-CUST-003"
          ]
        },
        {
          "id": "OP-CUST-003",
          "name": "getCustomer",
          "method": "GET",
          "path": "/{customerId}",
          "description": "Retrieve customer profile information",
          "inputSchema": {
            "customerId": {
              "type": "CustomerId",
              "required": true
            }
          },
          "outputSchema": {
            "createdAt": {
              "type": "DateTime"
            },
            "customerId": {
              "type": "CustomerId"
            },
            "email": {
              "type": "Email"
            },
            "emailVerified": {
              "type": "boolean"
            },
            "firstName": {
              "type": "string"
            },
            "lastName": {
              "type": "string"
            },
            "registrationStatus": {
              "type": "RegistrationStatus"
            }
          },
          "errors": [
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            }
          ],
          "preconditions": [
            "Customer exists"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-CUST-001"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CUST-004",
          "name": "addShippingAddress",
          "method": "POST",
          "path": "/{customerId}/addresses",
          "description": "Add a new shipping address to customer profile",
          "inputSchema": {
            "city": {
              "type": "string",
              "required": true
            },
            "country": {
              "type": "string",
              "required": true
            },
            "customerId": {
              "type": "CustomerId",
              "required": true
            },
            "isDefault": {
              "type": "boolean"
            },
            "postalCode": {
              "type": "string",
              "required": true
            },
            "recipientName": {
              "type": "string",
              "required": true
            },
            "state": {
              "type": "string",
              "required": true
            },
            "street": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "addressId": {
              "type": "AddressId"
            },
            "city": {
              "type": "string"
            },
            "country": {
              "type": "string"
            },
            "isDefault": {
              "type": "boolean"
            },
            "postalCode": {
              "type": "string"
            },
            "recipientName": {
              "type": "string"
            },
            "state": {
              "type": "string"
            },
            "street": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            },
            {
              "code": "INCOMPLETE_ADDRESS",
              "httpStatus": 400,
              "message": "All address fields are required"
            },
            {
              "code": "INVALID_POSTAL_CODE",
              "httpStatus": 400,
              "message": "Invalid postal code format"
            },
            {
              "code": "INTERNATIONAL_SHIPPING_NOT_AVAILABLE",
              "httpStatus": 400,
              "message": "Shipping is only available within domestic country"
            }
          ],
          "preconditions": [
            "Customer exists"
          ],
          "postconditions": [
            "Address saved to customer profile",
            "If isDefault=true, previous default unset"
          ],
          "relatedACs": [
            "AC-CUST-002"
          ],
          "relatedBRs": [
            "BR-ADDR-001",
            "BR-SHIP-002"
          ]
        },
        {
          "id": "OP-CUST-005",
          "name": "getShippingAddresses",
          "method": "GET",
          "path": "/{customerId}/addresses",
          "description": "List all shipping addresses for a customer",
          "inputSchema": {
            "customerId": {
              "type": "CustomerId",
              "required": true
            }
          },
          "outputSchema": {
            "addresses": {
              "type": "Array\u003cShippingAddress\u003e"
            }
          },
          "errors": [
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            }
          ],
          "preconditions": [
            "Customer exists"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-CUST-002"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CUST-006",
          "name": "addPaymentMethod",
          "method": "POST",
          "path": "/{customerId}/payment-methods",
          "description": "Add a tokenized payment method to customer profile",
          "inputSchema": {
            "customerId": {
              "type": "CustomerId",
              "required": true
            },
            "isDefault": {
              "type": "boolean"
            },
            "paymentToken": {
              "type": "string",
              "required": true
            },
            "type": {
              "type": "PaymentType",
              "required": true
            }
          },
          "outputSchema": {
            "isDefault": {
              "type": "boolean"
            },
            "lastFourDigits": {
              "type": "string"
            },
            "paymentMethodId": {
              "type": "PaymentMethodId"
            },
            "type": {
              "type": "PaymentType"
            }
          },
          "errors": [
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            },
            {
              "code": "INVALID_PAYMENT_TOKEN",
              "httpStatus": 400,
              "message": "Payment token is invalid"
            },
            {
              "code": "UNSUPPORTED_CARD_TYPE",
              "httpStatus": 400,
              "message": "Card type not supported. Supported: Visa, Mastercard, American Express"
            }
          ],
          "preconditions": [
            "Customer exists",
            "Payment token valid from gateway"
          ],
          "postconditions": [
            "Tokenized payment method saved",
            "If isDefault=true, previous default unset"
          ],
          "relatedACs": [
            "AC-CUST-003"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CUST-007",
          "name": "getPaymentMethods",
          "method": "GET",
          "path": "/{customerId}/payment-methods",
          "description": "List all saved payment methods for a customer",
          "inputSchema": {
            "customerId": {
              "type": "CustomerId",
              "required": true
            }
          },
          "outputSchema": {
            "paymentMethods": {
              "type": "Array\u003cPaymentMethod\u003e"
            }
          },
          "errors": [
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            }
          ],
          "preconditions": [
            "Customer exists"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-CUST-003"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CUST-008",
          "name": "deleteCustomer",
          "method": "DELETE",
          "path": "/{customerId}",
          "description": "Delete or deactivate customer account (GDPR compliance)",
          "inputSchema": {
            "customerId": {
              "type": "CustomerId",
              "required": true
            },
            "deleteType": {
              "type": "DeleteType",
              "required": true
            }
          },
          "outputSchema": {
            "deleteType": {
              "type": "DeleteType"
            },
            "success": {
              "type": "boolean"
            }
          },
          "errors": [
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            },
            {
              "code": "PENDING_ORDERS_EXIST",
              "httpStatus": 409,
              "message": "Cannot delete customer with pending orders"
            }
          ],
          "preconditions": [
            "Customer exists",
            "No pending orders"
          ],
          "postconditions": [
            "Customer soft-deleted or data erased based on deleteType",
            "CustomerDeleted event emitted"
          ],
          "relatedACs": [
            "AC-CUST-004"
          ],
          "relatedBRs": []
        }
      ],
      "events": [
        {
          "name": "CustomerRegistered",
          "description": "Emitted when a new customer account is created",
          "payload": [
            "customerId",
            "email",
            "createdAt"
          ]
        },
        {
          "name": "EmailVerified",
          "description": "Emitted when customer verifies their email address",
          "payload": [
            "customerId",
            "verifiedAt"
          ]
        },
        {
          "name": "CustomerDeleted",
          "description": "Emitted when customer account is deleted or deactivated",
          "payload": [
            "customerId",
            "deleteType",
            "deletedAt"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT",
        "authorization": "Customer can only access own profile; Admin can access all"
      }
    },
    {
      "id": "IC-PROD-001",
      "serviceName": "Product Service",
      "purpose": "Manages product catalog including creation, editing, variants, and images",
      "baseUrl": "/api/v1/products",
      "operations": [
        {
          "id": "OP-PROD-001",
          "name": "listProducts",
          "method": "GET",
          "path": "/",
          "description": "Browse products with filtering, sorting, and pagination",
          "inputSchema": {
            "categoryId": {
              "type": "CategoryId"
            },
            "inStock": {
              "type": "boolean"
            },
            "maxPrice": {
              "type": "Money"
            },
            "minPrice": {
              "type": "Money"
            },
            "page": {
              "type": "integer"
            },
            "pageSize": {
              "type": "integer"
            },
            "sortBy": {
              "type": "SortOption"
            }
          },
          "outputSchema": {
            "page": {
              "type": "integer"
            },
            "pageSize": {
              "type": "integer"
            },
            "products": {
              "type": "Array\u003cProductSummary\u003e"
            },
            "totalCount": {
              "type": "integer"
            },
            "totalPages": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "INVALID_PRICE_RANGE",
              "httpStatus": 400,
              "message": "Minimum price cannot exceed maximum price"
            },
            {
              "code": "INVALID_PAGE",
              "httpStatus": 400,
              "message": "Page number must be positive"
            }
          ],
          "preconditions": [],
          "postconditions": [
            "Returns products matching filters with pagination"
          ],
          "relatedACs": [
            "AC-PROD-001",
            "AC-PROD-002"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-PROD-002",
          "name": "getProduct",
          "method": "GET",
          "path": "/{productId}",
          "description": "Get detailed product information including variants and stock status",
          "inputSchema": {
            "productId": {
              "type": "ProductId",
              "required": true
            }
          },
          "outputSchema": {
            "categoryId": {
              "type": "CategoryId"
            },
            "description": {
              "type": "string"
            },
            "images": {
              "type": "Array\u003cProductImage\u003e"
            },
            "isActive": {
              "type": "boolean"
            },
            "name": {
              "type": "string"
            },
            "price": {
              "type": "Money"
            },
            "productId": {
              "type": "ProductId"
            },
            "stockStatus": {
              "type": "StockStatus"
            },
            "variants": {
              "type": "Array\u003cProductVariant\u003e"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            }
          ],
          "preconditions": [
            "Product exists and is active (for customers)"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-PROD-001",
            "AC-PROD-002",
            "AC-VAR-001"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-PROD-003",
          "name": "createProduct",
          "method": "POST",
          "path": "/",
          "description": "Create a new product in draft status",
          "inputSchema": {
            "categoryId": {
              "type": "CategoryId",
              "required": true
            },
            "description": {
              "type": "string"
            },
            "name": {
              "type": "string",
              "required": true
            },
            "price": {
              "type": "Money",
              "required": true
            }
          },
          "outputSchema": {
            "categoryId": {
              "type": "CategoryId"
            },
            "createdAt": {
              "type": "DateTime"
            },
            "createdBy": {
              "type": "UserId"
            },
            "description": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "price": {
              "type": "Money"
            },
            "productId": {
              "type": "ProductId"
            },
            "status": {
              "type": "ProductStatus"
            }
          },
          "errors": [
            {
              "code": "INVALID_PRODUCT_NAME",
              "httpStatus": 400,
              "message": "Product name must be between 2 and 200 characters"
            },
            {
              "code": "DESCRIPTION_TOO_LONG",
              "httpStatus": 400,
              "message": "Description cannot exceed 5000 characters"
            },
            {
              "code": "INVALID_PRICE",
              "httpStatus": 400,
              "message": "Price must be at least $0.01"
            },
            {
              "code": "CATEGORY_NOT_FOUND",
              "httpStatus": 404,
              "message": "Category not found"
            }
          ],
          "preconditions": [
            "User has admin role",
            "Category exists"
          ],
          "postconditions": [
            "Product created in draft status",
            "ProductCreated event emitted"
          ],
          "relatedACs": [
            "AC-ADMIN-001"
          ],
          "relatedBRs": [
            "BR-PRICE-001",
            "BR-PROD-002",
            "BR-PROD-003"
          ]
        },
        {
          "id": "OP-PROD-004",
          "name": "updateProduct",
          "method": "PUT",
          "path": "/{productId}",
          "description": "Update product attributes with audit logging",
          "inputSchema": {
            "categoryId": {
              "type": "CategoryId"
            },
            "description": {
              "type": "string"
            },
            "isActive": {
              "type": "boolean"
            },
            "name": {
              "type": "string"
            },
            "price": {
              "type": "Money"
            },
            "productId": {
              "type": "ProductId",
              "required": true
            }
          },
          "outputSchema": {
            "categoryId": {
              "type": "CategoryId"
            },
            "description": {
              "type": "string"
            },
            "isActive": {
              "type": "boolean"
            },
            "name": {
              "type": "string"
            },
            "price": {
              "type": "Money"
            },
            "productId": {
              "type": "ProductId"
            },
            "updatedAt": {
              "type": "DateTime"
            },
            "updatedBy": {
              "type": "UserId"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "INVALID_PRODUCT_NAME",
              "httpStatus": 400,
              "message": "Product name must be between 2 and 200 characters"
            },
            {
              "code": "DESCRIPTION_TOO_LONG",
              "httpStatus": 400,
              "message": "Description cannot exceed 5000 characters"
            },
            {
              "code": "INVALID_PRICE",
              "httpStatus": 400,
              "message": "Price must be at least $0.01"
            },
            {
              "code": "CATEGORY_NOT_FOUND",
              "httpStatus": 404,
              "message": "Category not found"
            }
          ],
          "preconditions": [
            "User has admin role",
            "Product exists"
          ],
          "postconditions": [
            "Product updated",
            "Price changes logged in audit trail",
            "ProductUpdated event emitted",
            "Carts with product reflect new price"
          ],
          "relatedACs": [
            "AC-ADMIN-002"
          ],
          "relatedBRs": [
            "BR-PRICE-001",
            "BR-PROD-002",
            "BR-PROD-003",
            "BR-AUDIT-003",
            "BR-CART-001"
          ]
        },
        {
          "id": "OP-PROD-005",
          "name": "deleteProduct",
          "method": "DELETE",
          "path": "/{productId}",
          "description": "Soft delete product preserving order history",
          "inputSchema": {
            "productId": {
              "type": "ProductId",
              "required": true
            }
          },
          "outputSchema": {
            "deletedAt": {
              "type": "DateTime"
            },
            "success": {
              "type": "boolean"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            }
          ],
          "preconditions": [
            "User has admin role",
            "Product exists"
          ],
          "postconditions": [
            "Product soft-deleted (deletedAt set)",
            "Product removed from active listings",
            "Product removed from carts",
            "ProductDeleted event emitted"
          ],
          "relatedACs": [
            "AC-ADMIN-003"
          ],
          "relatedBRs": [
            "BR-PROD-001"
          ]
        },
        {
          "id": "OP-PROD-006",
          "name": "addProductImage",
          "method": "POST",
          "path": "/{productId}/images",
          "description": "Upload product image (max 10 per product)",
          "inputSchema": {
            "image": {
              "type": "binary",
              "required": true
            },
            "isPrimary": {
              "type": "boolean"
            },
            "productId": {
              "type": "ProductId",
              "required": true
            }
          },
          "outputSchema": {
            "imageId": {
              "type": "ImageId"
            },
            "isPrimary": {
              "type": "boolean"
            },
            "url": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "IMAGE_LIMIT_EXCEEDED",
              "httpStatus": 400,
              "message": "Products cannot have more than 10 images"
            },
            {
              "code": "INVALID_IMAGE_FORMAT",
              "httpStatus": 400,
              "message": "Image format not supported"
            }
          ],
          "preconditions": [
            "User has admin role",
            "Product exists",
            "Product has fewer than 10 images"
          ],
          "postconditions": [
            "Image uploaded and associated with product",
            "If isPrimary=true, previous primary unset"
          ],
          "relatedACs": [
            "AC-ADMIN-001"
          ],
          "relatedBRs": [
            "BR-PROD-004"
          ]
        },
        {
          "id": "OP-PROD-007",
          "name": "addProductVariant",
          "method": "POST",
          "path": "/{productId}/variants",
          "description": "Add a variant (size/color) to product",
          "inputSchema": {
            "color": {
              "type": "string"
            },
            "priceAdjustment": {
              "type": "Money"
            },
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "size": {
              "type": "string"
            },
            "sku": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "color": {
              "type": "string"
            },
            "priceAdjustment": {
              "type": "Money"
            },
            "size": {
              "type": "string"
            },
            "sku": {
              "type": "string"
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "DUPLICATE_SKU",
              "httpStatus": 409,
              "message": "SKU already exists"
            },
            {
              "code": "VARIANT_ATTRIBUTE_REQUIRED",
              "httpStatus": 400,
              "message": "At least one variant attribute (size or color) must be specified"
            }
          ],
          "preconditions": [
            "User has admin role",
            "Product exists",
            "SKU is unique"
          ],
          "postconditions": [
            "Variant added to product"
          ],
          "relatedACs": [
            "AC-VAR-001"
          ],
          "relatedBRs": [
            "BR-VAR-001"
          ]
        }
      ],
      "events": [
        {
          "name": "ProductCreated",
          "description": "Emitted when a new product is created",
          "payload": [
            "productId",
            "name",
            "price",
            "categoryId",
            "createdBy",
            "createdAt"
          ]
        },
        {
          "name": "ProductUpdated",
          "description": "Emitted when product attributes are modified",
          "payload": [
            "productId",
            "changedFields",
            "previousPrice",
            "newPrice",
            "updatedBy",
            "updatedAt"
          ]
        },
        {
          "name": "ProductDeleted",
          "description": "Emitted when product is soft-deleted",
          "payload": [
            "productId",
            "deletedBy",
            "deletedAt"
          ]
        },
        {
          "name": "ProductDeactivated",
          "description": "Emitted when product is deactivated",
          "payload": [
            "productId",
            "deactivatedBy",
            "deactivatedAt"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT",
        "authorization": "Read: Public for active products; Write: Admin only"
      }
    },
    {
      "id": "IC-CAT-001",
      "serviceName": "Category Service",
      "purpose": "Manages product category hierarchy for organization and browsing",
      "baseUrl": "/api/v1/categories",
      "operations": [
        {
          "id": "OP-CAT-001",
          "name": "listCategories",
          "method": "GET",
          "path": "/",
          "description": "Get category hierarchy up to 3 levels deep",
          "inputSchema": {
            "includeInactive": {
              "type": "boolean"
            },
            "parentId": {
              "type": "CategoryId"
            }
          },
          "outputSchema": {
            "categories": {
              "type": "Array\u003cCategory\u003e"
            }
          },
          "errors": [],
          "preconditions": [],
          "postconditions": [
            "Returns category tree"
          ],
          "relatedACs": [
            "AC-CAT-001"
          ],
          "relatedBRs": [
            "BR-CAT-001"
          ]
        },
        {
          "id": "OP-CAT-002",
          "name": "createCategory",
          "method": "POST",
          "path": "/",
          "description": "Create a new category with optional parent",
          "inputSchema": {
            "description": {
              "type": "string"
            },
            "name": {
              "type": "string",
              "required": true
            },
            "parentCategoryId": {
              "type": "CategoryId"
            }
          },
          "outputSchema": {
            "categoryId": {
              "type": "CategoryId"
            },
            "depth": {
              "type": "integer"
            },
            "description": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "parentCategoryId": {
              "type": "CategoryId"
            }
          },
          "errors": [
            {
              "code": "DUPLICATE_CATEGORY_NAME",
              "httpStatus": 409,
              "message": "Category name must be unique"
            },
            {
              "code": "CATEGORY_DEPTH_EXCEEDED",
              "httpStatus": 400,
              "message": "Categories cannot be nested more than 3 levels deep"
            },
            {
              "code": "PARENT_CATEGORY_NOT_FOUND",
              "httpStatus": 404,
              "message": "Parent category not found"
            }
          ],
          "preconditions": [
            "User has admin role",
            "Name is unique",
            "Depth would not exceed 3"
          ],
          "postconditions": [
            "Category created",
            "CategoryCreated event emitted"
          ],
          "relatedACs": [
            "AC-CAT-001"
          ],
          "relatedBRs": [
            "BR-CAT-001"
          ]
        },
        {
          "id": "OP-CAT-003",
          "name": "getCategory",
          "method": "GET",
          "path": "/{categoryId}",
          "description": "Get category details with products",
          "inputSchema": {
            "categoryId": {
              "type": "CategoryId",
              "required": true
            }
          },
          "outputSchema": {
            "categoryId": {
              "type": "CategoryId"
            },
            "childCategories": {
              "type": "Array\u003cCategory\u003e"
            },
            "description": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "parentCategoryId": {
              "type": "CategoryId"
            },
            "productCount": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "CATEGORY_NOT_FOUND",
              "httpStatus": 404,
              "message": "Category not found"
            }
          ],
          "preconditions": [
            "Category exists"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-CAT-001"
          ],
          "relatedBRs": []
        }
      ],
      "events": [
        {
          "name": "CategoryCreated",
          "description": "Emitted when a new category is created",
          "payload": [
            "categoryId",
            "name",
            "parentCategoryId",
            "createdAt"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT for write operations",
        "authorization": "Read: Public; Write: Admin only"
      }
    },
    {
      "id": "IC-CART-001",
      "serviceName": "Cart Service",
      "purpose": "Manages shopping carts for customers including items, quantities, and cart merging",
      "baseUrl": "/api/v1/carts",
      "operations": [
        {
          "id": "OP-CART-001",
          "name": "getCart",
          "method": "GET",
          "path": "/{cartId}",
          "description": "Get cart contents with current prices and stock status",
          "inputSchema": {
            "cartId": {
              "type": "CartId",
              "required": true
            }
          },
          "outputSchema": {
            "cartId": {
              "type": "CartId"
            },
            "customerId": {
              "type": "CustomerId"
            },
            "itemCount": {
              "type": "integer"
            },
            "items": {
              "type": "Array\u003cCartItem\u003e"
            },
            "priceChanges": {
              "type": "Array\u003cPriceChange\u003e"
            },
            "stockWarnings": {
              "type": "Array\u003cStockWarning\u003e"
            },
            "totalPrice": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "CART_NOT_FOUND",
              "httpStatus": 404,
              "message": "Cart not found"
            },
            {
              "code": "CART_EXPIRED",
              "httpStatus": 410,
              "message": "Cart has expired"
            }
          ],
          "preconditions": [
            "Cart exists and not expired"
          ],
          "postconditions": [
            "Returns cart with current prices calculated"
          ],
          "relatedACs": [
            "AC-CART-007",
            "AC-CART-008"
          ],
          "relatedBRs": [
            "BR-CART-001"
          ]
        },
        {
          "id": "OP-CART-002",
          "name": "addItem",
          "method": "POST",
          "path": "/{cartId}/items",
          "description": "Add product to cart or increment existing item quantity",
          "inputSchema": {
            "cartId": {
              "type": "CartId",
              "required": true
            },
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "quantity": {
              "type": "integer",
              "required": true
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "outputSchema": {
            "cartItemId": {
              "type": "CartItemId"
            },
            "productId": {
              "type": "ProductId"
            },
            "productName": {
              "type": "string"
            },
            "quantity": {
              "type": "integer"
            },
            "subtotal": {
              "type": "Money"
            },
            "unitPrice": {
              "type": "Money"
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "errors": [
            {
              "code": "CART_NOT_FOUND",
              "httpStatus": 404,
              "message": "Cart not found"
            },
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "OUT_OF_STOCK",
              "httpStatus": 409,
              "message": "Product is out of stock"
            },
            {
              "code": "QUANTITY_EXCEEDS_STOCK",
              "httpStatus": 409,
              "message": "Requested quantity exceeds available stock"
            },
            {
              "code": "VARIANT_REQUIRED",
              "httpStatus": 400,
              "message": "Product has variants; variant selection required"
            },
            {
              "code": "VARIANT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Variant not found"
            },
            {
              "code": "INVALID_QUANTITY",
              "httpStatus": 400,
              "message": "Quantity must be at least 1"
            }
          ],
          "preconditions": [
            "Cart exists",
            "Product exists and is active",
            "Stock available",
            "Variant selected if product has variants"
          ],
          "postconditions": [
            "Item added or quantity incremented",
            "Cart total recalculated",
            "ItemAddedToCart event emitted"
          ],
          "relatedACs": [
            "AC-CART-001",
            "AC-CART-002"
          ],
          "relatedBRs": [
            "BR-STOCK-001",
            "BR-CART-002",
            "BR-VAR-002"
          ]
        },
        {
          "id": "OP-CART-003",
          "name": "updateItemQuantity",
          "method": "PATCH",
          "path": "/{cartId}/items/{cartItemId}",
          "description": "Update quantity of item in cart",
          "inputSchema": {
            "cartId": {
              "type": "CartId",
              "required": true
            },
            "cartItemId": {
              "type": "CartItemId",
              "required": true
            },
            "quantity": {
              "type": "integer",
              "required": true
            }
          },
          "outputSchema": {
            "cartItemId": {
              "type": "CartItemId"
            },
            "cartTotal": {
              "type": "Money"
            },
            "quantity": {
              "type": "integer"
            },
            "subtotal": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "CART_NOT_FOUND",
              "httpStatus": 404,
              "message": "Cart not found"
            },
            {
              "code": "CART_ITEM_NOT_FOUND",
              "httpStatus": 404,
              "message": "Cart item not found"
            },
            {
              "code": "QUANTITY_EXCEEDS_STOCK",
              "httpStatus": 409,
              "message": "Requested quantity exceeds available stock"
            },
            {
              "code": "INVALID_QUANTITY",
              "httpStatus": 400,
              "message": "Quantity must be 0 or greater"
            }
          ],
          "preconditions": [
            "Cart exists",
            "Item exists in cart"
          ],
          "postconditions": [
            "Quantity updated (or item removed if 0)",
            "Cart total recalculated",
            "CartQuantityUpdated event emitted"
          ],
          "relatedACs": [
            "AC-CART-005"
          ],
          "relatedBRs": [
            "BR-CART-002"
          ]
        },
        {
          "id": "OP-CART-004",
          "name": "removeItem",
          "method": "DELETE",
          "path": "/{cartId}/items/{cartItemId}",
          "description": "Remove item from cart",
          "inputSchema": {
            "cartId": {
              "type": "CartId",
              "required": true
            },
            "cartItemId": {
              "type": "CartItemId",
              "required": true
            }
          },
          "outputSchema": {
            "cartTotal": {
              "type": "Money"
            },
            "success": {
              "type": "boolean"
            },
            "undoToken": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "CART_NOT_FOUND",
              "httpStatus": 404,
              "message": "Cart not found"
            },
            {
              "code": "CART_ITEM_NOT_FOUND",
              "httpStatus": 404,
              "message": "Cart item not found"
            }
          ],
          "preconditions": [
            "Cart exists",
            "Item exists in cart"
          ],
          "postconditions": [
            "Item removed",
            "Cart total recalculated",
            "ItemRemovedFromCart event emitted",
            "Undo token generated"
          ],
          "relatedACs": [
            "AC-CART-006"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CART-005",
          "name": "undoRemoveItem",
          "method": "POST",
          "path": "/{cartId}/items/undo",
          "description": "Undo recent item removal using undo token",
          "inputSchema": {
            "cartId": {
              "type": "CartId",
              "required": true
            },
            "undoToken": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "cartItemId": {
              "type": "CartItemId"
            },
            "restored": {
              "type": "boolean"
            }
          },
          "errors": [
            {
              "code": "CART_NOT_FOUND",
              "httpStatus": 404,
              "message": "Cart not found"
            },
            {
              "code": "INVALID_UNDO_TOKEN",
              "httpStatus": 400,
              "message": "Undo token is invalid or expired"
            }
          ],
          "preconditions": [
            "Cart exists",
            "Undo token valid and not expired"
          ],
          "postconditions": [
            "Item restored to cart"
          ],
          "relatedACs": [
            "AC-CART-006"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CART-006",
          "name": "createGuestCart",
          "method": "POST",
          "path": "/guest",
          "description": "Create a session-based cart for guest user",
          "inputSchema": {
            "sessionId": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "cartId": {
              "type": "CartId"
            },
            "expiresAt": {
              "type": "DateTime"
            }
          },
          "errors": [],
          "preconditions": [],
          "postconditions": [
            "Guest cart created with 7-day expiration"
          ],
          "relatedACs": [
            "AC-CART-003"
          ],
          "relatedBRs": [
            "BR-CART-003"
          ]
        },
        {
          "id": "OP-CART-007",
          "name": "mergeCarts",
          "method": "POST",
          "path": "/{cartId}/merge",
          "description": "Merge guest cart into customer cart on login",
          "inputSchema": {
            "cartId": {
              "type": "CartId",
              "required": true
            },
            "guestCartId": {
              "type": "CartId",
              "required": true
            }
          },
          "outputSchema": {
            "cartId": {
              "type": "CartId"
            },
            "mergedItemCount": {
              "type": "integer"
            },
            "stockLimitedItems": {
              "type": "Array\u003cStockWarning\u003e"
            }
          },
          "errors": [
            {
              "code": "CART_NOT_FOUND",
              "httpStatus": 404,
              "message": "Cart not found"
            },
            {
              "code": "GUEST_CART_NOT_FOUND",
              "httpStatus": 404,
              "message": "Guest cart not found"
            }
          ],
          "preconditions": [
            "Both carts exist"
          ],
          "postconditions": [
            "Items merged with quantity combination",
            "Quantities capped at available stock",
            "Guest cart deleted"
          ],
          "relatedACs": [
            "AC-CART-004"
          ],
          "relatedBRs": [
            "BR-CART-002"
          ]
        }
      ],
      "events": [
        {
          "name": "ItemAddedToCart",
          "description": "Emitted when item is added to cart",
          "payload": [
            "cartId",
            "cartItemId",
            "productId",
            "variantId",
            "quantity"
          ]
        },
        {
          "name": "CartQuantityUpdated",
          "description": "Emitted when cart item quantity changes",
          "payload": [
            "cartId",
            "cartItemId",
            "previousQuantity",
            "newQuantity"
          ]
        },
        {
          "name": "ItemRemovedFromCart",
          "description": "Emitted when item is removed from cart",
          "payload": [
            "cartId",
            "cartItemId",
            "productId"
          ]
        },
        {
          "name": "CartCleared",
          "description": "Emitted when cart is emptied",
          "payload": [
            "cartId",
            "reason"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT or session token for guest",
        "authorization": "Customer can only access own cart"
      }
    },
    {
      "id": "IC-ORDER-001",
      "serviceName": "Order Service",
      "purpose": "Manages order lifecycle from placement through delivery including status transitions",
      "baseUrl": "/api/v1/orders",
      "operations": [
        {
          "id": "OP-ORDER-001",
          "name": "placeOrder",
          "method": "POST",
          "path": "/",
          "description": "Create order from cart with payment authorization",
          "inputSchema": {
            "cartId": {
              "type": "CartId",
              "required": true
            },
            "customerId": {
              "type": "CustomerId",
              "required": true
            },
            "paymentMethodId": {
              "type": "PaymentMethodId",
              "required": true
            },
            "shippingAddressId": {
              "type": "AddressId",
              "required": true
            }
          },
          "outputSchema": {
            "createdAt": {
              "type": "DateTime"
            },
            "lineItems": {
              "type": "Array\u003cOrderLineItem\u003e"
            },
            "orderId": {
              "type": "OrderId"
            },
            "orderNumber": {
              "type": "string"
            },
            "shippingCost": {
              "type": "Money"
            },
            "status": {
              "type": "OrderStatus"
            },
            "subtotal": {
              "type": "Money"
            },
            "tax": {
              "type": "Money"
            },
            "totalAmount": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "REGISTRATION_REQUIRED",
              "httpStatus": 403,
              "message": "Only registered customers can place orders"
            },
            {
              "code": "EMAIL_NOT_VERIFIED",
              "httpStatus": 403,
              "message": "Email verification required before placing orders"
            },
            {
              "code": "CART_EMPTY",
              "httpStatus": 400,
              "message": "Cannot place order with empty cart"
            },
            {
              "code": "OUT_OF_STOCK",
              "httpStatus": 409,
              "message": "One or more items are out of stock"
            },
            {
              "code": "INSUFFICIENT_STOCK",
              "httpStatus": 409,
              "message": "Requested quantity exceeds available stock"
            },
            {
              "code": "BACKORDER_NOT_SUPPORTED",
              "httpStatus": 409,
              "message": "Backorders are not supported"
            },
            {
              "code": "PAYMENT_REQUIRED",
              "httpStatus": 402,
              "message": "Payment authorization failed"
            },
            {
              "code": "INCOMPLETE_ADDRESS",
              "httpStatus": 400,
              "message": "Shipping address is incomplete"
            },
            {
              "code": "INTERNATIONAL_SHIPPING_NOT_AVAILABLE",
              "httpStatus": 400,
              "message": "International shipping not available"
            }
          ],
          "preconditions": [
            "Customer registered and email verified",
            "Cart has items",
            "All items in stock",
            "Valid shipping address",
            "Valid payment method"
          ],
          "postconditions": [
            "Payment authorized",
            "Inventory decremented",
            "Order created with PENDING status",
            "Cart cleared",
            "Prices snapshot captured",
            "OrderPlaced event emitted",
            "Confirmation email queued"
          ],
          "relatedACs": [
            "AC-ORDER-001",
            "AC-ORDER-002",
            "AC-ORDER-003",
            "AC-ORDER-007"
          ],
          "relatedBRs": [
            "BR-AUTH-001",
            "BR-STOCK-001",
            "BR-SHIP-001",
            "BR-PAY-001",
            "BR-PRICE-002",
            "BR-INV-001",
            "BR-INV-002",
            "BR-CUST-003"
          ]
        },
        {
          "id": "OP-ORDER-002",
          "name": "getOrder",
          "method": "GET",
          "path": "/{orderId}",
          "description": "Get order details including line items and status",
          "inputSchema": {
            "orderId": {
              "type": "OrderId",
              "required": true
            }
          },
          "outputSchema": {
            "createdAt": {
              "type": "DateTime"
            },
            "customerId": {
              "type": "CustomerId"
            },
            "lineItems": {
              "type": "Array\u003cOrderLineItem\u003e"
            },
            "orderId": {
              "type": "OrderId"
            },
            "orderNumber": {
              "type": "string"
            },
            "shippingAddress": {
              "type": "ShippingAddress"
            },
            "shippingCost": {
              "type": "Money"
            },
            "status": {
              "type": "OrderStatus"
            },
            "subtotal": {
              "type": "Money"
            },
            "tax": {
              "type": "Money"
            },
            "totalAmount": {
              "type": "Money"
            },
            "trackingNumber": {
              "type": "string"
            },
            "updatedAt": {
              "type": "DateTime"
            }
          },
          "errors": [
            {
              "code": "ORDER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Order not found"
            }
          ],
          "preconditions": [
            "Order exists",
            "User authorized to view"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ORDER-005"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-ORDER-003",
          "name": "listOrders",
          "method": "GET",
          "path": "/",
          "description": "List orders with filtering and pagination",
          "inputSchema": {
            "customerId": {
              "type": "CustomerId"
            },
            "fromDate": {
              "type": "DateTime"
            },
            "page": {
              "type": "integer"
            },
            "pageSize": {
              "type": "integer"
            },
            "status": {
              "type": "OrderStatus"
            },
            "toDate": {
              "type": "DateTime"
            }
          },
          "outputSchema": {
            "orders": {
              "type": "Array\u003cOrderSummary\u003e"
            },
            "page": {
              "type": "integer"
            },
            "pageSize": {
              "type": "integer"
            },
            "totalCount": {
              "type": "integer"
            }
          },
          "errors": [],
          "preconditions": [
            "User authorized"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ORDER-005",
            "AC-ADMIN-004"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-ORDER-004",
          "name": "confirmOrder",
          "method": "POST",
          "path": "/{orderId}/confirm",
          "description": "Confirm pending order",
          "inputSchema": {
            "orderId": {
              "type": "OrderId",
              "required": true
            }
          },
          "outputSchema": {
            "confirmedAt": {
              "type": "DateTime"
            },
            "orderId": {
              "type": "OrderId"
            },
            "status": {
              "type": "OrderStatus"
            }
          },
          "errors": [
            {
              "code": "ORDER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Order not found"
            },
            {
              "code": "INVALID_STATUS_TRANSITION",
              "httpStatus": 409,
              "message": "Order must be in PENDING status to confirm"
            }
          ],
          "preconditions": [
            "Order exists",
            "Status is PENDING"
          ],
          "postconditions": [
            "Status changed to CONFIRMED",
            "OrderConfirmed event emitted",
            "Status change logged"
          ],
          "relatedACs": [
            "AC-ADMIN-005"
          ],
          "relatedBRs": [
            "BR-ORDER-001",
            "BR-AUDIT-001"
          ]
        },
        {
          "id": "OP-ORDER-005",
          "name": "shipOrder",
          "method": "POST",
          "path": "/{orderId}/ship",
          "description": "Mark order as shipped with optional tracking number",
          "inputSchema": {
            "orderId": {
              "type": "OrderId",
              "required": true
            },
            "trackingNumber": {
              "type": "string"
            }
          },
          "outputSchema": {
            "orderId": {
              "type": "OrderId"
            },
            "shippedAt": {
              "type": "DateTime"
            },
            "status": {
              "type": "OrderStatus"
            },
            "trackingNumber": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "ORDER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Order not found"
            },
            {
              "code": "INVALID_STATUS_TRANSITION",
              "httpStatus": 409,
              "message": "Order must be in CONFIRMED status to ship"
            }
          ],
          "preconditions": [
            "Order exists",
            "Status is CONFIRMED"
          ],
          "postconditions": [
            "Status changed to SHIPPED",
            "OrderShipped event emitted",
            "Customer notification sent"
          ],
          "relatedACs": [
            "AC-ADMIN-005"
          ],
          "relatedBRs": [
            "BR-ORDER-001",
            "BR-ORDER-003",
            "BR-AUDIT-001"
          ]
        },
        {
          "id": "OP-ORDER-006",
          "name": "deliverOrder",
          "method": "POST",
          "path": "/{orderId}/deliver",
          "description": "Mark order as delivered",
          "inputSchema": {
            "orderId": {
              "type": "OrderId",
              "required": true
            }
          },
          "outputSchema": {
            "deliveredAt": {
              "type": "DateTime"
            },
            "orderId": {
              "type": "OrderId"
            },
            "status": {
              "type": "OrderStatus"
            }
          },
          "errors": [
            {
              "code": "ORDER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Order not found"
            },
            {
              "code": "INVALID_STATUS_TRANSITION",
              "httpStatus": 409,
              "message": "Order must be in SHIPPED status to deliver"
            }
          ],
          "preconditions": [
            "Order exists",
            "Status is SHIPPED"
          ],
          "postconditions": [
            "Status changed to DELIVERED",
            "OrderDelivered event emitted"
          ],
          "relatedACs": [
            "AC-ADMIN-005"
          ],
          "relatedBRs": [
            "BR-ORDER-001",
            "BR-AUDIT-001"
          ]
        },
        {
          "id": "OP-ORDER-007",
          "name": "cancelOrder",
          "method": "POST",
          "path": "/{orderId}/cancel",
          "description": "Cancel order with inventory restoration and refund",
          "inputSchema": {
            "orderId": {
              "type": "OrderId",
              "required": true
            },
            "reason": {
              "type": "string"
            }
          },
          "outputSchema": {
            "cancelledAt": {
              "type": "DateTime"
            },
            "orderId": {
              "type": "OrderId"
            },
            "refundInitiated": {
              "type": "boolean"
            },
            "status": {
              "type": "OrderStatus"
            }
          },
          "errors": [
            {
              "code": "ORDER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Order not found"
            },
            {
              "code": "CANCELLATION_NOT_ALLOWED",
              "httpStatus": 409,
              "message": "Order cannot be cancelled after shipping"
            },
            {
              "code": "ORDER_ALREADY_CANCELLED",
              "httpStatus": 409,
              "message": "Order is already cancelled"
            }
          ],
          "preconditions": [
            "Order exists",
            "Status is PENDING or CONFIRMED"
          ],
          "postconditions": [
            "Status changed to CANCELLED",
            "Inventory restored",
            "Refund initiated",
            "OrderCancelled event emitted",
            "Cancellation email sent"
          ],
          "relatedACs": [
            "AC-ORDER-006"
          ],
          "relatedBRs": [
            "BR-CANCEL-001",
            "BR-INV-003",
            "BR-PAY-002",
            "BR-AUDIT-001"
          ]
        },
        {
          "id": "OP-ORDER-008",
          "name": "searchOrders",
          "method": "GET",
          "path": "/search",
          "description": "Search orders by order number",
          "inputSchema": {
            "orderNumber": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "orders": {
              "type": "Array\u003cOrderSummary\u003e"
            }
          },
          "errors": [],
          "preconditions": [
            "User has admin role"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ADMIN-004"
          ],
          "relatedBRs": []
        }
      ],
      "events": [
        {
          "name": "OrderPlaced",
          "description": "Emitted when order is created",
          "payload": [
            "orderId",
            "orderNumber",
            "customerId",
            "totalAmount",
            "createdAt"
          ]
        },
        {
          "name": "OrderConfirmed",
          "description": "Emitted when order is confirmed",
          "payload": [
            "orderId",
            "confirmedBy",
            "confirmedAt"
          ]
        },
        {
          "name": "OrderShipped",
          "description": "Emitted when order is shipped",
          "payload": [
            "orderId",
            "trackingNumber",
            "shippedAt"
          ]
        },
        {
          "name": "OrderDelivered",
          "description": "Emitted when order is delivered",
          "payload": [
            "orderId",
            "deliveredAt"
          ]
        },
        {
          "name": "OrderCancelled",
          "description": "Emitted when order is cancelled",
          "payload": [
            "orderId",
            "reason",
            "cancelledBy",
            "cancelledAt"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT",
        "authorization": "Customers: own orders only; Admin: all orders and status updates"
      }
    },
    {
      "id": "IC-INV-001",
      "serviceName": "Inventory Service",
      "purpose": "Tracks and manages stock levels, reservations, and inventory adjustments",
      "baseUrl": "/api/v1/inventory",
      "operations": [
        {
          "id": "OP-INV-001",
          "name": "getInventory",
          "method": "GET",
          "path": "/{productId}",
          "description": "Get current inventory levels for a product",
          "inputSchema": {
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "inventoryId": {
              "type": "InventoryId"
            },
            "productId": {
              "type": "ProductId"
            },
            "quantityOnHand": {
              "type": "integer"
            },
            "reservedQuantity": {
              "type": "integer"
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "INVENTORY_NOT_FOUND",
              "httpStatus": 404,
              "message": "Inventory record not found"
            }
          ],
          "preconditions": [
            "Product exists"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ADMIN-006"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-INV-002",
          "name": "setStock",
          "method": "PUT",
          "path": "/{productId}",
          "description": "Set absolute stock level with audit logging",
          "inputSchema": {
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "quantity": {
              "type": "integer",
              "required": true
            },
            "reason": {
              "type": "string"
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "inventoryId": {
              "type": "InventoryId"
            },
            "newQuantity": {
              "type": "integer"
            },
            "previousQuantity": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "NEGATIVE_INVENTORY",
              "httpStatus": 400,
              "message": "Inventory cannot be set below zero"
            }
          ],
          "preconditions": [
            "Product exists",
            "User has admin role"
          ],
          "postconditions": [
            "Stock level updated",
            "Audit trail recorded",
            "Low stock alert if threshold crossed"
          ],
          "relatedACs": [
            "AC-ADMIN-006"
          ],
          "relatedBRs": [
            "BR-INV-001",
            "BR-AUDIT-002"
          ]
        },
        {
          "id": "OP-INV-003",
          "name": "adjustStock",
          "method": "POST",
          "path": "/{productId}/adjust",
          "description": "Adjust stock by delta (positive or negative)",
          "inputSchema": {
            "delta": {
              "type": "integer",
              "required": true
            },
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "reason": {
              "type": "string",
              "required": true
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "inventoryId": {
              "type": "InventoryId"
            },
            "newQuantity": {
              "type": "integer"
            },
            "previousQuantity": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "NEGATIVE_INVENTORY",
              "httpStatus": 400,
              "message": "Adjustment would result in negative inventory"
            }
          ],
          "preconditions": [
            "Product exists",
            "User has admin role",
            "Result would be \u003e= 0"
          ],
          "postconditions": [
            "Stock adjusted",
            "Audit trail recorded with reason",
            "Low stock alert if threshold crossed"
          ],
          "relatedACs": [
            "AC-ADMIN-006"
          ],
          "relatedBRs": [
            "BR-INV-001",
            "BR-AUDIT-002"
          ]
        },
        {
          "id": "OP-INV-004",
          "name": "reserveStock",
          "method": "POST",
          "path": "/{productId}/reserve",
          "description": "Reserve stock for pending order",
          "inputSchema": {
            "orderId": {
              "type": "OrderId",
              "required": true
            },
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "quantity": {
              "type": "integer",
              "required": true
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "productId": {
              "type": "ProductId"
            },
            "quantity": {
              "type": "integer"
            },
            "reservationId": {
              "type": "ReservationId"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "INSUFFICIENT_STOCK",
              "httpStatus": 409,
              "message": "Not enough stock to reserve"
            }
          ],
          "preconditions": [
            "Product exists",
            "Available quantity \u003e= requested"
          ],
          "postconditions": [
            "Reserved quantity increased",
            "InventoryReserved event emitted"
          ],
          "relatedACs": [],
          "relatedBRs": [
            "BR-INV-001",
            "BR-INV-002"
          ]
        },
        {
          "id": "OP-INV-005",
          "name": "releaseReservation",
          "method": "DELETE",
          "path": "/{productId}/reserve/{reservationId}",
          "description": "Release reserved stock (e.g., order cancelled)",
          "inputSchema": {
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "reservationId": {
              "type": "ReservationId",
              "required": true
            }
          },
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "released": {
              "type": "boolean"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "RESERVATION_NOT_FOUND",
              "httpStatus": 404,
              "message": "Reservation not found"
            }
          ],
          "preconditions": [
            "Reservation exists"
          ],
          "postconditions": [
            "Reserved quantity decreased",
            "InventoryReleased event emitted"
          ],
          "relatedACs": [
            "AC-ORDER-006"
          ],
          "relatedBRs": [
            "BR-INV-003"
          ]
        },
        {
          "id": "OP-INV-006",
          "name": "deductStock",
          "method": "POST",
          "path": "/{productId}/deduct",
          "description": "Deduct stock from on-hand (order shipped)",
          "inputSchema": {
            "orderId": {
              "type": "OrderId",
              "required": true
            },
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "quantity": {
              "type": "integer",
              "required": true
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "outputSchema": {
            "newQuantity": {
              "type": "integer"
            },
            "previousQuantity": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "INSUFFICIENT_STOCK",
              "httpStatus": 409,
              "message": "Not enough stock to deduct"
            }
          ],
          "preconditions": [
            "Product exists",
            "Quantity on hand \u003e= requested"
          ],
          "postconditions": [
            "Quantity on hand decreased",
            "InventoryDeducted event emitted"
          ],
          "relatedACs": [],
          "relatedBRs": [
            "BR-INV-001"
          ]
        },
        {
          "id": "OP-INV-007",
          "name": "restockInventory",
          "method": "POST",
          "path": "/{productId}/restock",
          "description": "Add stock to inventory",
          "inputSchema": {
            "productId": {
              "type": "ProductId",
              "required": true
            },
            "quantity": {
              "type": "integer",
              "required": true
            },
            "reason": {
              "type": "string"
            },
            "variantId": {
              "type": "VariantId"
            }
          },
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "newQuantity": {
              "type": "integer"
            },
            "previousQuantity": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "INVALID_QUANTITY",
              "httpStatus": 400,
              "message": "Quantity must be positive"
            }
          ],
          "preconditions": [
            "Product exists",
            "Quantity \u003e 0"
          ],
          "postconditions": [
            "Quantity on hand increased",
            "InventoryRestocked event emitted",
            "Audit trail recorded"
          ],
          "relatedACs": [
            "AC-ADMIN-006"
          ],
          "relatedBRs": [
            "BR-AUDIT-002"
          ]
        },
        {
          "id": "OP-INV-008",
          "name": "bulkImport",
          "method": "POST",
          "path": "/bulk-import",
          "description": "Import inventory levels from CSV",
          "inputSchema": {
            "file": {
              "type": "binary",
              "required": true
            },
            "format": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "errors": {
              "type": "Array\u003cImportError\u003e"
            },
            "failed": {
              "type": "integer"
            },
            "imported": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "INVALID_FILE_FORMAT",
              "httpStatus": 400,
              "message": "File format not supported"
            },
            {
              "code": "VALIDATION_ERRORS",
              "httpStatus": 400,
              "message": "One or more rows have validation errors"
            }
          ],
          "preconditions": [
            "User has admin role",
            "File is valid CSV"
          ],
          "postconditions": [
            "Valid rows imported",
            "Failed rows returned with errors"
          ],
          "relatedACs": [
            "AC-ADMIN-006"
          ],
          "relatedBRs": []
        }
      ],
      "events": [
        {
          "name": "InventoryReserved",
          "description": "Emitted when stock is reserved for an order",
          "payload": [
            "inventoryId",
            "productId",
            "variantId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryReleased",
          "description": "Emitted when reservation is released",
          "payload": [
            "inventoryId",
            "productId",
            "variantId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryDeducted",
          "description": "Emitted when stock is deducted (shipped)",
          "payload": [
            "inventoryId",
            "productId",
            "variantId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryRestocked",
          "description": "Emitted when stock is added",
          "payload": [
            "inventoryId",
            "productId",
            "variantId",
            "quantity",
            "reason"
          ]
        },
        {
          "name": "OutOfStock",
          "description": "Emitted when available quantity reaches zero",
          "payload": [
            "inventoryId",
            "productId",
            "variantId"
          ]
        },
        {
          "name": "LowStockAlert",
          "description": "Emitted when stock falls below threshold",
          "payload": [
            "inventoryId",
            "productId",
            "variantId",
            "availableQuantity",
            "threshold"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT",
        "authorization": "Read: Internal services; Write: Admin only"
      }
    }
  ],
  "sequences": [
    {
      "id": "SEQ-CART-001",
      "name": "Add Item to Cart",
      "description": "Customer adds a product to their shopping cart with stock validation",
      "trigger": {
        "type": "user_action",
        "description": "Customer clicks 'Add to Cart' button on product page"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "CartService",
          "type": "service"
        },
        {
          "name": "InventoryService",
          "type": "service"
        },
        {
          "name": "Cart",
          "type": "aggregate"
        },
        {
          "name": "Inventory",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "addItem",
          "target": "CartService",
          "data": [
            "productId",
            "variantId",
            "quantity"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "CartService",
          "action": "isInStock",
          "target": "InventoryService",
          "data": [
            "productId",
            "quantity"
          ],
          "returns": "boolean"
        },
        {
          "step": 3,
          "actor": "CartService",
          "action": "addItem",
          "target": "Cart",
          "data": [
            "product",
            "quantity"
          ],
          "returns": "void",
          "event": "ItemAddedToCart"
        },
        {
          "step": 4,
          "actor": "CartService",
          "action": "return",
          "target": "Customer",
          "data": [
            "updatedCart",
            "totalPrice"
          ],
          "returns": "Cart"
        }
      ],
      "outcome": {
        "success": "Item added to cart with updated total",
        "state_changes": [
          "Cart.items += CartItem",
          "Cart.totalPrice = recalculated"
        ]
      },
      "exceptions": [
        {
          "condition": "Product out of stock",
          "step": 2,
          "handling": "Return OUT_OF_STOCK error to customer"
        },
        {
          "condition": "Quantity exceeds available stock",
          "step": 2,
          "handling": "Return QUANTITY_EXCEEDS_STOCK error with available quantity"
        },
        {
          "condition": "Variant required but not selected",
          "step": 1,
          "handling": "Return VARIANT_REQUIRED error"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-STOCK-001",
        "BR-CART-002",
        "BR-VAR-002"
      ]
    },
    {
      "id": "SEQ-CART-002",
      "name": "Update Cart Item Quantity",
      "description": "Customer updates the quantity of an item already in their cart",
      "trigger": {
        "type": "user_action",
        "description": "Customer changes quantity input on cart page"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "CartService",
          "type": "service"
        },
        {
          "name": "InventoryService",
          "type": "service"
        },
        {
          "name": "Cart",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "updateQuantity",
          "target": "CartService",
          "data": [
            "cartId",
            "productId",
            "newQuantity"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "CartService",
          "action": "isInStock",
          "target": "InventoryService",
          "data": [
            "productId",
            "newQuantity"
          ],
          "returns": "boolean"
        },
        {
          "step": 3,
          "actor": "CartService",
          "action": "updateQuantity",
          "target": "Cart",
          "data": [
            "productId",
            "newQuantity"
          ],
          "returns": "void",
          "event": "CartQuantityUpdated"
        },
        {
          "step": 4,
          "actor": "CartService",
          "action": "return",
          "target": "Customer",
          "data": [
            "updatedCart"
          ],
          "returns": "Cart"
        }
      ],
      "outcome": {
        "success": "Cart item quantity updated with recalculated total",
        "state_changes": [
          "CartItem.quantity = newQuantity",
          "CartItem.subtotal = recalculated",
          "Cart.totalPrice = recalculated"
        ]
      },
      "exceptions": [
        {
          "condition": "Quantity exceeds available stock",
          "step": 2,
          "handling": "Return QUANTITY_EXCEEDS_STOCK error, cap at available"
        },
        {
          "condition": "Item not in cart",
          "step": 3,
          "handling": "Return ITEM_NOT_FOUND error"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-CART-002",
        "BR-INV-001"
      ]
    },
    {
      "id": "SEQ-CART-003",
      "name": "Remove Item from Cart",
      "description": "Customer removes an item from their shopping cart",
      "trigger": {
        "type": "user_action",
        "description": "Customer clicks 'Remove' button on cart item"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "CartService",
          "type": "service"
        },
        {
          "name": "Cart",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "removeItem",
          "target": "CartService",
          "data": [
            "cartId",
            "productId"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "CartService",
          "action": "removeItem",
          "target": "Cart",
          "data": [
            "productId"
          ],
          "returns": "void",
          "event": "ItemRemovedFromCart"
        },
        {
          "step": 3,
          "actor": "CartService",
          "action": "return",
          "target": "Customer",
          "data": [
            "updatedCart"
          ],
          "returns": "Cart"
        }
      ],
      "outcome": {
        "success": "Item removed from cart with recalculated total",
        "state_changes": [
          "Cart.items -= CartItem",
          "Cart.totalPrice = recalculated"
        ]
      },
      "exceptions": [
        {
          "condition": "Item not in cart",
          "step": 2,
          "handling": "Return ITEM_NOT_FOUND error or silently succeed"
        }
      ],
      "relatedACs": [],
      "relatedBRs": []
    },
    {
      "id": "SEQ-ORDER-001",
      "name": "Place Order",
      "description": "Customer places an order from their cart with payment processing and inventory reservation",
      "trigger": {
        "type": "user_action",
        "description": "Customer clicks 'Place Order' button at checkout"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "OrderService",
          "type": "service"
        },
        {
          "name": "CartService",
          "type": "service"
        },
        {
          "name": "InventoryService",
          "type": "service"
        },
        {
          "name": "PaymentService",
          "type": "service"
        },
        {
          "name": "CustomerService",
          "type": "service"
        },
        {
          "name": "Order",
          "type": "aggregate"
        },
        {
          "name": "Cart",
          "type": "aggregate"
        },
        {
          "name": "Inventory",
          "type": "aggregate"
        },
        {
          "name": "PaymentGateway",
          "type": "external"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "placeOrder",
          "target": "OrderService",
          "data": [
            "cartId",
            "shippingAddress",
            "paymentMethod"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "OrderService",
          "action": "validateCustomer",
          "target": "CustomerService",
          "data": [
            "customerId"
          ],
          "returns": "CustomerValidation"
        },
        {
          "step": 3,
          "actor": "OrderService",
          "action": "getCart",
          "target": "CartService",
          "data": [
            "cartId"
          ],
          "returns": "Cart"
        },
        {
          "step": 4,
          "actor": "OrderService",
          "action": "reserve",
          "target": "InventoryService",
          "data": [
            "items[]",
            "quantities[]"
          ],
          "returns": "ReservationResult",
          "event": "InventoryReserved"
        },
        {
          "step": 5,
          "actor": "OrderService",
          "action": "calculateShipping",
          "target": "OrderService",
          "data": [
            "subtotal",
            "shippingAddress"
          ],
          "returns": "shippingCost"
        },
        {
          "step": 6,
          "actor": "OrderService",
          "action": "authorizePayment",
          "target": "PaymentService",
          "data": [
            "totalAmount",
            "paymentMethod"
          ],
          "returns": "PaymentAuthorization"
        },
        {
          "step": 7,
          "actor": "PaymentService",
          "action": "authorize",
          "target": "PaymentGateway",
          "data": [
            "amount",
            "paymentDetails"
          ],
          "returns": "AuthorizationResult"
        },
        {
          "step": 8,
          "actor": "OrderService",
          "action": "create",
          "target": "Order",
          "data": [
            "customerId",
            "lineItems",
            "shippingAddress",
            "paymentMethod",
            "totalAmount"
          ],
          "returns": "Order",
          "event": "OrderPlaced"
        },
        {
          "step": 9,
          "actor": "OrderService",
          "action": "clear",
          "target": "CartService",
          "data": [
            "cartId"
          ],
          "returns": "void",
          "event": "CartCleared"
        },
        {
          "step": 10,
          "actor": "OrderService",
          "action": "return",
          "target": "Customer",
          "data": [
            "orderConfirmation",
            "orderId"
          ],
          "returns": "OrderConfirmation"
        }
      ],
      "outcome": {
        "success": "Order created, payment authorized, inventory reserved, cart cleared",
        "state_changes": [
          "Order.status = PENDING",
          "Inventory.reservedQuantity += orderQuantities",
          "Cart.items = []",
          "Cart.totalPrice = 0"
        ]
      },
      "exceptions": [
        {
          "condition": "Customer not registered",
          "step": 2,
          "handling": "Return REGISTRATION_REQUIRED error"
        },
        {
          "condition": "Customer email not verified",
          "step": 2,
          "handling": "Return EMAIL_NOT_VERIFIED error"
        },
        {
          "condition": "Cart is empty",
          "step": 3,
          "handling": "Return EMPTY_CART error"
        },
        {
          "condition": "Insufficient stock for one or more items",
          "step": 4,
          "handling": "Return INSUFFICIENT_STOCK error with affected items"
        },
        {
          "condition": "Payment authorization failed",
          "step": 7,
          "handling": "Return PAYMENT_FAILED error"
        },
        {
          "condition": "International shipping address",
          "step": 5,
          "handling": "Return INTERNATIONAL_SHIPPING_NOT_AVAILABLE error"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-AUTH-001",
        "BR-STOCK-001",
        "BR-INV-001",
        "BR-INV-002",
        "BR-PAY-001",
        "BR-SHIP-001",
        "BR-SHIP-002",
        "BR-PRICE-002",
        "BR-CUST-003"
      ]
    },
    {
      "id": "SEQ-ORDER-002",
      "name": "Confirm Order",
      "description": "System or admin confirms a pending order after payment capture",
      "trigger": {
        "type": "system_event",
        "description": "Payment capture confirmed by payment gateway webhook"
      },
      "participants": [
        {
          "name": "PaymentGateway",
          "type": "external"
        },
        {
          "name": "OrderService",
          "type": "service"
        },
        {
          "name": "Order",
          "type": "aggregate"
        },
        {
          "name": "AuditService",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "PaymentGateway",
          "action": "paymentCaptured",
          "target": "OrderService",
          "data": [
            "orderId",
            "transactionId",
            "capturedAmount"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "OrderService",
          "action": "getOrder",
          "target": "Order",
          "data": [
            "orderId"
          ],
          "returns": "Order"
        },
        {
          "step": 3,
          "actor": "OrderService",
          "action": "confirm",
          "target": "Order",
          "returns": "void",
          "event": "OrderConfirmed"
        },
        {
          "step": 4,
          "actor": "OrderService",
          "action": "logStatusChange",
          "target": "AuditService",
          "data": [
            "orderId",
            "previousStatus",
            "newStatus",
            "timestamp"
          ],
          "returns": "void"
        }
      ],
      "outcome": {
        "success": "Order status updated to CONFIRMED",
        "state_changes": [
          "Order.status = CONFIRMED"
        ]
      },
      "exceptions": [
        {
          "condition": "Order not in PENDING status",
          "step": 3,
          "handling": "Return INVALID_STATUS_TRANSITION error"
        },
        {
          "condition": "Order not found",
          "step": 2,
          "handling": "Log error, alert admin for manual review"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-ORDER-001",
        "BR-AUDIT-001"
      ]
    },
    {
      "id": "SEQ-ORDER-003",
      "name": "Ship Order",
      "description": "Fulfillment marks order as shipped with tracking information",
      "trigger": {
        "type": "user_action",
        "description": "Fulfillment staff marks order as shipped in admin system"
      },
      "participants": [
        {
          "name": "FulfillmentStaff",
          "type": "actor"
        },
        {
          "name": "OrderService",
          "type": "service"
        },
        {
          "name": "InventoryService",
          "type": "service"
        },
        {
          "name": "NotificationService",
          "type": "service"
        },
        {
          "name": "Order",
          "type": "aggregate"
        },
        {
          "name": "Inventory",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "FulfillmentStaff",
          "action": "shipOrder",
          "target": "OrderService",
          "data": [
            "orderId",
            "trackingNumber"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "OrderService",
          "action": "getOrder",
          "target": "Order",
          "data": [
            "orderId"
          ],
          "returns": "Order"
        },
        {
          "step": 3,
          "actor": "OrderService",
          "action": "deduct",
          "target": "InventoryService",
          "data": [
            "items[]",
            "quantities[]"
          ],
          "returns": "void",
          "event": "InventoryDeducted"
        },
        {
          "step": 4,
          "actor": "OrderService",
          "action": "ship",
          "target": "Order",
          "data": [
            "trackingNumber"
          ],
          "returns": "void",
          "event": "OrderShipped"
        },
        {
          "step": 5,
          "actor": "OrderService",
          "action": "sendShippingNotification",
          "target": "NotificationService",
          "data": [
            "customerId",
            "orderId",
            "trackingNumber"
          ],
          "returns": "void"
        }
      ],
      "outcome": {
        "success": "Order shipped, inventory deducted from reserved, customer notified",
        "state_changes": [
          "Order.status = SHIPPED",
          "Inventory.quantityOnHand -= orderQuantities",
          "Inventory.reservedQuantity -= orderQuantities"
        ]
      },
      "exceptions": [
        {
          "condition": "Order not in CONFIRMED status",
          "step": 4,
          "handling": "Return INVALID_STATUS_TRANSITION error"
        },
        {
          "condition": "Notification delivery failed",
          "step": 5,
          "handling": "Log for retry, order still shipped successfully"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-ORDER-001",
        "BR-ORDER-003",
        "BR-AUDIT-001"
      ]
    },
    {
      "id": "SEQ-ORDER-004",
      "name": "Deliver Order",
      "description": "System marks order as delivered based on carrier confirmation",
      "trigger": {
        "type": "system_event",
        "description": "Carrier webhook confirms delivery"
      },
      "participants": [
        {
          "name": "CarrierSystem",
          "type": "external"
        },
        {
          "name": "OrderService",
          "type": "service"
        },
        {
          "name": "NotificationService",
          "type": "service"
        },
        {
          "name": "Order",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "CarrierSystem",
          "action": "deliveryConfirmed",
          "target": "OrderService",
          "data": [
            "trackingNumber",
            "deliveryTimestamp"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "OrderService",
          "action": "findByTracking",
          "target": "Order",
          "data": [
            "trackingNumber"
          ],
          "returns": "Order"
        },
        {
          "step": 3,
          "actor": "OrderService",
          "action": "deliver",
          "target": "Order",
          "returns": "void",
          "event": "OrderDelivered"
        },
        {
          "step": 4,
          "actor": "OrderService",
          "action": "sendDeliveryNotification",
          "target": "NotificationService",
          "data": [
            "customerId",
            "orderId"
          ],
          "returns": "void"
        }
      ],
      "outcome": {
        "success": "Order status updated to DELIVERED, customer notified",
        "state_changes": [
          "Order.status = DELIVERED"
        ]
      },
      "exceptions": [
        {
          "condition": "Order not in SHIPPED status",
          "step": 3,
          "handling": "Log warning, may indicate duplicate webhook"
        },
        {
          "condition": "Order not found for tracking number",
          "step": 2,
          "handling": "Log error for manual review"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-ORDER-001",
        "BR-AUDIT-001"
      ]
    },
    {
      "id": "SEQ-ORDER-005",
      "name": "Cancel Order",
      "description": "Customer cancels an order before shipment with inventory restoration and refund",
      "trigger": {
        "type": "user_action",
        "description": "Customer clicks 'Cancel Order' button"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "OrderService",
          "type": "service"
        },
        {
          "name": "InventoryService",
          "type": "service"
        },
        {
          "name": "PaymentService",
          "type": "service"
        },
        {
          "name": "NotificationService",
          "type": "service"
        },
        {
          "name": "Order",
          "type": "aggregate"
        },
        {
          "name": "Inventory",
          "type": "aggregate"
        },
        {
          "name": "PaymentGateway",
          "type": "external"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "cancelOrder",
          "target": "OrderService",
          "data": [
            "orderId",
            "cancellationReason"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "OrderService",
          "action": "getOrder",
          "target": "Order",
          "data": [
            "orderId"
          ],
          "returns": "Order"
        },
        {
          "step": 3,
          "actor": "OrderService",
          "action": "validateCancellation",
          "target": "OrderService",
          "data": [
            "orderStatus"
          ],
          "returns": "boolean"
        },
        {
          "step": 4,
          "actor": "OrderService",
          "action": "cancel",
          "target": "Order",
          "data": [
            "cancellationReason"
          ],
          "returns": "void",
          "event": "OrderCancelled"
        },
        {
          "step": 5,
          "actor": "OrderService",
          "action": "release",
          "target": "InventoryService",
          "data": [
            "items[]",
            "quantities[]"
          ],
          "returns": "void",
          "event": "InventoryReleased"
        },
        {
          "step": 6,
          "actor": "OrderService",
          "action": "initiateRefund",
          "target": "PaymentService",
          "data": [
            "orderId",
            "totalAmount",
            "paymentMethod"
          ],
          "returns": "RefundResult"
        },
        {
          "step": 7,
          "actor": "PaymentService",
          "action": "refund",
          "target": "PaymentGateway",
          "data": [
            "transactionId",
            "amount"
          ],
          "returns": "RefundConfirmation"
        },
        {
          "step": 8,
          "actor": "OrderService",
          "action": "sendCancellationNotification",
          "target": "NotificationService",
          "data": [
            "customerId",
            "orderId",
            "refundAmount"
          ],
          "returns": "void"
        },
        {
          "step": 9,
          "actor": "OrderService",
          "action": "return",
          "target": "Customer",
          "data": [
            "cancellationConfirmation"
          ],
          "returns": "CancellationConfirmation"
        }
      ],
      "outcome": {
        "success": "Order cancelled, inventory restored, refund initiated, customer notified",
        "state_changes": [
          "Order.status = CANCELLED",
          "Inventory.reservedQuantity -= orderQuantities"
        ]
      },
      "exceptions": [
        {
          "condition": "Order already shipped",
          "step": 3,
          "handling": "Return CANCELLATION_NOT_ALLOWED error"
        },
        {
          "condition": "Refund failed",
          "step": 7,
          "handling": "Log for manual processing, order still cancelled"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-CANCEL-001",
        "BR-INV-003",
        "BR-PAY-002",
        "BR-ORDER-001"
      ]
    },
    {
      "id": "SEQ-CUST-001",
      "name": "Customer Registration",
      "description": "New user registers an account with email verification",
      "trigger": {
        "type": "user_action",
        "description": "User submits registration form"
      },
      "participants": [
        {
          "name": "User",
          "type": "actor"
        },
        {
          "name": "CustomerService",
          "type": "service"
        },
        {
          "name": "NotificationService",
          "type": "service"
        },
        {
          "name": "Customer",
          "type": "aggregate"
        },
        {
          "name": "Cart",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "User",
          "action": "register",
          "target": "CustomerService",
          "data": [
            "email",
            "password"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "CustomerService",
          "action": "validateEmail",
          "target": "CustomerService",
          "data": [
            "email"
          ],
          "returns": "boolean"
        },
        {
          "step": 3,
          "actor": "CustomerService",
          "action": "validatePassword",
          "target": "CustomerService",
          "data": [
            "password"
          ],
          "returns": "boolean"
        },
        {
          "step": 4,
          "actor": "CustomerService",
          "action": "register",
          "target": "Customer",
          "data": [
            "email",
            "hashedPassword"
          ],
          "returns": "Customer",
          "event": "CustomerRegistered"
        },
        {
          "step": 5,
          "actor": "CustomerService",
          "action": "create",
          "target": "Cart",
          "data": [
            "customerId"
          ],
          "returns": "Cart"
        },
        {
          "step": 6,
          "actor": "CustomerService",
          "action": "sendVerificationEmail",
          "target": "NotificationService",
          "data": [
            "email",
            "verificationToken"
          ],
          "returns": "void"
        },
        {
          "step": 7,
          "actor": "CustomerService",
          "action": "return",
          "target": "User",
          "data": [
            "registrationConfirmation"
          ],
          "returns": "RegistrationResult"
        }
      ],
      "outcome": {
        "success": "Customer account created, cart initialized, verification email sent",
        "state_changes": [
          "Customer created with status REGISTERED",
          "Customer.emailVerified = false",
          "Cart created for customer"
        ]
      },
      "exceptions": [
        {
          "condition": "Email already registered",
          "step": 2,
          "handling": "Return EMAIL_ALREADY_REGISTERED error"
        },
        {
          "condition": "Password too weak",
          "step": 3,
          "handling": "Return WEAK_PASSWORD error with requirements"
        },
        {
          "condition": "Verification email failed to send",
          "step": 6,
          "handling": "Log for retry, account still created"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-CUST-001",
        "BR-CUST-002",
        "BR-CUST-003"
      ]
    },
    {
      "id": "SEQ-INV-001",
      "name": "Restock Inventory",
      "description": "Admin restocks product inventory with audit logging",
      "trigger": {
        "type": "user_action",
        "description": "Admin enters restock quantity in inventory management"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "InventoryService",
          "type": "service"
        },
        {
          "name": "AuditService",
          "type": "service"
        },
        {
          "name": "Inventory",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "restock",
          "target": "InventoryService",
          "data": [
            "productId",
            "quantity",
            "reason"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "InventoryService",
          "action": "getInventory",
          "target": "Inventory",
          "data": [
            "productId"
          ],
          "returns": "Inventory"
        },
        {
          "step": 3,
          "actor": "InventoryService",
          "action": "restock",
          "target": "Inventory",
          "data": [
            "quantity"
          ],
          "returns": "void",
          "event": "InventoryRestocked"
        },
        {
          "step": 4,
          "actor": "InventoryService",
          "action": "logInventoryChange",
          "target": "AuditService",
          "data": [
            "productId",
            "previousQuantity",
            "newQuantity",
            "reason",
            "operator"
          ],
          "returns": "void"
        },
        {
          "step": 5,
          "actor": "InventoryService",
          "action": "return",
          "target": "Admin",
          "data": [
            "updatedInventory"
          ],
          "returns": "Inventory"
        }
      ],
      "outcome": {
        "success": "Inventory quantity increased, audit trail recorded",
        "state_changes": [
          "Inventory.quantityOnHand += restockQuantity"
        ]
      },
      "exceptions": [
        {
          "condition": "Invalid quantity (negative or zero)",
          "step": 3,
          "handling": "Return validation error"
        },
        {
          "condition": "Product not found",
          "step": 2,
          "handling": "Return PRODUCT_NOT_FOUND error"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-AUDIT-002"
      ]
    },
    {
      "id": "SEQ-PROD-001",
      "name": "Create Product",
      "description": "Admin creates a new product with inventory initialization",
      "trigger": {
        "type": "user_action",
        "description": "Admin submits new product form"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "ProductService",
          "type": "service"
        },
        {
          "name": "InventoryService",
          "type": "service"
        },
        {
          "name": "Product",
          "type": "aggregate"
        },
        {
          "name": "Inventory",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "createProduct",
          "target": "ProductService",
          "data": [
            "name",
            "description",
            "price",
            "categoryId",
            "initialStock"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "ProductService",
          "action": "validateProduct",
          "target": "ProductService",
          "data": [
            "name",
            "description",
            "price"
          ],
          "returns": "boolean"
        },
        {
          "step": 3,
          "actor": "ProductService",
          "action": "create",
          "target": "Product",
          "data": [
            "name",
            "description",
            "price",
            "categoryId"
          ],
          "returns": "Product",
          "event": "ProductCreated"
        },
        {
          "step": 4,
          "actor": "ProductService",
          "action": "initializeInventory",
          "target": "InventoryService",
          "data": [
            "productId",
            "initialStock"
          ],
          "returns": "Inventory"
        },
        {
          "step": 5,
          "actor": "ProductService",
          "action": "return",
          "target": "Admin",
          "data": [
            "createdProduct"
          ],
          "returns": "Product"
        }
      ],
      "outcome": {
        "success": "Product created with inventory initialized",
        "state_changes": [
          "Product created with isActive = true",
          "Inventory created with quantityOnHand = initialStock"
        ]
      },
      "exceptions": [
        {
          "condition": "Price below minimum",
          "step": 2,
          "handling": "Return INVALID_PRICE error"
        },
        {
          "condition": "Name too short or too long",
          "step": 2,
          "handling": "Return INVALID_PRODUCT_NAME error"
        },
        {
          "condition": "Description too long",
          "step": 2,
          "handling": "Return DESCRIPTION_TOO_LONG error"
        },
        {
          "condition": "Category not found",
          "step": 3,
          "handling": "Return CATEGORY_NOT_FOUND error"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-PRICE-001",
        "BR-PROD-002",
        "BR-PROD-003"
      ]
    },
    {
      "id": "SEQ-PROD-002",
      "name": "Update Product Price",
      "description": "Admin updates product price with audit tracking",
      "trigger": {
        "type": "user_action",
        "description": "Admin changes price in product management"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "ProductService",
          "type": "service"
        },
        {
          "name": "AuditService",
          "type": "service"
        },
        {
          "name": "Product",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "updatePrice",
          "target": "ProductService",
          "data": [
            "productId",
            "newPrice"
          ],
          "returns": "void"
        },
        {
          "step": 2,
          "actor": "ProductService",
          "action": "getProduct",
          "target": "Product",
          "data": [
            "productId"
          ],
          "returns": "Product"
        },
        {
          "step": 3,
          "actor": "ProductService",
          "action": "validatePrice",
          "target": "ProductService",
          "data": [
            "newPrice"
          ],
          "returns": "boolean"
        },
        {
          "step": 4,
          "actor": "ProductService",
          "action": "update",
          "target": "Product",
          "data": [
            "price"
          ],
          "returns": "void",
          "event": "ProductUpdated"
        },
        {
          "step": 5,
          "actor": "ProductService",
          "action": "logPriceChange",
          "target": "AuditService",
          "data": [
            "productId",
            "previousPrice",
            "newPrice",
            "modifier",
            "timestamp"
          ],
          "returns": "void"
        },
        {
          "step": 6,
          "actor": "ProductService",
          "action": "return",
          "target": "Admin",
          "data": [
            "updatedProduct"
          ],
          "returns": "Product"
        }
      ],
      "outcome": {
        "success": "Product price updated, cart prices will reflect change on next view",
        "state_changes": [
          "Product.price = newPrice"
        ]
      },
      "exceptions": [
        {
          "condition": "Price below minimum",
          "step": 3,
          "handling": "Return INVALID_PRICE error"
        },
        {
          "condition": "Product not found",
          "step": 2,
          "handling": "Return PRODUCT_NOT_FOUND error"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-PRICE-001",
        "BR-AUDIT-003",
        "BR-CART-001"
      ]
    },
    {
      "id": "SEQ-NOTIF-001",
      "name": "Order Shipped Notification",
      "description": "System sends shipping notification when order is shipped",
      "trigger": {
        "type": "system_event",
        "description": "OrderShipped event emitted"
      },
      "participants": [
        {
          "name": "OrderService",
          "type": "service"
        },
        {
          "name": "NotificationHandler",
          "type": "service"
        },
        {
          "name": "CustomerService",
          "type": "service"
        },
        {
          "name": "EmailService",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "OrderService",
          "action": "emit",
          "target": "NotificationHandler",
          "data": [
            "OrderShipped event"
          ],
          "returns": "void",
          "event": "OrderShipped"
        },
        {
          "step": 2,
          "actor": "NotificationHandler",
          "action": "getCustomerEmail",
          "target": "CustomerService",
          "data": [
            "customerId"
          ],
          "returns": "email"
        },
        {
          "step": 3,
          "actor": "NotificationHandler",
          "action": "sendShippingNotification",
          "target": "EmailService",
          "data": [
            "email",
            "orderId",
            "trackingNumber",
            "estimatedDelivery"
          ],
          "returns": "void"
        },
        {
          "step": 4,
          "actor": "NotificationHandler",
          "action": "logNotificationSent",
          "target": "NotificationHandler",
          "data": [
            "orderId",
            "notificationType",
            "timestamp"
          ],
          "returns": "void"
        }
      ],
      "outcome": {
        "success": "Customer receives shipping notification with tracking info",
        "state_changes": []
      },
      "exceptions": [
        {
          "condition": "Email delivery failed",
          "step": 3,
          "handling": "Retry 3 times with exponential backoff, then log for manual review"
        },
        {
          "condition": "Customer email not found",
          "step": 2,
          "handling": "Log error, skip notification"
        }
      ],
      "relatedACs": [],
      "relatedBRs": []
    },
    {
      "id": "SEQ-INV-002",
      "name": "Out of Stock Alert",
      "description": "System detects out of stock condition and alerts relevant parties",
      "trigger": {
        "type": "system_event",
        "description": "Inventory available quantity reaches zero"
      },
      "participants": [
        {
          "name": "InventoryService",
          "type": "service"
        },
        {
          "name": "NotificationService",
          "type": "service"
        },
        {
          "name": "ProductService",
          "type": "service"
        },
        {
          "name": "Inventory",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "InventoryService",
          "action": "checkStock",
          "target": "Inventory",
          "data": [
            "productId"
          ],
          "returns": "availableQuantity"
        },
        {
          "step": 2,
          "actor": "InventoryService",
          "action": "emit",
          "target": "InventoryService",
          "data": [
            "productId"
          ],
          "returns": "void",
          "event": "OutOfStock"
        },
        {
          "step": 3,
          "actor": "InventoryService",
          "action": "sendOutOfStockAlert",
          "target": "NotificationService",
          "data": [
            "productId",
            "productName"
          ],
          "returns": "void"
        }
      ],
      "outcome": {
        "success": "Out of stock condition detected and admin alerted",
        "state_changes": []
      },
      "exceptions": [
        {
          "condition": "Alert delivery failed",
          "step": 3,
          "handling": "Queue for retry"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-STOCK-001"
      ]
    }
  ],
  "shared_types": [
    {
      "name": "Money",
      "fields": [
        {
          "name": "amount",
          "type": "decimal",
          "constraints": "Precision 2 decimal places"
        },
        {
          "name": "currency",
          "type": "string",
          "constraints": "ISO 4217 code, default USD"
        }
      ]
    },
    {
      "name": "ShippingAddress",
      "fields": [
        {
          "name": "street",
          "type": "string",
          "constraints": "Required, 1-200 characters"
        },
        {
          "name": "city",
          "type": "string",
          "constraints": "Required, 1-100 characters"
        },
        {
          "name": "state",
          "type": "string",
          "constraints": "Required, 2-100 characters"
        },
        {
          "name": "postalCode",
          "type": "string",
          "constraints": "Required, valid postal format"
        },
        {
          "name": "country",
          "type": "string",
          "constraints": "Required, ISO 3166 code"
        },
        {
          "name": "recipientName",
          "type": "string",
          "constraints": "Required"
        }
      ]
    },
    {
      "name": "PaymentMethod",
      "fields": [
        {
          "name": "paymentMethodId",
          "type": "PaymentMethodId",
          "constraints": "UUID"
        },
        {
          "name": "type",
          "type": "PaymentType",
          "constraints": "CREDIT_CARD or PAYPAL"
        },
        {
          "name": "lastFourDigits",
          "type": "string",
          "constraints": "4 digits, required for CREDIT_CARD"
        },
        {
          "name": "expiryMonth",
          "type": "integer",
          "constraints": "1-12, required for CREDIT_CARD"
        },
        {
          "name": "expiryYear",
          "type": "integer",
          "constraints": "Required for CREDIT_CARD"
        },
        {
          "name": "paypalEmail",
          "type": "Email",
          "constraints": "Required for PAYPAL"
        },
        {
          "name": "isDefault",
          "type": "boolean",
          "constraints": ""
        }
      ]
    },
    {
      "name": "Email",
      "fields": [
        {
          "name": "value",
          "type": "string",
          "constraints": "Valid email format per RFC 5322"
        }
      ]
    },
    {
      "name": "OrderStatus",
      "fields": [
        {
          "name": "value",
          "type": "enum",
          "constraints": "PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED"
        }
      ]
    },
    {
      "name": "RegistrationStatus",
      "fields": [
        {
          "name": "value",
          "type": "enum",
          "constraints": "REGISTERED, UNREGISTERED"
        }
      ]
    },
    {
      "name": "PaymentType",
      "fields": [
        {
          "name": "value",
          "type": "enum",
          "constraints": "CREDIT_CARD, PAYPAL"
        }
      ]
    },
    {
      "name": "ProductStatus",
      "fields": [
        {
          "name": "value",
          "type": "enum",
          "constraints": "DRAFT, ACTIVE, INACTIVE"
        }
      ]
    },
    {
      "name": "StockStatus",
      "fields": [
        {
          "name": "value",
          "type": "enum",
          "constraints": "IN_STOCK, LOW_STOCK, OUT_OF_STOCK"
        }
      ]
    },
    {
      "name": "SortOption",
      "fields": [
        {
          "name": "value",
          "type": "enum",
          "constraints": "NAME_ASC, NAME_DESC, PRICE_ASC, PRICE_DESC, NEWEST"
        }
      ]
    },
    {
      "name": "DeleteType",
      "fields": [
        {
          "name": "value",
          "type": "enum",
          "constraints": "SOFT_DELETE, FULL_ERASURE"
        }
      ]
    },
    {
      "name": "CartItem",
      "fields": [
        {
          "name": "cartItemId",
          "type": "CartItemId",
          "constraints": "UUID"
        },
        {
          "name": "productId",
          "type": "ProductId",
          "constraints": "UUID"
        },
        {
          "name": "variantId",
          "type": "VariantId",
          "constraints": "UUID, optional"
        },
        {
          "name": "productName",
          "type": "string",
          "constraints": "Snapshot at time of add"
        },
        {
          "name": "unitPrice",
          "type": "Money",
          "constraints": "Current price"
        },
        {
          "name": "quantity",
          "type": "integer",
          "constraints": "\u003e= 1"
        },
        {
          "name": "subtotal",
          "type": "Money",
          "constraints": "unitPrice * quantity"
        }
      ]
    },
    {
      "name": "OrderLineItem",
      "fields": [
        {
          "name": "lineItemId",
          "type": "LineItemId",
          "constraints": "UUID"
        },
        {
          "name": "productId",
          "type": "ProductId",
          "constraints": "UUID"
        },
        {
          "name": "productName",
          "type": "string",
          "constraints": "Snapshot at order time"
        },
        {
          "name": "unitPrice",
          "type": "Money",
          "constraints": "Snapshot at order time"
        },
        {
          "name": "quantity",
          "type": "integer",
          "constraints": "\u003e= 1"
        },
        {
          "name": "subtotal",
          "type": "Money",
          "constraints": "unitPrice * quantity"
        }
      ]
    },
    {
      "name": "ProductSummary",
      "fields": [
        {
          "name": "productId",
          "type": "ProductId",
          "constraints": "UUID"
        },
        {
          "name": "name",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "price",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "categoryId",
          "type": "CategoryId",
          "constraints": ""
        },
        {
          "name": "primaryImageUrl",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "stockStatus",
          "type": "StockStatus",
          "constraints": ""
        }
      ]
    },
    {
      "name": "OrderSummary",
      "fields": [
        {
          "name": "orderId",
          "type": "OrderId",
          "constraints": "UUID"
        },
        {
          "name": "orderNumber",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "customerId",
          "type": "CustomerId",
          "constraints": ""
        },
        {
          "name": "status",
          "type": "OrderStatus",
          "constraints": ""
        },
        {
          "name": "totalAmount",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "createdAt",
          "type": "DateTime",
          "constraints": ""
        }
      ]
    }
  ],
  "tables": [
    {
      "id": "TBL-CUSTOMER-001",
      "name": "customers",
      "aggregate": "Customer",
      "purpose": "Stores registered customers who can browse products and place orders",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "email",
          "type": "VARCHAR(255)",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "password_hash",
          "type": "VARCHAR(255)",
          "constraints": "NOT NULL"
        },
        {
          "name": "registration_status",
          "type": "registration_status_enum",
          "constraints": "NOT NULL DEFAULT 'REGISTERED'"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL DEFAULT 1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_customers_email",
          "columns": [
            "email"
          ]
        }
      ],
      "foreignKeys": [],
      "checkConstraints": []
    },
    {
      "id": "TBL-CART-001",
      "name": "carts",
      "aggregate": "Cart",
      "purpose": "Holds products a customer intends to purchase before checkout",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "customer_id",
          "type": "UUID",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "total_price_amount",
          "type": "DECIMAL(12,2)",
          "constraints": "NOT NULL DEFAULT 0"
        },
        {
          "name": "total_price_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL DEFAULT 'USD'"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL DEFAULT 1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_carts_customer_id",
          "columns": [
            "customer_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "customer_id"
          ],
          "references": "customers(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_cart_total_price_non_negative",
          "expression": "total_price_amount \u003e= 0"
        }
      ]
    },
    {
      "id": "TBL-CARTITEM-001",
      "name": "cart_items",
      "aggregate": "Cart",
      "purpose": "Represents a product and quantity within a shopping cart",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "cart_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "product_name",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "unit_price_amount",
          "type": "DECIMAL(12,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "unit_price_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL DEFAULT 'USD'"
        },
        {
          "name": "quantity",
          "type": "INTEGER",
          "constraints": "NOT NULL"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_cart_items_cart_id",
          "columns": [
            "cart_id"
          ]
        },
        {
          "name": "idx_cart_items_cart_product",
          "columns": [
            "cart_id",
            "product_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "cart_id"
          ],
          "references": "carts(id)",
          "onDelete": "CASCADE"
        },
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_cart_item_quantity_positive",
          "expression": "quantity \u003e= 1"
        },
        {
          "name": "chk_cart_item_price_positive",
          "expression": "unit_price_amount \u003e= 0"
        }
      ]
    },
    {
      "id": "TBL-ORDER-001",
      "name": "orders",
      "aggregate": "Order",
      "purpose": "Represents a customer's purchase transaction with shipping and payment details",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "customer_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "status",
          "type": "order_status_enum",
          "constraints": "NOT NULL DEFAULT 'PENDING'"
        },
        {
          "name": "shipping_street",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_city",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_state",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_postal_code",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_country",
          "type": "CHAR(2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "payment_type",
          "type": "payment_type_enum",
          "constraints": "NOT NULL"
        },
        {
          "name": "payment_last_four_digits",
          "type": "CHAR(4)",
          "constraints": "NULL"
        },
        {
          "name": "payment_expiry_month",
          "type": "SMALLINT",
          "constraints": "NULL"
        },
        {
          "name": "payment_expiry_year",
          "type": "SMALLINT",
          "constraints": "NULL"
        },
        {
          "name": "payment_paypal_email",
          "type": "VARCHAR(255)",
          "constraints": "NULL"
        },
        {
          "name": "subtotal_amount",
          "type": "DECIMAL(12,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "subtotal_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL DEFAULT 'USD'"
        },
        {
          "name": "shipping_cost_amount",
          "type": "DECIMAL(12,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_cost_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL DEFAULT 'USD'"
        },
        {
          "name": "total_amount",
          "type": "DECIMAL(12,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "total_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL DEFAULT 'USD'"
        },
        {
          "name": "tracking_number",
          "type": "VARCHAR(100)",
          "constraints": "NULL"
        },
        {
          "name": "cancellation_reason",
          "type": "TEXT",
          "constraints": "NULL"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL DEFAULT 1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_orders_customer_id",
          "columns": [
            "customer_id"
          ]
        },
        {
          "name": "idx_orders_status",
          "columns": [
            "status"
          ]
        },
        {
          "name": "idx_orders_created_at",
          "columns": [
            "created_at"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "customer_id"
          ],
          "references": "customers(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_order_subtotal_non_negative",
          "expression": "subtotal_amount \u003e= 0"
        },
        {
          "name": "chk_order_shipping_non_negative",
          "expression": "shipping_cost_amount \u003e= 0"
        },
        {
          "name": "chk_order_total_non_negative",
          "expression": "total_amount \u003e= 0"
        },
        {
          "name": "chk_payment_expiry_month",
          "expression": "payment_expiry_month IS NULL OR (payment_expiry_month \u003e= 1 AND payment_expiry_month \u003c= 12)"
        }
      ]
    },
    {
      "id": "TBL-ORDERLINEITEM-001",
      "name": "order_line_items",
      "aggregate": "Order",
      "purpose": "Immutable snapshot of a product at time of order with quantity and pricing",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "order_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "product_name",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "unit_price_amount",
          "type": "DECIMAL(12,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "unit_price_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL DEFAULT 'USD'"
        },
        {
          "name": "quantity",
          "type": "INTEGER",
          "constraints": "NOT NULL"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_order_line_items_order_id",
          "columns": [
            "order_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "order_id"
          ],
          "references": "orders(id)",
          "onDelete": "CASCADE"
        },
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_line_item_quantity_positive",
          "expression": "quantity \u003e= 1"
        },
        {
          "name": "chk_line_item_price_positive",
          "expression": "unit_price_amount \u003e= 0"
        }
      ]
    },
    {
      "id": "TBL-PRODUCT-001",
      "name": "products",
      "aggregate": "Product",
      "purpose": "Represents an item available for sale in the store",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "name",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "description",
          "type": "VARCHAR(5000)",
          "constraints": "NULL"
        },
        {
          "name": "price_amount",
          "type": "DECIMAL(12,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "price_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL DEFAULT 'USD'"
        },
        {
          "name": "category_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "is_active",
          "type": "BOOLEAN",
          "constraints": "NOT NULL DEFAULT TRUE"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL DEFAULT 1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_products_category_id",
          "columns": [
            "category_id"
          ]
        },
        {
          "name": "idx_products_is_active",
          "columns": [
            "is_active"
          ]
        },
        {
          "name": "idx_products_name",
          "columns": [
            "name"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "category_id"
          ],
          "references": "categories(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_product_price_positive",
          "expression": "price_amount \u003e 0"
        },
        {
          "name": "chk_product_name_length",
          "expression": "LENGTH(name) \u003e= 1"
        }
      ]
    },
    {
      "id": "TBL-PRODUCTVARIANT-001",
      "name": "product_variants",
      "aggregate": "Product",
      "purpose": "Represents a specific variation of a product (e.g., size, color combination)",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "sku",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "size",
          "type": "VARCHAR(50)",
          "constraints": "NULL"
        },
        {
          "name": "color",
          "type": "VARCHAR(50)",
          "constraints": "NULL"
        },
        {
          "name": "price_adjustment_amount",
          "type": "DECIMAL(12,2)",
          "constraints": "NULL DEFAULT 0"
        },
        {
          "name": "price_adjustment_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL DEFAULT 'USD'"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_product_variants_product_id",
          "columns": [
            "product_id"
          ]
        },
        {
          "name": "idx_product_variants_sku",
          "columns": [
            "sku"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_variant_has_attribute",
          "expression": "size IS NOT NULL OR color IS NOT NULL"
        }
      ]
    },
    {
      "id": "TBL-CATEGORY-001",
      "name": "categories",
      "aggregate": "Category",
      "purpose": "Organizes products into browsable groupings",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "name",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "description",
          "type": "TEXT",
          "constraints": "NULL"
        },
        {
          "name": "parent_category_id",
          "type": "UUID",
          "constraints": "NULL"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL DEFAULT 1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_categories_name",
          "columns": [
            "name"
          ]
        },
        {
          "name": "idx_categories_parent_id",
          "columns": [
            "parent_category_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "parent_category_id"
          ],
          "references": "categories(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_category_not_self_parent",
          "expression": "id != parent_category_id"
        },
        {
          "name": "chk_category_name_length",
          "expression": "LENGTH(name) \u003e= 1"
        }
      ]
    },
    {
      "id": "TBL-INVENTORY-001",
      "name": "inventory",
      "aggregate": "Inventory",
      "purpose": "Tracks stock levels for products and manages availability",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "PRIMARY KEY"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "quantity_on_hand",
          "type": "INTEGER",
          "constraints": "NOT NULL DEFAULT 0"
        },
        {
          "name": "reserved_quantity",
          "type": "INTEGER",
          "constraints": "NOT NULL DEFAULT 0"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL DEFAULT 1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL DEFAULT NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_inventory_product_id",
          "columns": [
            "product_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_inventory_quantity_non_negative",
          "expression": "quantity_on_hand \u003e= 0"
        },
        {
          "name": "chk_inventory_reserved_non_negative",
          "expression": "reserved_quantity \u003e= 0"
        },
        {
          "name": "chk_inventory_reserved_valid",
          "expression": "reserved_quantity \u003c= quantity_on_hand"
        }
      ]
    }
  ],
  "tech_specs": [
    {
      "id": "TS-BR-AUTH-001",
      "name": "Customer registration and email verification for orders",
      "br_ref": "BR-AUTH-001",
      "rule": "Only registered customers with verified email addresses can place orders",
      "implementation": "Guard clause in checkout service validates Customer exists and emailVerified=true before order creation",
      "validation_points": [
        "POST /orders API endpoint",
        "CheckoutService.placeOrder()",
        "OrderAggregate.create()"
      ],
      "data_requirements": [
        {
          "field": "customerId",
          "type": "UUID",
          "constraints": "NOT NULL, FK to customers",
          "source": "Session/Auth context"
        },
        {
          "field": "emailVerified",
          "type": "boolean",
          "constraints": "must be true",
          "source": "Customer aggregate"
        }
      ],
      "error_handling": [
        {
          "condition": "Customer not found or not authenticated",
          "error_code": "REGISTRATION_REQUIRED",
          "message": "You must be registered to place an order",
          "http_status": 401
        },
        {
          "condition": "emailVerified = false",
          "error_code": "EMAIL_NOT_VERIFIED",
          "message": "Please verify your email before placing an order",
          "http_status": 403
        }
      ],
      "related_acs": [
        "AC-AUTH-001"
      ]
    },
    {
      "id": "TS-BR-STOCK-001",
      "name": "Stock availability validation for cart additions",
      "br_ref": "BR-STOCK-001",
      "rule": "Products must have available inventory to be added to cart",
      "implementation": "Check Inventory.availableStock \u003e 0 on add-to-cart; allow cart items with stock warnings but block checkout if unavailable",
      "validation_points": [
        "POST /cart/items API",
        "CartService.addItem()",
        "CheckoutService.validateCart()"
      ],
      "data_requirements": [
        {
          "field": "availableStock",
          "type": "integer",
          "constraints": "\u003e= 0",
          "source": "Inventory aggregate"
        },
        {
          "field": "productId",
          "type": "UUID",
          "constraints": "NOT NULL",
          "source": "Request payload"
        },
        {
          "field": "variantId",
          "type": "UUID",
          "constraints": "NULL if no variants",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "availableStock = 0",
          "error_code": "OUT_OF_STOCK",
          "message": "This product is currently out of stock",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-STOCK-001"
      ]
    },
    {
      "id": "TS-BR-SHIP-001",
      "name": "Free shipping threshold calculation",
      "br_ref": "BR-SHIP-001",
      "rule": "Orders with subtotal of $50 or more qualify for free shipping",
      "implementation": "ShippingCalculator checks order.subtotal \u003e= 50.00; if true, set shippingCost = 0; else shippingCost = 5.99",
      "validation_points": [
        "ShippingService.calculateShipping()",
        "CheckoutService.calculateTotals()",
        "Cart summary display"
      ],
      "data_requirements": [
        {
          "field": "subtotal",
          "type": "decimal(10,2)",
          "constraints": "\u003e= 0",
          "source": "Calculated from cart/order items after discounts"
        },
        {
          "field": "shippingCost",
          "type": "decimal(10,2)",
          "constraints": "0.00 or 5.99",
          "source": "Calculated field"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-SHIP-001"
      ]
    },
    {
      "id": "TS-BR-CANCEL-001",
      "name": "Order cancellation status validation",
      "br_ref": "BR-CANCEL-001",
      "rule": "Orders can only be cancelled while in pending or confirmed status",
      "implementation": "Guard clause in cancel operation checks order.status IN ('pending', 'confirmed') before allowing transition to 'cancelled'",
      "validation_points": [
        "POST /orders/{id}/cancel API",
        "OrderService.cancelOrder()",
        "Order.cancel()"
      ],
      "data_requirements": [
        {
          "field": "status",
          "type": "OrderStatus enum",
          "constraints": "pending|confirmed|shipped|delivered|cancelled",
          "source": "Order aggregate"
        }
      ],
      "error_handling": [
        {
          "condition": "status NOT IN ('pending', 'confirmed')",
          "error_code": "CANCELLATION_NOT_ALLOWED",
          "message": "This order cannot be cancelled as it has already been shipped",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-CANCEL-001"
      ]
    },
    {
      "id": "TS-BR-PRICE-001",
      "name": "Minimum product price enforcement",
      "br_ref": "BR-PRICE-001",
      "rule": "Product price must be at least $0.01",
      "implementation": "Validate price \u003e= 0.01 with exactly 2 decimal places on product create/update",
      "validation_points": [
        "POST /products API",
        "PUT /products/{id} API",
        "ProductService.createProduct()",
        "ProductService.updateProduct()",
        "DB CHECK constraint"
      ],
      "data_requirements": [
        {
          "field": "price",
          "type": "decimal(10,2)",
          "constraints": "\u003e= 0.01",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "price \u003c 0.01",
          "error_code": "INVALID_PRICE",
          "message": "Product price must be at least $0.01",
          "http_status": 400
        },
        {
          "condition": "price has more than 2 decimal places",
          "error_code": "INVALID_PRICE",
          "message": "Price must have exactly 2 decimal places",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-PRICE-001"
      ]
    },
    {
      "id": "TS-BR-PRICE-002",
      "name": "Order price snapshot on placement",
      "br_ref": "BR-PRICE-002",
      "rule": "Order items must capture prices at the time of order placement",
      "implementation": "Copy current Product.price to OrderItem.unitPrice at order creation; OrderItem.price is immutable after creation",
      "validation_points": [
        "OrderService.placeOrder()",
        "OrderItem.create()",
        "DB: no UPDATE on orderItems.unitPrice"
      ],
      "data_requirements": [
        {
          "field": "unitPrice",
          "type": "decimal(10,2)",
          "constraints": "immutable after creation",
          "source": "Product.price at order time"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-PRICE-002"
      ]
    },
    {
      "id": "TS-BR-CART-001",
      "name": "Cart real-time price calculation",
      "br_ref": "BR-CART-001",
      "rule": "Cart items always reflect current product prices",
      "implementation": "Cart.total calculated by joining to current Product.price on every cart retrieval; show price change notifications if price differs from when added",
      "validation_points": [
        "GET /cart API",
        "CartService.getCart()",
        "Cart view rendering"
      ],
      "data_requirements": [
        {
          "field": "priceAtAdd",
          "type": "decimal(10,2)",
          "constraints": "optional, for change detection",
          "source": "Snapshot at add time"
        },
        {
          "field": "currentPrice",
          "type": "decimal(10,2)",
          "constraints": "fetched from Product",
          "source": "Product aggregate"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-CART-001"
      ]
    },
    {
      "id": "TS-BR-INV-001",
      "name": "Non-negative inventory constraint",
      "br_ref": "BR-INV-001",
      "rule": "Inventory stock level must never be negative",
      "implementation": "DB CHECK constraint on availableStock \u003e= 0; all inventory adjustments use atomic decrement with stock check",
      "validation_points": [
        "InventoryService.adjustStock()",
        "OrderService.placeOrder()",
        "DB CHECK(availableStock \u003e= 0)"
      ],
      "data_requirements": [
        {
          "field": "availableStock",
          "type": "integer",
          "constraints": "\u003e= 0, NOT NULL",
          "source": "Inventory aggregate"
        }
      ],
      "error_handling": [
        {
          "condition": "Adjustment would result in negative stock",
          "error_code": "INSUFFICIENT_STOCK",
          "message": "Insufficient stock to complete this operation",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-INV-001"
      ]
    },
    {
      "id": "TS-BR-INV-002",
      "name": "Backorder prevention",
      "br_ref": "BR-INV-002",
      "rule": "Orders cannot be placed for quantities exceeding available stock",
      "implementation": "Atomic check-and-decrement at checkout: SELECT FOR UPDATE inventory, verify each item.quantity \u003c= availableStock, then decrement",
      "validation_points": [
        "CheckoutService.placeOrder()",
        "InventoryService.reserveStock()",
        "DB transaction with row locks"
      ],
      "data_requirements": [
        {
          "field": "requestedQuantity",
          "type": "integer",
          "constraints": "\u003e 0",
          "source": "OrderItem"
        },
        {
          "field": "availableStock",
          "type": "integer",
          "constraints": "\u003e= 0",
          "source": "Inventory aggregate"
        }
      ],
      "error_handling": [
        {
          "condition": "requestedQuantity \u003e availableStock",
          "error_code": "BACKORDER_NOT_SUPPORTED",
          "message": "Cannot order more items than currently in stock",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-INV-002"
      ]
    },
    {
      "id": "TS-BR-INV-003",
      "name": "Inventory restoration on order cancellation",
      "br_ref": "BR-INV-003",
      "rule": "Cancelled orders must automatically restore inventory",
      "implementation": "Order cancellation triggers InventoryService.restoreStock() for each OrderItem in same transaction",
      "validation_points": [
        "OrderService.cancelOrder()",
        "InventoryService.restoreStock()",
        "DB transaction atomicity"
      ],
      "data_requirements": [
        {
          "field": "orderItems",
          "type": "OrderItem[]",
          "constraints": "quantity and productId/variantId",
          "source": "Order aggregate"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-INV-003"
      ]
    },
    {
      "id": "TS-BR-ORDER-001",
      "name": "Order state machine transitions",
      "br_ref": "BR-ORDER-001",
      "rule": "Orders must follow defined state machine transitions",
      "implementation": "State machine in Order aggregate with allowed transitions map; validate transition before applying",
      "validation_points": [
        "Order.transitionTo()",
        "OrderService.updateStatus()",
        "PUT /orders/{id}/status API"
      ],
      "data_requirements": [
        {
          "field": "status",
          "type": "OrderStatus enum",
          "constraints": "pending|confirmed|shipped|delivered|cancelled",
          "source": "Order aggregate"
        },
        {
          "field": "allowedTransitions",
          "type": "Map\u003cStatus, Status[]\u003e",
          "constraints": "pending[confirmed,cancelled], confirmed[shipped,cancelled], shipped[delivered]",
          "source": "Domain logic"
        }
      ],
      "error_handling": [
        {
          "condition": "Requested transition not in allowed transitions",
          "error_code": "INVALID_STATUS_TRANSITION",
          "message": "Cannot transition order from {current} to {requested}",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-ORDER-001"
      ]
    },
    {
      "id": "TS-BR-ORDER-002",
      "name": "Order immutability after placement",
      "br_ref": "BR-ORDER-002",
      "rule": "Orders cannot be modified after placement",
      "implementation": "No PUT/PATCH endpoints for order items, quantities, or shipping address; only status transitions allowed",
      "validation_points": [
        "API layer: no modification endpoints",
        "OrderService: no edit methods",
        "Order aggregate: immutable fields"
      ],
      "data_requirements": [
        {
          "field": "orderItems",
          "type": "OrderItem[]",
          "constraints": "immutable after creation",
          "source": "Order aggregate"
        },
        {
          "field": "shippingAddress",
          "type": "ShippingAddress",
          "constraints": "immutable after creation",
          "source": "Order aggregate"
        }
      ],
      "error_handling": [
        {
          "condition": "Attempt to modify placed order",
          "error_code": "ORDER_MODIFICATION_NOT_ALLOWED",
          "message": "Orders cannot be modified after placement. Please cancel and place a new order.",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-ORDER-002"
      ]
    },
    {
      "id": "TS-BR-ORDER-003",
      "name": "Single shipment per order constraint",
      "br_ref": "BR-ORDER-003",
      "rule": "Each order ships as a single unit",
      "implementation": "Order has one-to-one relationship with Shipment; shipped status applies to entire order atomically",
      "validation_points": [
        "Order aggregate design",
        "ShipmentService.createShipment()",
        "DB: unique constraint on order_id in shipments"
      ],
      "data_requirements": [
        {
          "field": "shipmentId",
          "type": "UUID",
          "constraints": "one per order",
          "source": "Shipment aggregate"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-ORDER-003"
      ]
    },
    {
      "id": "TS-BR-CUST-001",
      "name": "Unique customer email constraint",
      "br_ref": "BR-CUST-001",
      "rule": "Email addresses must be unique across all customer accounts",
      "implementation": "DB unique index on customers.email; check uniqueness before insert",
      "validation_points": [
        "POST /customers (registration) API",
        "CustomerService.register()",
        "DB UNIQUE constraint on email"
      ],
      "data_requirements": [
        {
          "field": "email",
          "type": "varchar(255)",
          "constraints": "NOT NULL, UNIQUE, valid email format",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "Email already exists in database",
          "error_code": "EMAIL_ALREADY_REGISTERED",
          "message": "An account with this email already exists",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-CUST-001"
      ]
    },
    {
      "id": "TS-BR-CUST-002",
      "name": "Password strength requirements",
      "br_ref": "BR-CUST-002",
      "rule": "Customer passwords must meet minimum security requirements",
      "implementation": "Validate password with regex: ^(?=.*\\d).{8,}$ on registration and password change",
      "validation_points": [
        "POST /customers (registration) API",
        "PUT /customers/{id}/password API",
        "CustomerService.setPassword()"
      ],
      "data_requirements": [
        {
          "field": "password",
          "type": "string",
          "constraints": "min 8 chars, at least one digit",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "Password does not meet requirements",
          "error_code": "WEAK_PASSWORD",
          "message": "Password must be at least 8 characters and contain at least one number",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-CUST-002"
      ]
    },
    {
      "id": "TS-BR-CUST-003",
      "name": "Email verification requirement for checkout",
      "br_ref": "BR-CUST-003",
      "rule": "Customers must verify their email before placing orders",
      "implementation": "Check customer.emailVerified = true in checkout flow before allowing order placement",
      "validation_points": [
        "POST /orders API",
        "CheckoutService.placeOrder()",
        "Pre-checkout validation"
      ],
      "data_requirements": [
        {
          "field": "emailVerified",
          "type": "boolean",
          "constraints": "must be true for checkout",
          "source": "Customer aggregate"
        }
      ],
      "error_handling": [
        {
          "condition": "emailVerified = false",
          "error_code": "EMAIL_NOT_VERIFIED",
          "message": "Please verify your email address before placing an order",
          "http_status": 403
        }
      ],
      "related_acs": [
        "AC-CUST-003"
      ]
    },
    {
      "id": "TS-BR-PROD-001",
      "name": "Product soft delete for order history preservation",
      "br_ref": "BR-PROD-001",
      "rule": "Products with order history must be soft-deleted",
      "implementation": "Delete operation checks for existing OrderItems; if found, set deletedAt timestamp instead of hard delete",
      "validation_points": [
        "DELETE /products/{id} API",
        "ProductService.deleteProduct()",
        "Query filters exclude deletedAt IS NOT NULL"
      ],
      "data_requirements": [
        {
          "field": "deletedAt",
          "type": "timestamp",
          "constraints": "NULL if active",
          "source": "Product aggregate"
        },
        {
          "field": "hasOrderHistory",
          "type": "boolean",
          "constraints": "derived from OrderItems",
          "source": "OrderItem table"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-PROD-001"
      ]
    },
    {
      "id": "TS-BR-PROD-002",
      "name": "Product name length validation",
      "br_ref": "BR-PROD-002",
      "rule": "Product names must be between 2 and 200 characters",
      "implementation": "Validate name.length \u003e= 2 AND \u003c= 200 on product create/update",
      "validation_points": [
        "POST /products API",
        "PUT /products/{id} API",
        "ProductService.createProduct()",
        "ProductService.updateProduct()"
      ],
      "data_requirements": [
        {
          "field": "name",
          "type": "varchar(200)",
          "constraints": "2 \u003c= length \u003c= 200, NOT NULL",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "name.length \u003c 2 OR name.length \u003e 200",
          "error_code": "INVALID_PRODUCT_NAME",
          "message": "Product name must be between 2 and 200 characters",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-PROD-002"
      ]
    },
    {
      "id": "TS-BR-PROD-003",
      "name": "Product description length constraint",
      "br_ref": "BR-PROD-003",
      "rule": "Product descriptions must not exceed 5000 characters",
      "implementation": "Validate description.length \u003c= 5000 on product create/update",
      "validation_points": [
        "POST /products API",
        "PUT /products/{id} API",
        "ProductService.createProduct()",
        "ProductService.updateProduct()"
      ],
      "data_requirements": [
        {
          "field": "description",
          "type": "text",
          "constraints": "length \u003c= 5000, nullable",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "description.length \u003e 5000",
          "error_code": "DESCRIPTION_TOO_LONG",
          "message": "Product description cannot exceed 5000 characters",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-PROD-003"
      ]
    },
    {
      "id": "TS-BR-PROD-004",
      "name": "Product image limit and primary image enforcement",
      "br_ref": "BR-PROD-004",
      "rule": "Products can have up to 10 images with exactly one primary",
      "implementation": "Validate images.count \u003c= 10 and exactly one isPrimary=true on image add/update",
      "validation_points": [
        "POST /products/{id}/images API",
        "PUT /products/{id}/images/{imageId} API",
        "ProductImageService.addImage()",
        "ProductImageService.setPrimary()"
      ],
      "data_requirements": [
        {
          "field": "images",
          "type": "ProductImage[]",
          "constraints": "count \u003c= 10",
          "source": "Product aggregate"
        },
        {
          "field": "isPrimary",
          "type": "boolean",
          "constraints": "exactly one true per product",
          "source": "ProductImage"
        }
      ],
      "error_handling": [
        {
          "condition": "images.count \u003e 10",
          "error_code": "IMAGE_LIMIT_EXCEEDED",
          "message": "Products cannot have more than 10 images",
          "http_status": 400
        },
        {
          "condition": "No primary image set",
          "error_code": "PRIMARY_IMAGE_REQUIRED",
          "message": "Product must have exactly one primary image",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-PROD-004"
      ]
    },
    {
      "id": "TS-BR-VAR-001",
      "name": "Variant SKU uniqueness constraint",
      "br_ref": "BR-VAR-001",
      "rule": "Each product variant must have a unique SKU",
      "implementation": "DB unique index on product_variants.sku; validate uniqueness before insert",
      "validation_points": [
        "POST /products/{id}/variants API",
        "VariantService.createVariant()",
        "DB UNIQUE constraint on sku"
      ],
      "data_requirements": [
        {
          "field": "sku",
          "type": "varchar(100)",
          "constraints": "NOT NULL, UNIQUE",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "SKU already exists",
          "error_code": "DUPLICATE_SKU",
          "message": "A product variant with this SKU already exists",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-VAR-001"
      ]
    },
    {
      "id": "TS-BR-VAR-002",
      "name": "Variant selection required for products with variants",
      "br_ref": "BR-VAR-002",
      "rule": "Products with variants require variant selection before add to cart",
      "implementation": "Check if product.hasVariants; if true, require variantId in add-to-cart request",
      "validation_points": [
        "POST /cart/items API",
        "CartService.addItem()",
        "UI: disable add button until variant selected"
      ],
      "data_requirements": [
        {
          "field": "hasVariants",
          "type": "boolean",
          "constraints": "derived from variants.count \u003e 0",
          "source": "Product aggregate"
        },
        {
          "field": "variantId",
          "type": "UUID",
          "constraints": "required if hasVariants",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "Product has variants but variantId not provided",
          "error_code": "VARIANT_REQUIRED",
          "message": "Please select a product variant before adding to cart",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-VAR-002"
      ]
    },
    {
      "id": "TS-BR-CART-002",
      "name": "Cart quantity stock limit enforcement",
      "br_ref": "BR-CART-002",
      "rule": "Cart item quantity cannot exceed available inventory",
      "implementation": "Cap quantity at availableStock on add/update; show notification if requested quantity exceeds stock",
      "validation_points": [
        "POST /cart/items API",
        "PUT /cart/items/{id} API",
        "CartService.addItem()",
        "CartService.updateQuantity()"
      ],
      "data_requirements": [
        {
          "field": "quantity",
          "type": "integer",
          "constraints": "\u003e 0, \u003c= availableStock",
          "source": "Request payload"
        },
        {
          "field": "availableStock",
          "type": "integer",
          "constraints": "\u003e= 0",
          "source": "Inventory aggregate"
        }
      ],
      "error_handling": [
        {
          "condition": "quantity \u003e availableStock",
          "error_code": "QUANTITY_EXCEEDS_STOCK",
          "message": "Only {available} items available. Quantity adjusted.",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-CART-002"
      ]
    },
    {
      "id": "TS-BR-CART-003",
      "name": "Cart expiration policy by user type",
      "br_ref": "BR-CART-003",
      "rule": "Carts expire after period of inactivity based on user type",
      "implementation": "Background job runs daily to delete carts where lastModified + expirationPeriod \u003c now(); update lastModified on cart operations",
      "validation_points": [
        "CartCleanupJob (scheduled)",
        "CartService.onCartModification()",
        "GET /cart API (check expiration)"
      ],
      "data_requirements": [
        {
          "field": "lastModified",
          "type": "timestamp",
          "constraints": "NOT NULL, updated on changes",
          "source": "Cart aggregate"
        },
        {
          "field": "isGuest",
          "type": "boolean",
          "constraints": "determines expiration period",
          "source": "Cart aggregate"
        }
      ],
      "error_handling": [
        {
          "condition": "Cart has expired",
          "error_code": "CART_EXPIRED",
          "message": "Your cart has expired. Please add items again.",
          "http_status": 410
        }
      ],
      "related_acs": [
        "AC-CART-003"
      ]
    },
    {
      "id": "TS-BR-PAY-001",
      "name": "Payment authorization before order creation",
      "br_ref": "BR-PAY-001",
      "rule": "Payment must be fully authorized before order is created",
      "implementation": "Checkout flow: 1) validate cart, 2) authorize payment, 3) if authorized, create order atomically with inventory decrement",
      "validation_points": [
        "CheckoutService.placeOrder()",
        "PaymentService.authorize()",
        "Transaction boundary"
      ],
      "data_requirements": [
        {
          "field": "paymentAuthorizationId",
          "type": "string",
          "constraints": "from payment gateway",
          "source": "Payment gateway response"
        },
        {
          "field": "paymentStatus",
          "type": "PaymentStatus enum",
          "constraints": "must be 'authorized'",
          "source": "Payment service"
        }
      ],
      "error_handling": [
        {
          "condition": "Payment authorization failed",
          "error_code": "PAYMENT_REQUIRED",
          "message": "Payment could not be authorized. Please try again.",
          "http_status": 402
        }
      ],
      "related_acs": [
        "AC-PAY-001"
      ]
    },
    {
      "id": "TS-BR-PAY-002",
      "name": "Automatic refund on order cancellation",
      "br_ref": "BR-PAY-002",
      "rule": "Cancelled orders must receive automatic refund",
      "implementation": "Order cancellation triggers PaymentService.refund(order.paymentId) in same transaction; store refund status",
      "validation_points": [
        "OrderService.cancelOrder()",
        "PaymentService.refund()",
        "Refund status tracking"
      ],
      "data_requirements": [
        {
          "field": "paymentId",
          "type": "string",
          "constraints": "original payment reference",
          "source": "Order aggregate"
        },
        {
          "field": "refundStatus",
          "type": "RefundStatus enum",
          "constraints": "pending|completed|failed",
          "source": "Payment service"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-PAY-002"
      ]
    },
    {
      "id": "TS-BR-SHIP-002",
      "name": "Domestic shipping only restriction",
      "br_ref": "BR-SHIP-002",
      "rule": "Shipping is only available within a single country",
      "implementation": "Validate address.country equals config.domesticCountry; reject international addresses",
      "validation_points": [
        "POST /orders API",
        "AddressValidator.validate()",
        "Checkout address form"
      ],
      "data_requirements": [
        {
          "field": "country",
          "type": "varchar(2)",
          "constraints": "ISO 3166-1 alpha-2, must match domestic",
          "source": "Request payload"
        },
        {
          "field": "domesticCountry",
          "type": "varchar(2)",
          "constraints": "configured value",
          "source": "Application config"
        }
      ],
      "error_handling": [
        {
          "condition": "country != domesticCountry",
          "error_code": "INTERNATIONAL_SHIPPING_NOT_AVAILABLE",
          "message": "We currently only ship within {country}",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-SHIP-002"
      ]
    },
    {
      "id": "TS-BR-ADDR-001",
      "name": "Required shipping address fields validation",
      "br_ref": "BR-ADDR-001",
      "rule": "Shipping addresses must include all required fields",
      "implementation": "Validate all required fields are present and non-empty in address payload",
      "validation_points": [
        "POST /orders API",
        "PUT /customers/{id}/addresses API",
        "AddressValidator.validate()",
        "Checkout form validation"
      ],
      "data_requirements": [
        {
          "field": "street",
          "type": "varchar(255)",
          "constraints": "NOT NULL, non-empty",
          "source": "Request payload"
        },
        {
          "field": "city",
          "type": "varchar(100)",
          "constraints": "NOT NULL, non-empty",
          "source": "Request payload"
        },
        {
          "field": "state",
          "type": "varchar(100)",
          "constraints": "NOT NULL, non-empty",
          "source": "Request payload"
        },
        {
          "field": "postalCode",
          "type": "varchar(20)",
          "constraints": "NOT NULL, non-empty",
          "source": "Request payload"
        },
        {
          "field": "country",
          "type": "varchar(2)",
          "constraints": "NOT NULL, ISO 3166-1",
          "source": "Request payload"
        },
        {
          "field": "recipientName",
          "type": "varchar(200)",
          "constraints": "NOT NULL, non-empty",
          "source": "Request payload"
        }
      ],
      "error_handling": [
        {
          "condition": "Any required field missing or empty",
          "error_code": "INCOMPLETE_ADDRESS",
          "message": "Please provide all required address fields",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ADDR-001"
      ]
    },
    {
      "id": "TS-BR-CAT-001",
      "name": "Category hierarchy depth limit",
      "br_ref": "BR-CAT-001",
      "rule": "Categories can be nested up to 3 levels deep",
      "implementation": "Calculate depth by traversing parent chain; reject if depth \u003e 3 on category create/update with parent",
      "validation_points": [
        "POST /categories API",
        "PUT /categories/{id} API",
        "CategoryService.createCategory()",
        "CategoryService.updateCategory()"
      ],
      "data_requirements": [
        {
          "field": "parentId",
          "type": "UUID",
          "constraints": "nullable, FK to categories",
          "source": "Request payload"
        },
        {
          "field": "depth",
          "type": "integer",
          "constraints": "1 \u003c= depth \u003c= 3",
          "source": "Calculated from hierarchy"
        }
      ],
      "error_handling": [
        {
          "condition": "Resulting depth \u003e 3",
          "error_code": "CATEGORY_DEPTH_EXCEEDED",
          "message": "Categories cannot be nested more than 3 levels deep",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-CAT-001"
      ]
    },
    {
      "id": "TS-BR-AUDIT-001",
      "name": "Order event audit logging",
      "br_ref": "BR-AUDIT-001",
      "rule": "All order events must be logged for audit purposes",
      "implementation": "Emit OrderEvent to audit log on create, status change, cancel; include timestamp, userId, previousStatus, newStatus",
      "validation_points": [
        "OrderService.placeOrder()",
        "OrderService.updateStatus()",
        "OrderService.cancelOrder()",
        "AuditLogService.logOrderEvent()"
      ],
      "data_requirements": [
        {
          "field": "eventType",
          "type": "OrderEventType enum",
          "constraints": "created|status_changed|cancelled",
          "source": "Domain event"
        },
        {
          "field": "timestamp",
          "type": "timestamp",
          "constraints": "NOT NULL, UTC",
          "source": "System clock"
        },
        {
          "field": "userId",
          "type": "UUID",
          "constraints": "NOT NULL",
          "source": "Auth context"
        },
        {
          "field": "previousValue",
          "type": "json",
          "constraints": "nullable",
          "source": "Before state"
        },
        {
          "field": "newValue",
          "type": "json",
          "constraints": "nullable",
          "source": "After state"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-AUDIT-001"
      ]
    },
    {
      "id": "TS-BR-AUDIT-002",
      "name": "Inventory change audit logging",
      "br_ref": "BR-AUDIT-002",
      "rule": "All inventory changes must be logged with full audit trail",
      "implementation": "Emit InventoryEvent on every stock adjustment; include productId, previousStock, newStock, reason, operatorId",
      "validation_points": [
        "InventoryService.adjustStock()",
        "InventoryService.reserveStock()",
        "InventoryService.restoreStock()",
        "AuditLogService.logInventoryEvent()"
      ],
      "data_requirements": [
        {
          "field": "productId",
          "type": "UUID",
          "constraints": "NOT NULL",
          "source": "Inventory aggregate"
        },
        {
          "field": "previousStock",
          "type": "integer",
          "constraints": "\u003e= 0",
          "source": "Before state"
        },
        {
          "field": "newStock",
          "type": "integer",
          "constraints": "\u003e= 0",
          "source": "After state"
        },
        {
          "field": "reason",
          "type": "AdjustmentReason enum",
          "constraints": "order_placed|order_cancelled|manual_adjustment|...",
          "source": "Operation context"
        },
        {
          "field": "operatorId",
          "type": "UUID",
          "constraints": "NOT NULL",
          "source": "Auth context"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-AUDIT-002"
      ]
    },
    {
      "id": "TS-BR-AUDIT-003",
      "name": "Price change audit tracking",
      "br_ref": "BR-AUDIT-003",
      "rule": "Product price changes must be tracked in audit trail",
      "implementation": "Compare price before/after on product update; if changed, emit PriceChangeEvent to audit log",
      "validation_points": [
        "ProductService.updateProduct()",
        "AuditLogService.logPriceChange()"
      ],
      "data_requirements": [
        {
          "field": "productId",
          "type": "UUID",
          "constraints": "NOT NULL",
          "source": "Product aggregate"
        },
        {
          "field": "previousPrice",
          "type": "decimal(10,2)",
          "constraints": "\u003e= 0.01",
          "source": "Before state"
        },
        {
          "field": "newPrice",
          "type": "decimal(10,2)",
          "constraints": "\u003e= 0.01",
          "source": "After state"
        },
        {
          "field": "modifierId",
          "type": "UUID",
          "constraints": "NOT NULL",
          "source": "Auth context"
        },
        {
          "field": "timestamp",
          "type": "timestamp",
          "constraints": "NOT NULL, UTC",
          "source": "System clock"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-AUDIT-003"
      ]
    }
  ]
}