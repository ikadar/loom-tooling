{
  "aggregates": [
    {
      "id": "AGG-CUSTOMER-001",
      "name": "Customer",
      "purpose": "Manages customer identity, authentication, and associated shipping addresses",
      "invariants": [
        {
          "id": "INV-CUST-001",
          "rule": "Customer email must be unique across all customers",
          "enforcement": "Database unique constraint, validated on registration"
        },
        {
          "id": "INV-CUST-002",
          "rule": "Customer must be registered and email verified to place orders",
          "enforcement": "Status check in placeOrder operation"
        },
        {
          "id": "INV-CUST-003",
          "rule": "Password must be at least 8 characters with at least one number",
          "enforcement": "Validation during registration and password change"
        },
        {
          "id": "INV-CUST-004",
          "rule": "Email must be valid RFC 5322 format",
          "enforcement": "Email value object validation on creation"
        }
      ],
      "root": {
        "entity": "Customer",
        "identity": "CustomerId (UUID)",
        "attributes": [
          {
            "name": "customerId",
            "type": "CustomerId",
            "mutable": false
          },
          {
            "name": "email",
            "type": "Email",
            "mutable": true
          },
          {
            "name": "passwordHash",
            "type": "string",
            "mutable": true
          },
          {
            "name": "registrationStatus",
            "type": "RegistrationStatus",
            "mutable": true
          },
          {
            "name": "emailVerified",
            "type": "boolean",
            "mutable": true
          },
          {
            "name": "firstName",
            "type": "string",
            "mutable": true
          },
          {
            "name": "lastName",
            "type": "string",
            "mutable": true
          },
          {
            "name": "shippingAddresses",
            "type": "List\u003cShippingAddress\u003e",
            "mutable": true
          },
          {
            "name": "createdAt",
            "type": "DateTime",
            "mutable": false
          }
        ]
      },
      "entities": [
        {
          "name": "ShippingAddress",
          "identity": "AddressId",
          "purpose": "Customer's saved shipping address for order delivery",
          "attributes": [
            {
              "name": "addressId",
              "type": "AddressId",
              "mutable": false
            },
            {
              "name": "street",
              "type": "string",
              "mutable": false
            },
            {
              "name": "city",
              "type": "string",
              "mutable": false
            },
            {
              "name": "state",
              "type": "string",
              "mutable": false
            },
            {
              "name": "postalCode",
              "type": "string",
              "mutable": false
            },
            {
              "name": "country",
              "type": "string",
              "mutable": false
            },
            {
              "name": "recipientName",
              "type": "string",
              "mutable": false
            },
            {
              "name": "isDefault",
              "type": "boolean",
              "mutable": false
            }
          ]
        }
      ],
      "valueObjects": [
        "Email",
        "Password",
        "RegistrationStatus",
        "Address"
      ],
      "behaviors": [
        {
          "name": "register",
          "command": "RegisterCustomer",
          "preconditions": [
            "email not already registered"
          ],
          "postconditions": [
            "status == 'unverified'",
            "verification email queued"
          ],
          "emits": "CustomerRegistered"
        },
        {
          "name": "verifyEmail",
          "command": "VerifyCustomerEmail",
          "preconditions": [
            "valid verification token",
            "token not expired"
          ],
          "postconditions": [
            "emailVerified == true"
          ],
          "emits": "CustomerEmailVerified"
        },
        {
          "name": "addShippingAddress",
          "command": "AddShippingAddress",
          "preconditions": [
            "customer registered",
            "address fields valid",
            "country is domestic"
          ],
          "postconditions": [
            "address added to shippingAddresses"
          ],
          "emits": "ShippingAddressAdded"
        },
        {
          "name": "updateShippingAddress",
          "command": "UpdateShippingAddress",
          "preconditions": [
            "address exists",
            "address fields valid"
          ],
          "postconditions": [
            "address updated"
          ],
          "emits": "ShippingAddressUpdated"
        },
        {
          "name": "removeShippingAddress",
          "command": "RemoveShippingAddress",
          "preconditions": [
            "address exists"
          ],
          "postconditions": [
            "address removed from shippingAddresses"
          ],
          "emits": "ShippingAddressRemoved"
        },
        {
          "name": "requestDataErasure",
          "command": "RequestGDPRErasure",
          "preconditions": [
            "no pending orders"
          ],
          "postconditions": [
            "personal data erased",
            "order history anonymized"
          ],
          "emits": "CustomerDataErased"
        }
      ],
      "events": [
        {
          "name": "CustomerRegistered",
          "payload": [
            "customerId",
            "email",
            "createdAt"
          ]
        },
        {
          "name": "CustomerEmailVerified",
          "payload": [
            "customerId",
            "verifiedAt"
          ]
        },
        {
          "name": "ShippingAddressAdded",
          "payload": [
            "customerId",
            "addressId",
            "address"
          ]
        },
        {
          "name": "ShippingAddressUpdated",
          "payload": [
            "customerId",
            "addressId",
            "address"
          ]
        },
        {
          "name": "ShippingAddressRemoved",
          "payload": [
            "customerId",
            "addressId"
          ]
        },
        {
          "name": "CustomerDataErased",
          "payload": [
            "anonymizedId",
            "erasedAt"
          ]
        }
      ],
      "repository": {
        "name": "CustomerRepository",
        "methods": [
          {
            "name": "findById",
            "params": "CustomerId",
            "returns": "Customer?"
          },
          {
            "name": "findByEmail",
            "params": "Email",
            "returns": "Customer?"
          },
          {
            "name": "existsByEmail",
            "params": "Email",
            "returns": "boolean"
          },
          {
            "name": "save",
            "params": "Customer",
            "returns": "void"
          }
        ],
        "loadStrategy": "Load customer with all shipping addresses",
        "concurrency": "Optimistic locking via version field"
      },
      "externalReferences": []
    },
    {
      "id": "AGG-CART-001",
      "name": "Cart",
      "purpose": "Manages shopping cart items and totals before checkout",
      "invariants": [
        {
          "id": "INV-CART-001",
          "rule": "Total price must equal sum of all cart item subtotals",
          "enforcement": "Recalculated after any item change"
        },
        {
          "id": "INV-CART-002",
          "rule": "Each product can appear only once (quantity adjusted instead)",
          "enforcement": "Check for existing item before add, merge if exists"
        },
        {
          "id": "INV-CART-003",
          "rule": "Cart item quantity must be at least 1",
          "enforcement": "Setting to 0 triggers removal"
        },
        {
          "id": "INV-CART-004",
          "rule": "Cart item quantity cannot exceed available stock",
          "enforcement": "Stock check during add and update, auto-cap if exceeded"
        },
        {
          "id": "INV-CART-005",
          "rule": "Products with variants require specific variant selection",
          "enforcement": "Validation on addItem when product hasVariants"
        },
        {
          "id": "INV-CART-006",
          "rule": "Inactive carts expire after threshold (30 days logged-in, 7 days guest)",
          "enforcement": "Background job or lazy evaluation on cart access"
        }
      ],
      "root": {
        "entity": "Cart",
        "identity": "CartId (UUID)",
        "attributes": [
          {
            "name": "cartId",
            "type": "CartId",
            "mutable": false
          },
          {
            "name": "customerId",
            "type": "CustomerId",
            "mutable": false
          },
          {
            "name": "isGuest",
            "type": "boolean",
            "mutable": false
          },
          {
            "name": "items",
            "type": "List\u003cCartItem\u003e",
            "mutable": true
          },
          {
            "name": "totalPrice",
            "type": "Money",
            "mutable": true
          },
          {
            "name": "lastActivityDate",
            "type": "DateTime",
            "mutable": true
          },
          {
            "name": "createdAt",
            "type": "DateTime",
            "mutable": false
          }
        ]
      },
      "entities": [
        {
          "name": "CartItem",
          "identity": "CartItemId",
          "purpose": "Product and quantity snapshot within shopping cart",
          "attributes": [
            {
              "name": "cartItemId",
              "type": "CartItemId",
              "mutable": false
            },
            {
              "name": "productId",
              "type": "ProductId",
              "mutable": false
            },
            {
              "name": "variantId",
              "type": "VariantId",
              "mutable": false
            },
            {
              "name": "productName",
              "type": "string",
              "mutable": false
            },
            {
              "name": "variantDescription",
              "type": "string",
              "mutable": false
            },
            {
              "name": "unitPrice",
              "type": "Money",
              "mutable": false
            },
            {
              "name": "quantity",
              "type": "Quantity",
              "mutable": false
            },
            {
              "name": "subtotal",
              "type": "Money",
              "mutable": false
            },
            {
              "name": "addedAt",
              "type": "DateTime",
              "mutable": false
            }
          ]
        }
      ],
      "valueObjects": [
        "Money",
        "Quantity"
      ],
      "behaviors": [
        {
          "name": "addItem",
          "command": "AddItemToCart",
          "preconditions": [
            "product is active",
            "product is in stock",
            "quantity \u003e 0",
            "variant selected if required"
          ],
          "postconditions": [
            "item added or quantity merged",
            "totalPrice recalculated",
            "lastActivityDate updated"
          ],
          "emits": "ItemAddedToCart"
        },
        {
          "name": "updateQuantity",
          "command": "UpdateCartItemQuantity",
          "preconditions": [
            "item exists in cart",
            "quantity \u003e= 0",
            "quantity \u003c= available stock"
          ],
          "postconditions": [
            "quantity updated or item removed if 0",
            "totalPrice recalculated",
            "lastActivityDate updated"
          ],
          "emits": "CartItemQuantityUpdated"
        },
        {
          "name": "removeItem",
          "command": "RemoveItemFromCart",
          "preconditions": [
            "item exists in cart"
          ],
          "postconditions": [
            "item removed",
            "totalPrice recalculated",
            "lastActivityDate updated"
          ],
          "emits": "ItemRemovedFromCart"
        },
        {
          "name": "clear",
          "command": "ClearCart",
          "preconditions": [],
          "postconditions": [
            "all items removed",
            "totalPrice == 0"
          ],
          "emits": "CartCleared"
        },
        {
          "name": "mergeGuestCart",
          "command": "MergeGuestCart",
          "preconditions": [
            "guest cart exists",
            "customer authenticated"
          ],
          "postconditions": [
            "guest cart items merged",
            "quantities limited to stock"
          ],
          "emits": "CartMerged"
        },
        {
          "name": "refreshPrices",
          "command": "RefreshCartPrices",
          "preconditions": [],
          "postconditions": [
            "prices updated to current",
            "price changes tracked"
          ],
          "emits": "CartPricesRefreshed"
        }
      ],
      "events": [
        {
          "name": "ItemAddedToCart",
          "payload": [
            "cartId",
            "productId",
            "variantId",
            "quantity",
            "unitPrice"
          ]
        },
        {
          "name": "CartItemQuantityUpdated",
          "payload": [
            "cartId",
            "cartItemId",
            "oldQuantity",
            "newQuantity"
          ]
        },
        {
          "name": "ItemRemovedFromCart",
          "payload": [
            "cartId",
            "productId",
            "variantId"
          ]
        },
        {
          "name": "CartCleared",
          "payload": [
            "cartId",
            "reason"
          ]
        },
        {
          "name": "CartMerged",
          "payload": [
            "cartId",
            "guestCartId",
            "mergedItems"
          ]
        },
        {
          "name": "CartPricesRefreshed",
          "payload": [
            "cartId",
            "priceChanges"
          ]
        },
        {
          "name": "CartExpired",
          "payload": [
            "cartId",
            "customerId"
          ]
        }
      ],
      "repository": {
        "name": "CartRepository",
        "methods": [
          {
            "name": "findById",
            "params": "CartId",
            "returns": "Cart?"
          },
          {
            "name": "findByCustomerId",
            "params": "CustomerId",
            "returns": "Cart?"
          },
          {
            "name": "findExpiredCarts",
            "params": "DateTime threshold",
            "returns": "List\u003cCart\u003e"
          },
          {
            "name": "save",
            "params": "Cart",
            "returns": "void"
          },
          {
            "name": "delete",
            "params": "CartId",
            "returns": "void"
          }
        ],
        "loadStrategy": "Load cart with all items eagerly",
        "concurrency": "Optimistic locking via version field"
      },
      "externalReferences": [
        {
          "aggregate": "Customer",
          "via": "customerId",
          "type": "reference"
        },
        {
          "aggregate": "Product",
          "via": "productId in items",
          "type": "reference"
        },
        {
          "aggregate": "Inventory",
          "via": "productId",
          "type": "query"
        }
      ]
    },
    {
      "id": "AGG-ORDER-001",
      "name": "Order",
      "purpose": "Manages the complete order lifecycle from placement through delivery or cancellation",
      "invariants": [
        {
          "id": "INV-ORDER-001",
          "rule": "Order must have at least one line item",
          "enforcement": "Validated on creation"
        },
        {
          "id": "INV-ORDER-002",
          "rule": "Total amount must equal subtotal plus shipping cost",
          "enforcement": "Calculated on creation, immutable"
        },
        {
          "id": "INV-ORDER-003",
          "rule": "Shipping is free when subtotal exceeds $50",
          "enforcement": "Shipping cost calculation on creation"
        },
        {
          "id": "INV-ORDER-004",
          "rule": "Cannot modify order after status is shipped, delivered, or cancelled",
          "enforcement": "Guard clause in all modification methods"
        },
        {
          "id": "INV-ORDER-005",
          "rule": "Can only cancel before status is shipped",
          "enforcement": "Status check in cancel operation"
        },
        {
          "id": "INV-ORDER-006",
          "rule": "Status transitions must follow valid state machine",
          "enforcement": "State pattern: pending→confirmed→shipped→delivered OR pending/confirmed→cancelled"
        },
        {
          "id": "INV-ORDER-007",
          "rule": "Line item prices are immutable snapshots from order time",
          "enforcement": "Copy price during order creation, no updates allowed"
        },
        {
          "id": "INV-ORDER-008",
          "rule": "Order number must be unique with format ORD-{YEAR}-{SEQUENCE}",
          "enforcement": "Generated atomically on creation"
        }
      ],
      "root": {
        "entity": "Order",
        "identity": "OrderId (UUID)",
        "attributes": [
          {
            "name": "orderId",
            "type": "OrderId",
            "mutable": false
          },
          {
            "name": "orderNumber",
            "type": "string",
            "mutable": false
          },
          {
            "name": "customerId",
            "type": "CustomerId",
            "mutable": false
          },
          {
            "name": "status",
            "type": "OrderStatus",
            "mutable": true
          },
          {
            "name": "lineItems",
            "type": "List\u003cOrderLineItem\u003e",
            "mutable": false
          },
          {
            "name": "shippingAddress",
            "type": "Address",
            "mutable": false
          },
          {
            "name": "paymentMethod",
            "type": "PaymentMethod",
            "mutable": false
          },
          {
            "name": "paymentTransactionId",
            "type": "string",
            "mutable": false
          },
          {
            "name": "subtotal",
            "type": "Money",
            "mutable": false
          },
          {
            "name": "shippingCost",
            "type": "Money",
            "mutable": false
          },
          {
            "name": "tax",
            "type": "Money",
            "mutable": false
          },
          {
            "name": "totalAmount",
            "type": "Money",
            "mutable": false
          },
          {
            "name": "trackingNumber",
            "type": "string",
            "mutable": true
          },
          {
            "name": "cancellationReason",
            "type": "string",
            "mutable": true
          },
          {
            "name": "createdAt",
            "type": "DateTime",
            "mutable": false
          },
          {
            "name": "updatedAt",
            "type": "DateTime",
            "mutable": true
          }
        ]
      },
      "entities": [
        {
          "name": "OrderLineItem",
          "identity": "LineItemId",
          "purpose": "Immutable snapshot of product at order time with quantity and price",
          "attributes": [
            {
              "name": "lineItemId",
              "type": "LineItemId",
              "mutable": false
            },
            {
              "name": "productId",
              "type": "ProductId",
              "mutable": false
            },
            {
              "name": "variantId",
              "type": "VariantId",
              "mutable": false
            },
            {
              "name": "productName",
              "type": "string",
              "mutable": false
            },
            {
              "name": "variantDescription",
              "type": "string",
              "mutable": false
            },
            {
              "name": "unitPrice",
              "type": "Money",
              "mutable": false
            },
            {
              "name": "quantity",
              "type": "Quantity",
              "mutable": false
            },
            {
              "name": "subtotal",
              "type": "Money",
              "mutable": false
            }
          ]
        }
      ],
      "valueObjects": [
        "Money",
        "Address",
        "PaymentMethod",
        "OrderStatus",
        "Quantity"
      ],
      "behaviors": [
        {
          "name": "create",
          "command": "PlaceOrder",
          "preconditions": [
            "customer registered and verified",
            "cart has items",
            "all items in stock",
            "payment authorized",
            "valid shipping address"
          ],
          "postconditions": [
            "order created with status 'pending'",
            "line items snapshot created",
            "totals calculated"
          ],
          "emits": "OrderPlaced"
        },
        {
          "name": "confirm",
          "command": "ConfirmOrder",
          "preconditions": [
            "status == 'pending'"
          ],
          "postconditions": [
            "status == 'confirmed'"
          ],
          "emits": "OrderConfirmed"
        },
        {
          "name": "ship",
          "command": "ShipOrder",
          "preconditions": [
            "status == 'confirmed'",
            "tracking number provided"
          ],
          "postconditions": [
            "status == 'shipped'",
            "tracking number stored"
          ],
          "emits": "OrderShipped"
        },
        {
          "name": "deliver",
          "command": "DeliverOrder",
          "preconditions": [
            "status == 'shipped'"
          ],
          "postconditions": [
            "status == 'delivered'"
          ],
          "emits": "OrderDelivered"
        },
        {
          "name": "cancel",
          "command": "CancelOrder",
          "preconditions": [
            "status in ['pending', 'confirmed']"
          ],
          "postconditions": [
            "status == 'cancelled'",
            "refund initiated",
            "inventory restoration triggered"
          ],
          "emits": "OrderCancelled"
        }
      ],
      "events": [
        {
          "name": "OrderPlaced",
          "payload": [
            "orderId",
            "orderNumber",
            "customerId",
            "lineItems",
            "totalAmount",
            "shippingAddress"
          ]
        },
        {
          "name": "OrderConfirmed",
          "payload": [
            "orderId",
            "orderNumber",
            "confirmedAt"
          ]
        },
        {
          "name": "OrderShipped",
          "payload": [
            "orderId",
            "orderNumber",
            "trackingNumber",
            "shippedAt"
          ]
        },
        {
          "name": "OrderDelivered",
          "payload": [
            "orderId",
            "orderNumber",
            "deliveredAt"
          ]
        },
        {
          "name": "OrderCancelled",
          "payload": [
            "orderId",
            "orderNumber",
            "reason",
            "cancelledAt",
            "lineItems"
          ]
        }
      ],
      "repository": {
        "name": "OrderRepository",
        "methods": [
          {
            "name": "findById",
            "params": "OrderId",
            "returns": "Order?"
          },
          {
            "name": "findByOrderNumber",
            "params": "string",
            "returns": "Order?"
          },
          {
            "name": "findByCustomerId",
            "params": "CustomerId, Pagination",
            "returns": "Page\u003cOrder\u003e"
          },
          {
            "name": "findByFilters",
            "params": "OrderFilters, Pagination",
            "returns": "Page\u003cOrder\u003e"
          },
          {
            "name": "nextOrderNumber",
            "params": "year",
            "returns": "string"
          },
          {
            "name": "save",
            "params": "Order",
            "returns": "void"
          }
        ],
        "loadStrategy": "Load order with all line items eagerly",
        "concurrency": "Optimistic locking via version field"
      },
      "externalReferences": [
        {
          "aggregate": "Customer",
          "via": "customerId",
          "type": "reference"
        },
        {
          "aggregate": "Product",
          "via": "productId in lineItems",
          "type": "snapshot"
        },
        {
          "aggregate": "Inventory",
          "via": "OrderCancelled event",
          "type": "eventual consistency"
        }
      ]
    },
    {
      "id": "AGG-PRODUCT-001",
      "name": "Product",
      "purpose": "Manages product catalog information including variants and images",
      "invariants": [
        {
          "id": "INV-PROD-001",
          "rule": "Product price must be at least $0.01",
          "enforcement": "Validation on creation and update"
        },
        {
          "id": "INV-PROD-002",
          "rule": "Product name must be 2-200 characters",
          "enforcement": "Validation on creation and update"
        },
        {
          "id": "INV-PROD-003",
          "rule": "Product must belong to a category",
          "enforcement": "Required categoryId on creation"
        },
        {
          "id": "INV-PROD-004",
          "rule": "Inactive products cannot be added to cart",
          "enforcement": "isActive check in cart add operation"
        },
        {
          "id": "INV-PROD-005",
          "rule": "Variant SKU must be unique across all products",
          "enforcement": "Database unique constraint"
        },
        {
          "id": "INV-PROD-006",
          "rule": "Variant combination must be unique within product",
          "enforcement": "Check before adding variant"
        },
        {
          "id": "INV-PROD-007",
          "rule": "Products with order history must be soft-deleted",
          "enforcement": "Check for OrderLineItem references before delete"
        },
        {
          "id": "INV-PROD-008",
          "rule": "Maximum 10 images per product",
          "enforcement": "Validation on image upload"
        }
      ],
      "root": {
        "entity": "Product",
        "identity": "ProductId (UUID)",
        "attributes": [
          {
            "name": "productId",
            "type": "ProductId",
            "mutable": false
          },
          {
            "name": "name",
            "type": "string",
            "mutable": true
          },
          {
            "name": "description",
            "type": "string",
            "mutable": true
          },
          {
            "name": "price",
            "type": "Money",
            "mutable": true
          },
          {
            "name": "categoryId",
            "type": "CategoryId",
            "mutable": true
          },
          {
            "name": "variants",
            "type": "List\u003cProductVariant\u003e",
            "mutable": true
          },
          {
            "name": "images",
            "type": "List\u003cProductImage\u003e",
            "mutable": true
          },
          {
            "name": "isActive",
            "type": "boolean",
            "mutable": true
          },
          {
            "name": "isDeleted",
            "type": "boolean",
            "mutable": true
          },
          {
            "name": "status",
            "type": "ProductStatus",
            "mutable": true
          },
          {
            "name": "createdAt",
            "type": "DateTime",
            "mutable": false
          },
          {
            "name": "createdBy",
            "type": "UserId",
            "mutable": false
          },
          {
            "name": "updatedAt",
            "type": "DateTime",
            "mutable": true
          },
          {
            "name": "updatedBy",
            "type": "UserId",
            "mutable": true
          }
        ]
      },
      "entities": [
        {
          "name": "ProductVariant",
          "identity": "VariantId",
          "purpose": "Specific variation of product (size, color combination)",
          "attributes": [
            {
              "name": "variantId",
              "type": "VariantId",
              "mutable": false
            },
            {
              "name": "sku",
              "type": "SKU",
              "mutable": false
            },
            {
              "name": "size",
              "type": "string",
              "mutable": false
            },
            {
              "name": "color",
              "type": "string",
              "mutable": false
            },
            {
              "name": "priceAdjustment",
              "type": "Money",
              "mutable": false
            }
          ]
        },
        {
          "name": "ProductImage",
          "identity": "ImageId",
          "purpose": "Product image with display order",
          "attributes": [
            {
              "name": "imageId",
              "type": "ImageId",
              "mutable": false
            },
            {
              "name": "url",
              "type": "string",
              "mutable": false
            },
            {
              "name": "isPrimary",
              "type": "boolean",
              "mutable": false
            },
            {
              "name": "displayOrder",
              "type": "integer",
              "mutable": false
            }
          ]
        }
      ],
      "valueObjects": [
        "Money",
        "SKU",
        "ProductStatus"
      ],
      "behaviors": [
        {
          "name": "create",
          "command": "CreateProduct",
          "preconditions": [
            "name is valid",
            "price \u003e= 0.01",
            "category exists"
          ],
          "postconditions": [
            "product created with status 'draft'",
            "UUID assigned"
          ],
          "emits": "ProductCreated"
        },
        {
          "name": "update",
          "command": "UpdateProduct",
          "preconditions": [
            "product exists",
            "fields valid"
          ],
          "postconditions": [
            "attributes updated",
            "change logged"
          ],
          "emits": "ProductUpdated"
        },
        {
          "name": "activate",
          "command": "ActivateProduct",
          "preconditions": [
            "product exists",
            "isActive == false"
          ],
          "postconditions": [
            "isActive == true",
            "status == 'active'"
          ],
          "emits": "ProductActivated"
        },
        {
          "name": "deactivate",
          "command": "DeactivateProduct",
          "preconditions": [
            "product exists",
            "isActive == true"
          ],
          "postconditions": [
            "isActive == false"
          ],
          "emits": "ProductDeactivated"
        },
        {
          "name": "softDelete",
          "command": "DeleteProduct",
          "preconditions": [
            "product exists"
          ],
          "postconditions": [
            "isDeleted == true",
            "cart items with product removed"
          ],
          "emits": "ProductDeleted"
        },
        {
          "name": "addVariant",
          "command": "AddProductVariant",
          "preconditions": [
            "product exists",
            "SKU unique",
            "variant combination unique"
          ],
          "postconditions": [
            "variant added to product"
          ],
          "emits": "ProductVariantAdded"
        },
        {
          "name": "removeVariant",
          "command": "RemoveProductVariant",
          "preconditions": [
            "variant exists",
            "no active cart/order references"
          ],
          "postconditions": [
            "variant removed"
          ],
          "emits": "ProductVariantRemoved"
        },
        {
          "name": "uploadImages",
          "command": "UploadProductImages",
          "preconditions": [
            "product exists",
            "total images \u003c= 10",
            "valid image format"
          ],
          "postconditions": [
            "images stored",
            "URLs saved",
            "primary set"
          ],
          "emits": "ProductImagesUploaded"
        }
      ],
      "events": [
        {
          "name": "ProductCreated",
          "payload": [
            "productId",
            "name",
            "price",
            "categoryId",
            "createdBy"
          ]
        },
        {
          "name": "ProductUpdated",
          "payload": [
            "productId",
            "changedFields",
            "updatedBy"
          ]
        },
        {
          "name": "ProductActivated",
          "payload": [
            "productId",
            "activatedAt"
          ]
        },
        {
          "name": "ProductDeactivated",
          "payload": [
            "productId",
            "deactivatedAt"
          ]
        },
        {
          "name": "ProductDeleted",
          "payload": [
            "productId",
            "deletedAt",
            "deletedBy"
          ]
        },
        {
          "name": "ProductVariantAdded",
          "payload": [
            "productId",
            "variantId",
            "sku"
          ]
        },
        {
          "name": "ProductVariantRemoved",
          "payload": [
            "productId",
            "variantId"
          ]
        },
        {
          "name": "ProductImagesUploaded",
          "payload": [
            "productId",
            "imageUrls",
            "primaryImageUrl"
          ]
        }
      ],
      "repository": {
        "name": "ProductRepository",
        "methods": [
          {
            "name": "findById",
            "params": "ProductId",
            "returns": "Product?"
          },
          {
            "name": "findByCategory",
            "params": "CategoryId, Filters, Pagination",
            "returns": "Page\u003cProduct\u003e"
          },
          {
            "name": "findBySku",
            "params": "SKU",
            "returns": "Product?"
          },
          {
            "name": "existsBySku",
            "params": "SKU",
            "returns": "boolean"
          },
          {
            "name": "findActive",
            "params": "Filters, Pagination",
            "returns": "Page\u003cProduct\u003e"
          },
          {
            "name": "save",
            "params": "Product",
            "returns": "void"
          }
        ],
        "loadStrategy": "Load product with variants and images eagerly",
        "concurrency": "Optimistic locking via version field"
      },
      "externalReferences": [
        {
          "aggregate": "Category",
          "via": "categoryId",
          "type": "reference"
        },
        {
          "aggregate": "Inventory",
          "via": "productId",
          "type": "separate aggregate"
        }
      ]
    },
    {
      "id": "AGG-INVENTORY-001",
      "name": "Inventory",
      "purpose": "Tracks stock levels and manages inventory reservations with full audit trail",
      "invariants": [
        {
          "id": "INV-INV-001",
          "rule": "Stock level cannot be negative",
          "enforcement": "Validation on all stock adjustments"
        },
        {
          "id": "INV-INV-002",
          "rule": "Reserved quantity cannot exceed stock level",
          "enforcement": "Check in reserve operation"
        },
        {
          "id": "INV-INV-003",
          "rule": "Available quantity must equal stock level minus reserved",
          "enforcement": "Calculated property"
        },
        {
          "id": "INV-INV-004",
          "rule": "All inventory changes must be logged with before/after values and reason",
          "enforcement": "Audit log entry in same transaction as change"
        },
        {
          "id": "INV-INV-005",
          "rule": "Low stock threshold cannot be negative",
          "enforcement": "Validation on set"
        }
      ],
      "root": {
        "entity": "Inventory",
        "identity": "InventoryId (UUID)",
        "attributes": [
          {
            "name": "inventoryId",
            "type": "InventoryId",
            "mutable": false
          },
          {
            "name": "productId",
            "type": "ProductId",
            "mutable": false
          },
          {
            "name": "stockLevel",
            "type": "integer",
            "mutable": true
          },
          {
            "name": "reservedQuantity",
            "type": "integer",
            "mutable": true
          },
          {
            "name": "lowStockThreshold",
            "type": "integer",
            "mutable": true
          },
          {
            "name": "updatedAt",
            "type": "DateTime",
            "mutable": true
          }
        ]
      },
      "entities": [
        {
          "name": "InventoryAuditLog",
          "identity": "AuditLogId",
          "purpose": "Immutable record of inventory changes",
          "attributes": [
            {
              "name": "auditLogId",
              "type": "AuditLogId",
              "mutable": false
            },
            {
              "name": "previousValue",
              "type": "integer",
              "mutable": false
            },
            {
              "name": "newValue",
              "type": "integer",
              "mutable": false
            },
            {
              "name": "adjustment",
              "type": "integer",
              "mutable": false
            },
            {
              "name": "reason",
              "type": "string",
              "mutable": false
            },
            {
              "name": "userId",
              "type": "UserId",
              "mutable": false
            },
            {
              "name": "timestamp",
              "type": "DateTime",
              "mutable": false
            }
          ]
        }
      ],
      "valueObjects": [],
      "behaviors": [
        {
          "name": "setQuantity",
          "command": "SetInventoryQuantity",
          "preconditions": [
            "quantity \u003e= 0",
            "reason provided"
          ],
          "postconditions": [
            "stockLevel set",
            "audit log created",
            "low stock alert if below threshold"
          ],
          "emits": "InventoryQuantitySet"
        },
        {
          "name": "adjustQuantity",
          "command": "AdjustInventory",
          "preconditions": [
            "result \u003e= 0",
            "reason provided"
          ],
          "postconditions": [
            "stockLevel adjusted",
            "audit log created",
            "low stock alert if below threshold"
          ],
          "emits": "InventoryAdjusted"
        },
        {
          "name": "reserve",
          "command": "ReserveInventory",
          "preconditions": [
            "quantity \u003c= availableQuantity"
          ],
          "postconditions": [
            "reservedQuantity increased"
          ],
          "emits": "InventoryReserved"
        },
        {
          "name": "release",
          "command": "ReleaseInventory",
          "preconditions": [
            "quantity \u003c= reservedQuantity"
          ],
          "postconditions": [
            "reservedQuantity decreased"
          ],
          "emits": "InventoryReleased"
        },
        {
          "name": "deduct",
          "command": "DeductInventory",
          "preconditions": [
            "quantity \u003c= reservedQuantity"
          ],
          "postconditions": [
            "stockLevel decreased",
            "reservedQuantity decreased",
            "audit log created"
          ],
          "emits": "InventoryDeducted"
        },
        {
          "name": "restock",
          "command": "RestockInventory",
          "preconditions": [
            "quantity \u003e 0",
            "reason provided"
          ],
          "postconditions": [
            "stockLevel increased",
            "audit log created"
          ],
          "emits": "InventoryRestocked"
        },
        {
          "name": "setLowStockThreshold",
          "command": "SetLowStockThreshold",
          "preconditions": [
            "threshold \u003e= 0"
          ],
          "postconditions": [
            "lowStockThreshold set"
          ],
          "emits": "LowStockThresholdSet"
        }
      ],
      "events": [
        {
          "name": "InventoryQuantitySet",
          "payload": [
            "inventoryId",
            "productId",
            "previousValue",
            "newValue",
            "reason",
            "userId"
          ]
        },
        {
          "name": "InventoryAdjusted",
          "payload": [
            "inventoryId",
            "productId",
            "adjustment",
            "newValue",
            "reason",
            "userId"
          ]
        },
        {
          "name": "InventoryReserved",
          "payload": [
            "inventoryId",
            "productId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryReleased",
          "payload": [
            "inventoryId",
            "productId",
            "quantity",
            "reason"
          ]
        },
        {
          "name": "InventoryDeducted",
          "payload": [
            "inventoryId",
            "productId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryRestocked",
          "payload": [
            "inventoryId",
            "productId",
            "quantity",
            "reason",
            "userId"
          ]
        },
        {
          "name": "LowStockAlert",
          "payload": [
            "inventoryId",
            "productId",
            "currentStock",
            "threshold"
          ]
        },
        {
          "name": "OutOfStock",
          "payload": [
            "inventoryId",
            "productId"
          ]
        },
        {
          "name": "LowStockThresholdSet",
          "payload": [
            "inventoryId",
            "productId",
            "threshold"
          ]
        }
      ],
      "repository": {
        "name": "InventoryRepository",
        "methods": [
          {
            "name": "findById",
            "params": "InventoryId",
            "returns": "Inventory?"
          },
          {
            "name": "findByProductId",
            "params": "ProductId",
            "returns": "Inventory?"
          },
          {
            "name": "findByProductIds",
            "params": "List\u003cProductId\u003e",
            "returns": "Map\u003cProductId, Inventory\u003e"
          },
          {
            "name": "findLowStock",
            "params": "",
            "returns": "List\u003cInventory\u003e"
          },
          {
            "name": "getAuditLog",
            "params": "ProductId, DateRange, Pagination",
            "returns": "Page\u003cInventoryAuditLog\u003e"
          },
          {
            "name": "save",
            "params": "Inventory",
            "returns": "void"
          }
        ],
        "loadStrategy": "Load inventory without audit log by default, load audit log on demand",
        "concurrency": "Pessimistic locking for reserve/release operations"
      },
      "externalReferences": [
        {
          "aggregate": "Product",
          "via": "productId",
          "type": "reference"
        }
      ]
    },
    {
      "id": "AGG-CATEGORY-001",
      "name": "Category",
      "purpose": "Organizes products into hierarchical browsing structure",
      "invariants": [
        {
          "id": "INV-CAT-001",
          "rule": "Category name must be unique",
          "enforcement": "Database unique constraint"
        },
        {
          "id": "INV-CAT-002",
          "rule": "Category cannot be its own parent (no circular references)",
          "enforcement": "Validation on parent assignment"
        },
        {
          "id": "INV-CAT-003",
          "rule": "Category hierarchy limited to 3 levels deep",
          "enforcement": "Depth calculation and validation on create/move"
        },
        {
          "id": "INV-CAT-004",
          "rule": "Category name must be 1-100 characters",
          "enforcement": "Validation on creation and update"
        }
      ],
      "root": {
        "entity": "Category",
        "identity": "CategoryId (UUID)",
        "attributes": [
          {
            "name": "categoryId",
            "type": "CategoryId",
            "mutable": false
          },
          {
            "name": "name",
            "type": "string",
            "mutable": true
          },
          {
            "name": "description",
            "type": "string",
            "mutable": true
          },
          {
            "name": "parentCategoryId",
            "type": "CategoryId",
            "mutable": true
          },
          {
            "name": "depth",
            "type": "integer",
            "mutable": true
          },
          {
            "name": "displayOrder",
            "type": "integer",
            "mutable": true
          },
          {
            "name": "isActive",
            "type": "boolean",
            "mutable": true
          },
          {
            "name": "createdAt",
            "type": "DateTime",
            "mutable": false
          }
        ]
      },
      "entities": [],
      "valueObjects": [],
      "behaviors": [
        {
          "name": "create",
          "command": "CreateCategory",
          "preconditions": [
            "name unique",
            "name 1-100 chars",
            "parent exists if specified",
            "resulting depth \u003c= 3"
          ],
          "postconditions": [
            "category created",
            "depth calculated"
          ],
          "emits": "CategoryCreated"
        },
        {
          "name": "update",
          "command": "UpdateCategory",
          "preconditions": [
            "category exists",
            "name unique if changed"
          ],
          "postconditions": [
            "attributes updated"
          ],
          "emits": "CategoryUpdated"
        },
        {
          "name": "move",
          "command": "MoveCategory",
          "preconditions": [
            "category exists",
            "new parent exists",
            "no circular reference",
            "resulting depth \u003c= 3"
          ],
          "postconditions": [
            "parentCategoryId updated",
            "depth recalculated for subtree"
          ],
          "emits": "CategoryMoved"
        },
        {
          "name": "deactivate",
          "command": "DeactivateCategory",
          "preconditions": [
            "category exists",
            "no active products in category"
          ],
          "postconditions": [
            "isActive == false"
          ],
          "emits": "CategoryDeactivated"
        }
      ],
      "events": [
        {
          "name": "CategoryCreated",
          "payload": [
            "categoryId",
            "name",
            "parentCategoryId",
            "depth"
          ]
        },
        {
          "name": "CategoryUpdated",
          "payload": [
            "categoryId",
            "changedFields"
          ]
        },
        {
          "name": "CategoryMoved",
          "payload": [
            "categoryId",
            "oldParentId",
            "newParentId",
            "newDepth"
          ]
        },
        {
          "name": "CategoryDeactivated",
          "payload": [
            "categoryId",
            "deactivatedAt"
          ]
        }
      ],
      "repository": {
        "name": "CategoryRepository",
        "methods": [
          {
            "name": "findById",
            "params": "CategoryId",
            "returns": "Category?"
          },
          {
            "name": "findByName",
            "params": "string",
            "returns": "Category?"
          },
          {
            "name": "findRootCategories",
            "params": "",
            "returns": "List\u003cCategory\u003e"
          },
          {
            "name": "findChildren",
            "params": "CategoryId",
            "returns": "List\u003cCategory\u003e"
          },
          {
            "name": "findAll",
            "params": "",
            "returns": "List\u003cCategory\u003e"
          },
          {
            "name": "existsByName",
            "params": "string",
            "returns": "boolean"
          },
          {
            "name": "save",
            "params": "Category",
            "returns": "void"
          }
        ],
        "loadStrategy": "Load category without children, load hierarchy on demand",
        "concurrency": "Optimistic locking via version field"
      },
      "externalReferences": []
    }
  ],
  "enums": [
    {
      "name": "order_status",
      "values": [
        "pending",
        "confirmed",
        "shipped",
        "delivered",
        "cancelled"
      ]
    },
    {
      "name": "payment_type",
      "values": [
        "credit_card",
        "paypal"
      ]
    },
    {
      "name": "card_brand",
      "values": [
        "visa",
        "mastercard",
        "amex"
      ]
    },
    {
      "name": "registration_status",
      "values": [
        "unverified",
        "registered"
      ]
    },
    {
      "name": "product_status",
      "values": [
        "draft",
        "active",
        "inactive"
      ]
    },
    {
      "name": "inventory_operation_type",
      "values": [
        "set",
        "adjust",
        "reserve",
        "release",
        "deduct",
        "restock"
      ]
    },
    {
      "name": "email_type",
      "values": [
        "order_confirmation",
        "order_shipped",
        "order_cancelled",
        "verification",
        "password_reset"
      ]
    },
    {
      "name": "email_status",
      "values": [
        "pending",
        "processing",
        "sent",
        "failed"
      ]
    }
  ],
  "interface_contracts": [
    {
      "id": "IC-CUSTOMER-001",
      "serviceName": "Customer Service",
      "purpose": "Manages customer registration, authentication, addresses, and account lifecycle",
      "baseUrl": "/api/v1/customers",
      "operations": [
        {
          "id": "OP-CUST-001",
          "name": "registerCustomer",
          "method": "POST",
          "path": "/register",
          "description": "Register a new customer account",
          "inputSchema": {
            "email": {
              "type": "Email",
              "required": true
            },
            "firstName": {
              "type": "string",
              "required": true
            },
            "lastName": {
              "type": "string",
              "required": true
            },
            "password": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "createdAt": {
              "type": "DateTime"
            },
            "customerId": {
              "type": "UUID"
            },
            "email": {
              "type": "Email"
            },
            "status": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "DUPLICATE_EMAIL",
              "httpStatus": 409,
              "message": "Email already registered. Please login or reset password"
            },
            {
              "code": "INVALID_PASSWORD",
              "httpStatus": 400,
              "message": "Password must be at least 8 characters with at least one number"
            },
            {
              "code": "INVALID_EMAIL",
              "httpStatus": 400,
              "message": "Invalid email format"
            }
          ],
          "preconditions": [
            "Email not already registered"
          ],
          "postconditions": [
            "Customer account created with status 'unverified'",
            "Verification email sent",
            "CustomerRegistered event emitted"
          ],
          "relatedACs": [
            "AC-CUST-001"
          ],
          "relatedBRs": [
            "BR-CUST-002",
            "BR-CUST-003"
          ]
        },
        {
          "id": "OP-CUST-002",
          "name": "verifyEmail",
          "method": "POST",
          "path": "/verify-email",
          "description": "Verify customer email address with token",
          "inputSchema": {
            "token": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "customerId": {
              "type": "UUID"
            },
            "emailVerified": {
              "type": "boolean"
            }
          },
          "errors": [
            {
              "code": "INVALID_TOKEN",
              "httpStatus": 400,
              "message": "Invalid verification token"
            },
            {
              "code": "VERIFICATION_EXPIRED",
              "httpStatus": 410,
              "message": "Verification link expired. Please request a new one"
            }
          ],
          "preconditions": [
            "Valid verification token exists"
          ],
          "postconditions": [
            "Customer emailVerified set to true"
          ],
          "relatedACs": [
            "AC-CUST-002"
          ],
          "relatedBRs": [
            "BR-CUST-001"
          ]
        },
        {
          "id": "OP-CUST-003",
          "name": "addShippingAddress",
          "method": "POST",
          "path": "/{customerId}/addresses",
          "description": "Add a new shipping address to customer account",
          "inputSchema": {
            "city": {
              "type": "string",
              "required": true
            },
            "country": {
              "type": "string",
              "required": true
            },
            "isDefault": {
              "type": "boolean"
            },
            "postalCode": {
              "type": "string",
              "required": true
            },
            "recipientName": {
              "type": "string",
              "required": true
            },
            "state": {
              "type": "string",
              "required": true
            },
            "street": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "addressId": {
              "type": "UUID"
            },
            "city": {
              "type": "string"
            },
            "country": {
              "type": "string"
            },
            "isDefault": {
              "type": "boolean"
            },
            "postalCode": {
              "type": "string"
            },
            "recipientName": {
              "type": "string"
            },
            "state": {
              "type": "string"
            },
            "street": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "INVALID_ADDRESS",
              "httpStatus": 400,
              "message": "Missing required field: {fieldName}"
            },
            {
              "code": "INVALID_POSTAL_CODE",
              "httpStatus": 400,
              "message": "Invalid postal code format"
            },
            {
              "code": "UNSUPPORTED_SHIPPING_REGION",
              "httpStatus": 400,
              "message": "Shipping not available to this country"
            },
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            }
          ],
          "preconditions": [
            "Customer exists",
            "Country is domestic"
          ],
          "postconditions": [
            "Address saved to customer account"
          ],
          "relatedACs": [
            "AC-CUST-003"
          ],
          "relatedBRs": [
            "BR-SHIP-001",
            "BR-SHIP-002"
          ]
        },
        {
          "id": "OP-CUST-004",
          "name": "getCustomerAddresses",
          "method": "GET",
          "path": "/{customerId}/addresses",
          "description": "Get all shipping addresses for a customer",
          "inputSchema": {},
          "outputSchema": {
            "addresses": {
              "type": "array"
            }
          },
          "errors": [
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            }
          ],
          "preconditions": [
            "Customer exists"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-CUST-003"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CUST-005",
          "name": "requestDataErasure",
          "method": "POST",
          "path": "/{customerId}/gdpr/erase",
          "description": "Request GDPR data erasure for customer account",
          "inputSchema": {
            "confirmDeletion": {
              "type": "boolean",
              "required": true
            }
          },
          "outputSchema": {
            "erasedAt": {
              "type": "DateTime"
            },
            "status": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "PENDING_ORDERS_EXIST",
              "httpStatus": 409,
              "message": "Cannot delete account with pending orders"
            },
            {
              "code": "CUSTOMER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Customer not found"
            }
          ],
          "preconditions": [
            "Customer exists",
            "No pending orders"
          ],
          "postconditions": [
            "Personal data permanently deleted",
            "Order history anonymized",
            "Confirmation email sent"
          ],
          "relatedACs": [
            "AC-CUST-004"
          ],
          "relatedBRs": []
        }
      ],
      "events": [
        {
          "name": "CustomerRegistered",
          "description": "Emitted when a new customer registers",
          "payload": [
            "customerId",
            "email",
            "createdAt"
          ]
        },
        {
          "name": "CustomerEmailVerified",
          "description": "Emitted when customer verifies their email",
          "payload": [
            "customerId",
            "email",
            "verifiedAt"
          ]
        },
        {
          "name": "CustomerDataErased",
          "description": "Emitted when customer data is erased per GDPR",
          "payload": [
            "anonymizedId",
            "erasedAt"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT (except registration)",
        "authorization": "Customer can only access own data"
      }
    },
    {
      "id": "IC-PRODUCT-001",
      "serviceName": "Product Service",
      "purpose": "Manages product catalog, variants, and browsing functionality",
      "baseUrl": "/api/v1/products",
      "operations": [
        {
          "id": "OP-PROD-001",
          "name": "listProducts",
          "method": "GET",
          "path": "/",
          "description": "Browse products with filters, sorting, and pagination",
          "inputSchema": {
            "availability": {
              "type": "enum"
            },
            "categoryId": {
              "type": "UUID"
            },
            "maxPrice": {
              "type": "Money"
            },
            "minPrice": {
              "type": "Money"
            },
            "page": {
              "type": "integer"
            },
            "pageSize": {
              "type": "integer"
            },
            "sortBy": {
              "type": "enum"
            }
          },
          "outputSchema": {
            "pagination": {
              "type": "Pagination"
            },
            "products": {
              "type": "array"
            }
          },
          "errors": [
            {
              "code": "INVALID_CATEGORY",
              "httpStatus": 400,
              "message": "Category not found"
            }
          ],
          "preconditions": [],
          "postconditions": [],
          "relatedACs": [
            "AC-PROD-001",
            "AC-PROD-002"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-PROD-002",
          "name": "getProduct",
          "method": "GET",
          "path": "/{productId}",
          "description": "Get product details including variants and stock status",
          "inputSchema": {},
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "categoryId": {
              "type": "UUID"
            },
            "categoryName": {
              "type": "string"
            },
            "description": {
              "type": "string"
            },
            "hasVariants": {
              "type": "boolean"
            },
            "images": {
              "type": "array"
            },
            "isInStock": {
              "type": "boolean"
            },
            "name": {
              "type": "string"
            },
            "price": {
              "type": "Money"
            },
            "productId": {
              "type": "UUID"
            },
            "variants": {
              "type": "array"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            }
          ],
          "preconditions": [
            "Product exists and is active"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-PROD-002",
            "AC-PROD-003"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-PROD-003",
          "name": "createProduct",
          "method": "POST",
          "path": "/",
          "description": "Create a new product (admin only)",
          "inputSchema": {
            "categoryId": {
              "type": "UUID",
              "required": true
            },
            "description": {
              "type": "string"
            },
            "name": {
              "type": "string",
              "required": true
            },
            "price": {
              "type": "Money",
              "required": true
            }
          },
          "outputSchema": {
            "createdAt": {
              "type": "DateTime"
            },
            "createdBy": {
              "type": "UUID"
            },
            "name": {
              "type": "string"
            },
            "productId": {
              "type": "UUID"
            },
            "status": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "NAME_REQUIRED",
              "httpStatus": 400,
              "message": "Product name is required"
            },
            {
              "code": "NAME_TOO_LONG",
              "httpStatus": 400,
              "message": "Product name cannot exceed 200 characters"
            },
            {
              "code": "INVALID_PRICE",
              "httpStatus": 400,
              "message": "Price must be at least $0.01"
            },
            {
              "code": "CATEGORY_REQUIRED",
              "httpStatus": 400,
              "message": "Category is required"
            },
            {
              "code": "CATEGORY_NOT_FOUND",
              "httpStatus": 404,
              "message": "Category not found"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Category exists"
          ],
          "postconditions": [
            "Product created with status 'draft'",
            "ProductCreated event emitted"
          ],
          "relatedACs": [
            "AC-ADMIN-001"
          ],
          "relatedBRs": [
            "BR-PROD-001",
            "BR-PROD-002"
          ]
        },
        {
          "id": "OP-PROD-004",
          "name": "updateProduct",
          "method": "PUT",
          "path": "/{productId}",
          "description": "Update product details (admin only)",
          "inputSchema": {
            "categoryId": {
              "type": "UUID"
            },
            "description": {
              "type": "string"
            },
            "name": {
              "type": "string"
            },
            "price": {
              "type": "Money"
            }
          },
          "outputSchema": {
            "name": {
              "type": "string"
            },
            "price": {
              "type": "Money"
            },
            "productId": {
              "type": "UUID"
            },
            "updatedAt": {
              "type": "DateTime"
            },
            "updatedBy": {
              "type": "UUID"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "NAME_TOO_LONG",
              "httpStatus": 400,
              "message": "Product name cannot exceed 200 characters"
            },
            {
              "code": "INVALID_PRICE",
              "httpStatus": 400,
              "message": "Price must be at least $0.01"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Product exists"
          ],
          "postconditions": [
            "Product updated",
            "Change logged",
            "ProductUpdated event emitted"
          ],
          "relatedACs": [
            "AC-ADMIN-003",
            "AC-ADMIN-004"
          ],
          "relatedBRs": [
            "BR-PROD-001",
            "BR-PROD-002"
          ]
        },
        {
          "id": "OP-PROD-005",
          "name": "deleteProduct",
          "method": "DELETE",
          "path": "/{productId}",
          "description": "Soft delete a product (admin only)",
          "inputSchema": {},
          "outputSchema": {
            "deletedAt": {
              "type": "DateTime"
            },
            "productId": {
              "type": "UUID"
            },
            "status": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Product exists"
          ],
          "postconditions": [
            "Product soft-deleted",
            "Cart items with product removed",
            "ProductDeactivated event emitted"
          ],
          "relatedACs": [
            "AC-ADMIN-005"
          ],
          "relatedBRs": [
            "BR-PROD-003"
          ]
        },
        {
          "id": "OP-PROD-006",
          "name": "uploadProductImages",
          "method": "POST",
          "path": "/{productId}/images",
          "description": "Upload images for a product (admin only)",
          "inputSchema": {
            "images": {
              "type": "array",
              "required": true
            },
            "primaryIndex": {
              "type": "integer"
            }
          },
          "outputSchema": {
            "images": {
              "type": "array"
            },
            "primaryImageUrl": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "MAX_IMAGES_EXCEEDED",
              "httpStatus": 400,
              "message": "Maximum 10 images allowed"
            },
            {
              "code": "INVALID_IMAGE_FORMAT",
              "httpStatus": 400,
              "message": "Invalid image format. Allowed: JPG, PNG, WebP"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Product exists"
          ],
          "postconditions": [
            "Images uploaded to cloud storage",
            "URLs stored on product"
          ],
          "relatedACs": [
            "AC-ADMIN-002"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-PROD-007",
          "name": "addProductVariant",
          "method": "POST",
          "path": "/{productId}/variants",
          "description": "Add a variant to a product (admin only)",
          "inputSchema": {
            "color": {
              "type": "string"
            },
            "priceAdjustment": {
              "type": "Money"
            },
            "size": {
              "type": "string"
            },
            "sku": {
              "type": "SKU",
              "required": true
            }
          },
          "outputSchema": {
            "color": {
              "type": "string"
            },
            "priceAdjustment": {
              "type": "Money"
            },
            "size": {
              "type": "string"
            },
            "sku": {
              "type": "SKU"
            },
            "variantId": {
              "type": "UUID"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "DUPLICATE_SKU",
              "httpStatus": 409,
              "message": "SKU already exists"
            },
            {
              "code": "VARIANT_REQUIRED",
              "httpStatus": 400,
              "message": "At least size or color must be specified"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Product exists",
            "SKU is unique"
          ],
          "postconditions": [
            "Variant added to product",
            "ProductVariantAdded event emitted"
          ],
          "relatedACs": [
            "AC-PROD-003"
          ],
          "relatedBRs": [
            "BR-PROD-004"
          ]
        }
      ],
      "events": [
        {
          "name": "ProductCreated",
          "description": "Emitted when a new product is created",
          "payload": [
            "productId",
            "name",
            "price",
            "categoryId",
            "createdBy"
          ]
        },
        {
          "name": "ProductUpdated",
          "description": "Emitted when a product is updated",
          "payload": [
            "productId",
            "changedFields",
            "updatedBy"
          ]
        },
        {
          "name": "ProductDeactivated",
          "description": "Emitted when a product is soft-deleted",
          "payload": [
            "productId",
            "deletedBy"
          ]
        },
        {
          "name": "ProductVariantAdded",
          "description": "Emitted when a variant is added to a product",
          "payload": [
            "productId",
            "variantId",
            "sku"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT (admin operations only)",
        "authorization": "Admin role required for create/update/delete"
      }
    },
    {
      "id": "IC-CART-001",
      "serviceName": "Cart Service",
      "purpose": "Manages shopping cart operations including add, update, remove items",
      "baseUrl": "/api/v1/cart",
      "operations": [
        {
          "id": "OP-CART-001",
          "name": "getCart",
          "method": "GET",
          "path": "/",
          "description": "Get current customer's cart with all items",
          "inputSchema": {},
          "outputSchema": {
            "cartId": {
              "type": "UUID"
            },
            "hasOutOfStockItems": {
              "type": "boolean"
            },
            "itemCount": {
              "type": "integer"
            },
            "items": {
              "type": "array"
            },
            "priceChanges": {
              "type": "array"
            },
            "subtotal": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "CART_EXPIRED",
              "httpStatus": 410,
              "message": "Your cart has expired"
            }
          ],
          "preconditions": [],
          "postconditions": [
            "Price changes detected and returned if any"
          ],
          "relatedACs": [
            "AC-CART-007",
            "AC-CART-008"
          ],
          "relatedBRs": [
            "BR-CART-004"
          ]
        },
        {
          "id": "OP-CART-002",
          "name": "addToCart",
          "method": "POST",
          "path": "/items",
          "description": "Add a product to the cart",
          "inputSchema": {
            "productId": {
              "type": "UUID",
              "required": true
            },
            "quantity": {
              "type": "Quantity",
              "required": true
            },
            "variantId": {
              "type": "UUID"
            }
          },
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "cartId": {
              "type": "UUID"
            },
            "item": {
              "type": "CartItem"
            },
            "quantityLimited": {
              "type": "boolean"
            },
            "subtotal": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "OUT_OF_STOCK",
              "httpStatus": 400,
              "message": "Product is out of stock"
            },
            {
              "code": "INSUFFICIENT_STOCK",
              "httpStatus": 400,
              "message": "Only {available} units available"
            },
            {
              "code": "VARIANT_REQUIRED",
              "httpStatus": 400,
              "message": "Please select a variant"
            }
          ],
          "preconditions": [
            "Product exists and is active",
            "Product in stock",
            "Variant selected if product has variants"
          ],
          "postconditions": [
            "Item added or quantity updated",
            "Cart total recalculated",
            "ItemAddedToCart event emitted"
          ],
          "relatedACs": [
            "AC-CART-001",
            "AC-CART-002"
          ],
          "relatedBRs": [
            "BR-CART-001",
            "BR-CART-002",
            "BR-CART-003",
            "BR-CART-005"
          ]
        },
        {
          "id": "OP-CART-003",
          "name": "updateCartItemQuantity",
          "method": "PUT",
          "path": "/items/{itemId}",
          "description": "Update quantity of an item in the cart",
          "inputSchema": {
            "quantity": {
              "type": "Quantity",
              "required": true
            }
          },
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "cartId": {
              "type": "UUID"
            },
            "item": {
              "type": "CartItem"
            },
            "itemRemoved": {
              "type": "boolean"
            },
            "quantityLimited": {
              "type": "boolean"
            },
            "subtotal": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "ITEM_NOT_FOUND",
              "httpStatus": 404,
              "message": "Item not in cart"
            },
            {
              "code": "INSUFFICIENT_STOCK",
              "httpStatus": 400,
              "message": "Only {available} units available"
            }
          ],
          "preconditions": [
            "Item exists in cart"
          ],
          "postconditions": [
            "Quantity updated or item removed if 0",
            "Cart total recalculated",
            "CartItemQuantityUpdated event emitted"
          ],
          "relatedACs": [
            "AC-CART-004"
          ],
          "relatedBRs": [
            "BR-CART-002",
            "BR-CART-003"
          ]
        },
        {
          "id": "OP-CART-004",
          "name": "removeFromCart",
          "method": "DELETE",
          "path": "/items/{itemId}",
          "description": "Remove an item from the cart",
          "inputSchema": {},
          "outputSchema": {
            "cartId": {
              "type": "UUID"
            },
            "isEmpty": {
              "type": "boolean"
            },
            "itemCount": {
              "type": "integer"
            },
            "subtotal": {
              "type": "Money"
            },
            "undoToken": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "ITEM_NOT_FOUND",
              "httpStatus": 404,
              "message": "Item not in cart"
            }
          ],
          "preconditions": [
            "Item exists in cart"
          ],
          "postconditions": [
            "Item removed from cart",
            "Cart total recalculated",
            "ItemRemovedFromCart event emitted"
          ],
          "relatedACs": [
            "AC-CART-005",
            "AC-CART-006"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CART-005",
          "name": "undoRemove",
          "method": "POST",
          "path": "/items/undo",
          "description": "Undo recent item removal",
          "inputSchema": {
            "undoToken": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "cartId": {
              "type": "UUID"
            },
            "item": {
              "type": "CartItem"
            },
            "subtotal": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "UNDO_EXPIRED",
              "httpStatus": 410,
              "message": "Undo window has expired"
            },
            {
              "code": "INVALID_TOKEN",
              "httpStatus": 400,
              "message": "Invalid undo token"
            }
          ],
          "preconditions": [
            "Undo token valid and not expired"
          ],
          "postconditions": [
            "Item restored to cart"
          ],
          "relatedACs": [
            "AC-CART-005"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CART-006",
          "name": "mergeGuestCart",
          "method": "POST",
          "path": "/merge",
          "description": "Merge guest cart into authenticated customer's cart",
          "inputSchema": {
            "guestCartId": {
              "type": "UUID",
              "required": true
            }
          },
          "outputSchema": {
            "cartId": {
              "type": "UUID"
            },
            "items": {
              "type": "array"
            },
            "mergeNotifications": {
              "type": "array"
            },
            "subtotal": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "GUEST_CART_NOT_FOUND",
              "httpStatus": 404,
              "message": "Guest cart not found"
            }
          ],
          "preconditions": [
            "Customer authenticated",
            "Guest cart exists"
          ],
          "postconditions": [
            "Guest cart items merged",
            "Quantities limited to stock if exceeded"
          ],
          "relatedACs": [
            "AC-CART-003"
          ],
          "relatedBRs": [
            "BR-CART-002"
          ]
        }
      ],
      "events": [
        {
          "name": "ItemAddedToCart",
          "description": "Emitted when an item is added to cart",
          "payload": [
            "cartId",
            "productId",
            "variantId",
            "quantity"
          ]
        },
        {
          "name": "CartItemQuantityUpdated",
          "description": "Emitted when cart item quantity changes",
          "payload": [
            "cartId",
            "itemId",
            "oldQuantity",
            "newQuantity"
          ]
        },
        {
          "name": "ItemRemovedFromCart",
          "description": "Emitted when an item is removed from cart",
          "payload": [
            "cartId",
            "productId",
            "variantId"
          ]
        },
        {
          "name": "CartCleared",
          "description": "Emitted when cart is cleared (order placed or expired)",
          "payload": [
            "cartId",
            "reason"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT or guest session token",
        "authorization": "Customer can only access own cart"
      }
    },
    {
      "id": "IC-ORDER-001",
      "serviceName": "Order Service",
      "purpose": "Manages order lifecycle from placement through delivery or cancellation",
      "baseUrl": "/api/v1/orders",
      "operations": [
        {
          "id": "OP-ORDER-001",
          "name": "createOrder",
          "method": "POST",
          "path": "/",
          "description": "Create a new order from cart contents",
          "inputSchema": {
            "paymentMethod": {
              "type": "PaymentMethod",
              "required": true
            },
            "savePaymentMethod": {
              "type": "boolean"
            },
            "shippingAddressId": {
              "type": "UUID",
              "required": true
            }
          },
          "outputSchema": {
            "createdAt": {
              "type": "DateTime"
            },
            "lineItems": {
              "type": "array"
            },
            "orderId": {
              "type": "UUID"
            },
            "orderNumber": {
              "type": "string"
            },
            "shippingCost": {
              "type": "Money"
            },
            "status": {
              "type": "OrderStatus"
            },
            "subtotal": {
              "type": "Money"
            },
            "tax": {
              "type": "Money"
            },
            "totalAmount": {
              "type": "Money"
            }
          },
          "errors": [
            {
              "code": "CART_EMPTY",
              "httpStatus": 400,
              "message": "Cart has no items"
            },
            {
              "code": "EMAIL_NOT_VERIFIED",
              "httpStatus": 403,
              "message": "Please verify your email before ordering"
            },
            {
              "code": "STOCK_UNAVAILABLE",
              "httpStatus": 409,
              "message": "Item {productName} is out of stock"
            },
            {
              "code": "PAYMENT_FAILED",
              "httpStatus": 402,
              "message": "Payment authorization failed"
            },
            {
              "code": "PAYMENT_DECLINED",
              "httpStatus": 402,
              "message": "Card declined: {reason}"
            },
            {
              "code": "INVALID_CARD",
              "httpStatus": 400,
              "message": "Invalid card number"
            },
            {
              "code": "UNSUPPORTED_CARD_TYPE",
              "httpStatus": 400,
              "message": "Card type not accepted. Use Visa, Mastercard, or Amex"
            },
            {
              "code": "INVALID_ADDRESS",
              "httpStatus": 400,
              "message": "Invalid shipping address"
            },
            {
              "code": "ADDRESS_NOT_FOUND",
              "httpStatus": 404,
              "message": "Shipping address not found"
            }
          ],
          "preconditions": [
            "Customer registered and email verified",
            "Cart has items",
            "All items in stock",
            "Valid shipping address",
            "Valid payment method"
          ],
          "postconditions": [
            "Order created with status 'pending'",
            "Payment authorized",
            "Inventory decremented",
            "Cart cleared",
            "Confirmation email queued",
            "OrderPlaced event emitted"
          ],
          "relatedACs": [
            "AC-ORDER-001",
            "AC-ORDER-002",
            "AC-ORDER-003",
            "AC-ORDER-004",
            "AC-ORDER-005",
            "AC-PAY-001",
            "AC-PAY-002"
          ],
          "relatedBRs": [
            "BR-CUST-001",
            "BR-ORDER-001",
            "BR-ORDER-005",
            "BR-ORDER-006",
            "BR-INV-002",
            "BR-PAY-001",
            "BR-PAY-002",
            "BR-EMAIL-001"
          ]
        },
        {
          "id": "OP-ORDER-002",
          "name": "getOrder",
          "method": "GET",
          "path": "/{orderId}",
          "description": "Get order details including tracking information",
          "inputSchema": {},
          "outputSchema": {
            "createdAt": {
              "type": "DateTime"
            },
            "lineItems": {
              "type": "array"
            },
            "orderId": {
              "type": "UUID"
            },
            "orderNumber": {
              "type": "string"
            },
            "shippingAddress": {
              "type": "Address"
            },
            "shippingCost": {
              "type": "Money"
            },
            "status": {
              "type": "OrderStatus"
            },
            "subtotal": {
              "type": "Money"
            },
            "tax": {
              "type": "Money"
            },
            "totalAmount": {
              "type": "Money"
            },
            "trackingNumber": {
              "type": "string"
            },
            "trackingUrl": {
              "type": "string"
            },
            "updatedAt": {
              "type": "DateTime"
            }
          },
          "errors": [
            {
              "code": "ORDER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Order not found"
            }
          ],
          "preconditions": [
            "Order exists",
            "Customer owns order or is admin"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ORDER-006",
            "AC-ORDER-007"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-ORDER-003",
          "name": "listCustomerOrders",
          "method": "GET",
          "path": "/",
          "description": "List customer's orders with pagination",
          "inputSchema": {
            "page": {
              "type": "integer"
            },
            "pageSize": {
              "type": "integer"
            },
            "status": {
              "type": "OrderStatus"
            }
          },
          "outputSchema": {
            "orders": {
              "type": "array"
            },
            "pagination": {
              "type": "Pagination"
            }
          },
          "errors": [],
          "preconditions": [
            "Customer authenticated"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ORDER-006"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-ORDER-004",
          "name": "cancelOrder",
          "method": "POST",
          "path": "/{orderId}/cancel",
          "description": "Cancel an order (customer or admin)",
          "inputSchema": {
            "reason": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "cancelledAt": {
              "type": "DateTime"
            },
            "orderId": {
              "type": "UUID"
            },
            "refundStatus": {
              "type": "string"
            },
            "status": {
              "type": "OrderStatus"
            }
          },
          "errors": [
            {
              "code": "ORDER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Order not found"
            },
            {
              "code": "ORDER_ALREADY_SHIPPED",
              "httpStatus": 400,
              "message": "Cannot cancel shipped order"
            },
            {
              "code": "ORDER_NOT_MODIFIABLE",
              "httpStatus": 400,
              "message": "Order cannot be modified"
            },
            {
              "code": "REFUND_FAILED",
              "httpStatus": 500,
              "message": "Refund processing failed"
            }
          ],
          "preconditions": [
            "Order exists",
            "Status is pending or confirmed"
          ],
          "postconditions": [
            "Status set to cancelled",
            "Inventory restored",
            "Refund initiated",
            "Cancellation email sent",
            "OrderCancelled event emitted"
          ],
          "relatedACs": [
            "AC-ORDER-008",
            "AC-ORDER-009",
            "AC-ORDER-010"
          ],
          "relatedBRs": [
            "BR-ORDER-002",
            "BR-ORDER-004",
            "BR-INV-003",
            "BR-PAY-003"
          ]
        },
        {
          "id": "OP-ORDER-005",
          "name": "listAllOrders",
          "method": "GET",
          "path": "/admin",
          "description": "List all orders with filters (admin only)",
          "inputSchema": {
            "endDate": {
              "type": "Date"
            },
            "page": {
              "type": "integer"
            },
            "pageSize": {
              "type": "integer"
            },
            "search": {
              "type": "string"
            },
            "startDate": {
              "type": "Date"
            },
            "status": {
              "type": "OrderStatus"
            }
          },
          "outputSchema": {
            "orders": {
              "type": "array"
            },
            "pagination": {
              "type": "Pagination"
            }
          },
          "errors": [],
          "preconditions": [
            "Admin authenticated"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ADMIN-006"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-ORDER-006",
          "name": "exportOrders",
          "method": "GET",
          "path": "/admin/export",
          "description": "Export filtered orders to CSV (admin only)",
          "inputSchema": {
            "endDate": {
              "type": "Date"
            },
            "search": {
              "type": "string"
            },
            "startDate": {
              "type": "Date"
            },
            "status": {
              "type": "OrderStatus"
            }
          },
          "outputSchema": {
            "contentType": {
              "type": "string"
            },
            "data": {
              "type": "binary"
            },
            "filename": {
              "type": "string"
            }
          },
          "errors": [],
          "preconditions": [
            "Admin authenticated"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ADMIN-007"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-ORDER-007",
          "name": "updateOrderStatus",
          "method": "PUT",
          "path": "/{orderId}/status",
          "description": "Update order status (admin only)",
          "inputSchema": {
            "status": {
              "type": "OrderStatus",
              "required": true
            },
            "trackingNumber": {
              "type": "string"
            }
          },
          "outputSchema": {
            "orderId": {
              "type": "UUID"
            },
            "status": {
              "type": "OrderStatus"
            },
            "trackingNumber": {
              "type": "string"
            },
            "updatedAt": {
              "type": "DateTime"
            }
          },
          "errors": [
            {
              "code": "ORDER_NOT_FOUND",
              "httpStatus": 404,
              "message": "Order not found"
            },
            {
              "code": "INVALID_STATUS_TRANSITION",
              "httpStatus": 400,
              "message": "Cannot transition from {current} to {new}"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Order exists",
            "Valid status transition"
          ],
          "postconditions": [
            "Status updated",
            "Change logged",
            "Customer email sent if shipped",
            "OrderConfirmed/OrderShipped/OrderDelivered event emitted"
          ],
          "relatedACs": [
            "AC-ADMIN-008"
          ],
          "relatedBRs": [
            "BR-ORDER-003"
          ]
        }
      ],
      "events": [
        {
          "name": "OrderPlaced",
          "description": "Emitted when a new order is placed",
          "payload": [
            "orderId",
            "orderNumber",
            "customerId",
            "totalAmount",
            "lineItems"
          ]
        },
        {
          "name": "OrderConfirmed",
          "description": "Emitted when order is confirmed",
          "payload": [
            "orderId",
            "orderNumber",
            "confirmedAt"
          ]
        },
        {
          "name": "OrderShipped",
          "description": "Emitted when order is shipped",
          "payload": [
            "orderId",
            "orderNumber",
            "trackingNumber",
            "shippedAt"
          ]
        },
        {
          "name": "OrderDelivered",
          "description": "Emitted when order is delivered",
          "payload": [
            "orderId",
            "orderNumber",
            "deliveredAt"
          ]
        },
        {
          "name": "OrderCancelled",
          "description": "Emitted when order is cancelled",
          "payload": [
            "orderId",
            "orderNumber",
            "reason",
            "cancelledAt"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT",
        "authorization": "Customer can only access own orders, admin for all operations"
      }
    },
    {
      "id": "IC-INVENTORY-001",
      "serviceName": "Inventory Service",
      "purpose": "Manages product stock levels, reservations, and audit trails",
      "baseUrl": "/api/v1/inventory",
      "operations": [
        {
          "id": "OP-INV-001",
          "name": "getInventory",
          "method": "GET",
          "path": "/{productId}",
          "description": "Get inventory status for a product",
          "inputSchema": {},
          "outputSchema": {
            "availableQuantity": {
              "type": "integer"
            },
            "isLowStock": {
              "type": "boolean"
            },
            "lowStockThreshold": {
              "type": "integer"
            },
            "productId": {
              "type": "UUID"
            },
            "reservedQuantity": {
              "type": "integer"
            },
            "stockLevel": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Product exists"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ADMIN-009",
            "AC-ADMIN-012"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-INV-002",
          "name": "setInventory",
          "method": "PUT",
          "path": "/{productId}",
          "description": "Set absolute inventory quantity (admin only)",
          "inputSchema": {
            "quantity": {
              "type": "integer",
              "required": true
            },
            "reason": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "auditLogId": {
              "type": "UUID"
            },
            "newQuantity": {
              "type": "integer"
            },
            "previousQuantity": {
              "type": "integer"
            },
            "productId": {
              "type": "UUID"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "INVALID_QUANTITY",
              "httpStatus": 400,
              "message": "Quantity cannot be negative"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Product exists"
          ],
          "postconditions": [
            "Stock level updated",
            "Audit log created",
            "Low stock alert if below threshold"
          ],
          "relatedACs": [
            "AC-ADMIN-009"
          ],
          "relatedBRs": [
            "BR-INV-001",
            "BR-INV-004"
          ]
        },
        {
          "id": "OP-INV-003",
          "name": "adjustInventory",
          "method": "POST",
          "path": "/{productId}/adjust",
          "description": "Adjust inventory by delta (admin only)",
          "inputSchema": {
            "adjustment": {
              "type": "integer",
              "required": true
            },
            "reason": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "adjustment": {
              "type": "integer"
            },
            "auditLogId": {
              "type": "UUID"
            },
            "newQuantity": {
              "type": "integer"
            },
            "previousQuantity": {
              "type": "integer"
            },
            "productId": {
              "type": "UUID"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            },
            {
              "code": "INSUFFICIENT_STOCK",
              "httpStatus": 400,
              "message": "Adjustment would result in negative stock"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Product exists",
            "Result \u003e= 0"
          ],
          "postconditions": [
            "Stock level adjusted",
            "Audit log created",
            "Low stock alert if below threshold"
          ],
          "relatedACs": [
            "AC-ADMIN-010"
          ],
          "relatedBRs": [
            "BR-INV-001",
            "BR-INV-004"
          ]
        },
        {
          "id": "OP-INV-004",
          "name": "bulkUpdateInventory",
          "method": "POST",
          "path": "/bulk",
          "description": "Bulk update inventory from CSV (admin only)",
          "inputSchema": {
            "file": {
              "type": "File",
              "required": true
            }
          },
          "outputSchema": {
            "errorCount": {
              "type": "integer"
            },
            "errors": {
              "type": "array"
            },
            "successCount": {
              "type": "integer"
            },
            "totalRows": {
              "type": "integer"
            }
          },
          "errors": [
            {
              "code": "INVALID_FILE_FORMAT",
              "httpStatus": 400,
              "message": "Invalid CSV format"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Valid CSV file"
          ],
          "postconditions": [
            "Valid rows updated",
            "Audit logs created",
            "Errors reported"
          ],
          "relatedACs": [
            "AC-ADMIN-011"
          ],
          "relatedBRs": [
            "BR-INV-001",
            "BR-INV-004"
          ]
        },
        {
          "id": "OP-INV-005",
          "name": "getAuditLog",
          "method": "GET",
          "path": "/{productId}/audit",
          "description": "Get inventory audit log for a product (admin only)",
          "inputSchema": {
            "endDate": {
              "type": "Date"
            },
            "page": {
              "type": "integer"
            },
            "pageSize": {
              "type": "integer"
            },
            "startDate": {
              "type": "Date"
            }
          },
          "outputSchema": {
            "auditEntries": {
              "type": "array"
            },
            "pagination": {
              "type": "Pagination"
            },
            "productId": {
              "type": "UUID"
            }
          },
          "errors": [
            {
              "code": "PRODUCT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Product not found"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Product exists"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-ADMIN-009",
            "AC-ADMIN-010"
          ],
          "relatedBRs": [
            "BR-INV-004"
          ]
        }
      ],
      "events": [
        {
          "name": "InventoryReserved",
          "description": "Emitted when inventory is reserved for checkout",
          "payload": [
            "productId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryReleased",
          "description": "Emitted when reserved inventory is released",
          "payload": [
            "productId",
            "quantity",
            "reason"
          ]
        },
        {
          "name": "InventoryDeducted",
          "description": "Emitted when inventory is deducted after order",
          "payload": [
            "productId",
            "quantity",
            "orderId"
          ]
        },
        {
          "name": "InventoryRestocked",
          "description": "Emitted when inventory is restocked",
          "payload": [
            "productId",
            "quantity",
            "reason",
            "userId"
          ]
        },
        {
          "name": "LowStockAlert",
          "description": "Emitted when stock falls below threshold",
          "payload": [
            "productId",
            "currentStock",
            "threshold"
          ]
        },
        {
          "name": "OutOfStock",
          "description": "Emitted when product becomes out of stock",
          "payload": [
            "productId"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT",
        "authorization": "Admin role required for all operations"
      }
    },
    {
      "id": "IC-CATEGORY-001",
      "serviceName": "Category Service",
      "purpose": "Manages product category hierarchy",
      "baseUrl": "/api/v1/categories",
      "operations": [
        {
          "id": "OP-CAT-001",
          "name": "listCategories",
          "method": "GET",
          "path": "/",
          "description": "List all categories in hierarchical structure",
          "inputSchema": {
            "flat": {
              "type": "boolean"
            }
          },
          "outputSchema": {
            "categories": {
              "type": "array"
            }
          },
          "errors": [],
          "preconditions": [],
          "postconditions": [],
          "relatedACs": [
            "AC-PROD-001"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-CAT-002",
          "name": "createCategory",
          "method": "POST",
          "path": "/",
          "description": "Create a new category (admin only)",
          "inputSchema": {
            "description": {
              "type": "string"
            },
            "displayOrder": {
              "type": "integer"
            },
            "name": {
              "type": "string",
              "required": true
            },
            "parentCategoryId": {
              "type": "UUID"
            }
          },
          "outputSchema": {
            "categoryId": {
              "type": "UUID"
            },
            "depth": {
              "type": "integer"
            },
            "name": {
              "type": "string"
            },
            "parentCategoryId": {
              "type": "UUID"
            }
          },
          "errors": [
            {
              "code": "DUPLICATE_CATEGORY_NAME",
              "httpStatus": 409,
              "message": "Category name already exists"
            },
            {
              "code": "PARENT_NOT_FOUND",
              "httpStatus": 404,
              "message": "Parent category not found"
            },
            {
              "code": "MAX_NESTING_EXCEEDED",
              "httpStatus": 400,
              "message": "Category nesting limited to 3 levels"
            }
          ],
          "preconditions": [
            "Admin authenticated",
            "Name is unique",
            "Nesting depth \u003c= 3"
          ],
          "postconditions": [
            "Category created",
            "CategoryCreated event emitted"
          ],
          "relatedACs": [
            "AC-ADMIN-013"
          ],
          "relatedBRs": [
            "BR-CAT-001"
          ]
        }
      ],
      "events": [
        {
          "name": "CategoryCreated",
          "description": "Emitted when a new category is created",
          "payload": [
            "categoryId",
            "name",
            "parentCategoryId"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT (admin operations only)",
        "authorization": "Admin role required for create/update/delete"
      }
    },
    {
      "id": "IC-PAYMENT-001",
      "serviceName": "Payment Service",
      "purpose": "Handles payment processing, authorization, and saved payment methods",
      "baseUrl": "/api/v1/payments",
      "operations": [
        {
          "id": "OP-PAY-001",
          "name": "getSavedPaymentMethods",
          "method": "GET",
          "path": "/methods",
          "description": "Get customer's saved payment methods",
          "inputSchema": {},
          "outputSchema": {
            "paymentMethods": {
              "type": "array"
            }
          },
          "errors": [],
          "preconditions": [
            "Customer authenticated"
          ],
          "postconditions": [],
          "relatedACs": [
            "AC-PAY-003"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-PAY-002",
          "name": "savePaymentMethod",
          "method": "POST",
          "path": "/methods",
          "description": "Save a new payment method for future use",
          "inputSchema": {
            "isDefault": {
              "type": "boolean"
            },
            "token": {
              "type": "string",
              "required": true
            },
            "type": {
              "type": "enum",
              "required": true
            }
          },
          "outputSchema": {
            "isDefault": {
              "type": "boolean"
            },
            "lastFourDigits": {
              "type": "string"
            },
            "paymentMethodId": {
              "type": "UUID"
            },
            "type": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "INVALID_TOKEN",
              "httpStatus": 400,
              "message": "Invalid payment token"
            },
            {
              "code": "UNSUPPORTED_CARD_TYPE",
              "httpStatus": 400,
              "message": "Card type not accepted"
            }
          ],
          "preconditions": [
            "Customer authenticated",
            "Valid payment token"
          ],
          "postconditions": [
            "Payment method tokenized and saved"
          ],
          "relatedACs": [
            "AC-PAY-003"
          ],
          "relatedBRs": [
            "BR-PAY-002"
          ]
        },
        {
          "id": "OP-PAY-003",
          "name": "deletePaymentMethod",
          "method": "DELETE",
          "path": "/methods/{paymentMethodId}",
          "description": "Delete a saved payment method",
          "inputSchema": {},
          "outputSchema": {
            "deleted": {
              "type": "boolean"
            }
          },
          "errors": [
            {
              "code": "PAYMENT_METHOD_NOT_FOUND",
              "httpStatus": 404,
              "message": "Payment method not found"
            }
          ],
          "preconditions": [
            "Customer authenticated",
            "Payment method exists"
          ],
          "postconditions": [
            "Payment method deleted"
          ],
          "relatedACs": [
            "AC-PAY-003"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-PAY-004",
          "name": "initiatePayPalAuth",
          "method": "POST",
          "path": "/paypal/initiate",
          "description": "Initiate PayPal authorization flow",
          "inputSchema": {
            "amount": {
              "type": "Money",
              "required": true
            },
            "cancelUrl": {
              "type": "string",
              "required": true
            },
            "returnUrl": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "authorizationUrl": {
              "type": "string"
            },
            "paypalOrderId": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "PAYPAL_ERROR",
              "httpStatus": 500,
              "message": "PayPal service error"
            }
          ],
          "preconditions": [
            "Customer authenticated"
          ],
          "postconditions": [
            "PayPal authorization initiated"
          ],
          "relatedACs": [
            "AC-PAY-002"
          ],
          "relatedBRs": []
        },
        {
          "id": "OP-PAY-005",
          "name": "completePayPalAuth",
          "method": "POST",
          "path": "/paypal/complete",
          "description": "Complete PayPal authorization after redirect",
          "inputSchema": {
            "paypalOrderId": {
              "type": "string",
              "required": true
            }
          },
          "outputSchema": {
            "paymentToken": {
              "type": "string"
            },
            "status": {
              "type": "string"
            }
          },
          "errors": [
            {
              "code": "PAYMENT_CANCELLED",
              "httpStatus": 400,
              "message": "PayPal authorization cancelled"
            },
            {
              "code": "PAYPAL_ERROR",
              "httpStatus": 500,
              "message": "PayPal service error"
            }
          ],
          "preconditions": [
            "Customer authenticated",
            "PayPal authorization pending"
          ],
          "postconditions": [
            "PayPal authorization completed or cancelled"
          ],
          "relatedACs": [
            "AC-PAY-002"
          ],
          "relatedBRs": []
        }
      ],
      "events": [
        {
          "name": "PaymentAuthorized",
          "description": "Emitted when payment is authorized",
          "payload": [
            "orderId",
            "amount",
            "paymentMethod",
            "authorizationId"
          ]
        },
        {
          "name": "PaymentCaptured",
          "description": "Emitted when payment is captured",
          "payload": [
            "orderId",
            "amount",
            "captureId"
          ]
        },
        {
          "name": "RefundInitiated",
          "description": "Emitted when refund is initiated",
          "payload": [
            "orderId",
            "amount",
            "refundId"
          ]
        }
      ],
      "securityRequirements": {
        "authentication": "Bearer JWT",
        "authorization": "Customer can only access own payment methods"
      }
    }
  ],
  "sequences": [
    {
      "id": "SEQ-CUST-001",
      "name": "Customer Registration Flow",
      "description": "Complete flow from visitor registration to email verification",
      "trigger": {
        "type": "user_action",
        "description": "Visitor submits registration form with email, password, and name"
      },
      "participants": [
        {
          "name": "Visitor",
          "type": "actor"
        },
        {
          "name": "Customer Service",
          "type": "service"
        },
        {
          "name": "Customer Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Email Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Visitor",
          "action": "Submit registration request",
          "target": "Customer Service",
          "data": [
            "email",
            "password",
            "firstName",
            "lastName"
          ]
        },
        {
          "step": 2,
          "actor": "Customer Service",
          "action": "Validate email uniqueness",
          "target": "Customer Repository",
          "returns": "boolean (exists)"
        },
        {
          "step": 3,
          "actor": "Customer Service",
          "action": "Validate password requirements",
          "target": "Password Validator",
          "data": [
            "password must be \u003e= 8 chars with number"
          ]
        },
        {
          "step": 4,
          "actor": "Customer Service",
          "action": "Create customer with status 'unverified'",
          "target": "Customer Aggregate",
          "event": "CustomerRegistered"
        },
        {
          "step": 5,
          "actor": "Customer Service",
          "action": "Generate verification token",
          "target": "Token Service",
          "returns": "verification token"
        },
        {
          "step": 6,
          "actor": "Customer Service",
          "action": "Queue verification email (async)",
          "target": "Email Service",
          "data": [
            "email",
            "verificationToken",
            "customerName"
          ]
        },
        {
          "step": 7,
          "actor": "Customer Service",
          "action": "Return registration success",
          "target": "Visitor",
          "returns": "customerId, status='unverified'"
        }
      ],
      "outcome": {
        "success": "Customer created with 'unverified' status, verification email queued",
        "state_changes": [
          "Customer.status = unverified",
          "Customer.emailVerified = false"
        ]
      },
      "exceptions": [
        {
          "condition": "Email already registered",
          "step": 2,
          "handling": "Return DUPLICATE_EMAIL error, suggest login or password reset"
        },
        {
          "condition": "Password too short or missing number",
          "step": 3,
          "handling": "Return INVALID_PASSWORD error with requirements"
        },
        {
          "condition": "Invalid email format",
          "step": 1,
          "handling": "Return INVALID_EMAIL error"
        }
      ],
      "relatedACs": [
        "AC-CUST-001"
      ],
      "relatedBRs": [
        "BR-CUST-002",
        "BR-CUST-003"
      ]
    },
    {
      "id": "SEQ-CUST-002",
      "name": "Email Verification Flow",
      "description": "Customer verifies their email address via token link",
      "trigger": {
        "type": "user_action",
        "description": "Customer clicks verification link in email"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "Customer Service",
          "type": "service"
        },
        {
          "name": "Customer Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Token Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "Submit verification token",
          "target": "Customer Service",
          "data": [
            "token"
          ]
        },
        {
          "step": 2,
          "actor": "Customer Service",
          "action": "Validate token",
          "target": "Token Service",
          "returns": "customerId, isValid, isExpired"
        },
        {
          "step": 3,
          "actor": "Customer Service",
          "action": "Mark email as verified",
          "target": "Customer Aggregate",
          "event": "CustomerEmailVerified"
        },
        {
          "step": 4,
          "actor": "Customer Service",
          "action": "Invalidate verification token",
          "target": "Token Service"
        },
        {
          "step": 5,
          "actor": "Customer Service",
          "action": "Return verification success",
          "target": "Customer",
          "returns": "emailVerified = true"
        }
      ],
      "outcome": {
        "success": "Customer email verified, can now place orders",
        "state_changes": [
          "Customer.emailVerified = true",
          "Customer.registrationStatus = registered"
        ]
      },
      "exceptions": [
        {
          "condition": "Invalid token",
          "step": 2,
          "handling": "Return INVALID_TOKEN error"
        },
        {
          "condition": "Token expired",
          "step": 2,
          "handling": "Return VERIFICATION_EXPIRED error with resend option"
        }
      ],
      "relatedACs": [
        "AC-CUST-002"
      ],
      "relatedBRs": [
        "BR-CUST-001"
      ]
    },
    {
      "id": "SEQ-CART-001",
      "name": "Add Item to Cart Flow",
      "description": "Customer adds a product to their shopping cart",
      "trigger": {
        "type": "user_action",
        "description": "Customer clicks 'Add to Cart' button on product page"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "Cart Service",
          "type": "service"
        },
        {
          "name": "Cart Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Product Service",
          "type": "service"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "Submit add to cart request",
          "target": "Cart Service",
          "data": [
            "productId",
            "variantId (optional)",
            "quantity"
          ]
        },
        {
          "step": 2,
          "actor": "Cart Service",
          "action": "Fetch product details",
          "target": "Product Service",
          "returns": "product with name, price, hasVariants"
        },
        {
          "step": 3,
          "actor": "Cart Service",
          "action": "Check if variant required",
          "target": "Cart Service (internal)",
          "data": [
            "product.hasVariants \u0026\u0026 !variantId → error"
          ]
        },
        {
          "step": 4,
          "actor": "Cart Service",
          "action": "Check available inventory",
          "target": "Inventory Service",
          "returns": "availableQuantity"
        },
        {
          "step": 5,
          "actor": "Cart Service",
          "action": "Cap quantity to available stock if needed",
          "target": "Cart Service (internal)",
          "returns": "finalQuantity, quantityLimited flag"
        },
        {
          "step": 6,
          "actor": "Cart Service",
          "action": "Get or create cart for customer",
          "target": "Cart Repository",
          "returns": "Cart"
        },
        {
          "step": 7,
          "actor": "Cart Service",
          "action": "Add item or merge quantity if exists",
          "target": "Cart Aggregate",
          "event": "ItemAddedToCart"
        },
        {
          "step": 8,
          "actor": "Cart Service",
          "action": "Return updated cart summary",
          "target": "Customer",
          "returns": "cartItem, subtotal, quantityLimited notification"
        }
      ],
      "outcome": {
        "success": "Item added to cart, totals recalculated",
        "state_changes": [
          "Cart.items += item",
          "Cart.totalPrice recalculated",
          "Cart.lastActivityDate = now"
        ]
      },
      "exceptions": [
        {
          "condition": "Product not found",
          "step": 2,
          "handling": "Return PRODUCT_NOT_FOUND error"
        },
        {
          "condition": "Product out of stock",
          "step": 4,
          "handling": "Return OUT_OF_STOCK error"
        },
        {
          "condition": "Product has variants but none selected",
          "step": 3,
          "handling": "Return VARIANT_REQUIRED error"
        },
        {
          "condition": "Requested quantity exceeds stock",
          "step": 5,
          "handling": "Cap to available, return QUANTITY_LIMITED warning"
        }
      ],
      "relatedACs": [
        "AC-CART-001",
        "AC-CART-002",
        "AC-PROD-003"
      ],
      "relatedBRs": [
        "BR-CART-001",
        "BR-CART-002",
        "BR-CART-003",
        "BR-CART-005"
      ]
    },
    {
      "id": "SEQ-CART-002",
      "name": "Update Cart Item Quantity Flow",
      "description": "Customer changes quantity of item in cart",
      "trigger": {
        "type": "user_action",
        "description": "Customer modifies quantity input in cart"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "Cart Service",
          "type": "service"
        },
        {
          "name": "Cart Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "Submit quantity update",
          "target": "Cart Service",
          "data": [
            "itemId",
            "newQuantity"
          ]
        },
        {
          "step": 2,
          "actor": "Cart Service",
          "action": "Fetch cart with item",
          "target": "Cart Repository",
          "returns": "Cart with items"
        },
        {
          "step": 3,
          "actor": "Cart Service",
          "action": "Validate item exists in cart",
          "target": "Cart Service (internal)"
        },
        {
          "step": 4,
          "actor": "Cart Service",
          "action": "Check if quantity is 0",
          "target": "Cart Service (internal)",
          "data": [
            "if quantity == 0 → trigger remove flow"
          ]
        },
        {
          "step": 5,
          "actor": "Cart Service",
          "action": "Check available inventory",
          "target": "Inventory Service",
          "returns": "availableQuantity"
        },
        {
          "step": 6,
          "actor": "Cart Service",
          "action": "Cap quantity if exceeds stock",
          "target": "Cart Service (internal)",
          "returns": "finalQuantity, quantityLimited flag"
        },
        {
          "step": 7,
          "actor": "Cart Service",
          "action": "Update item quantity",
          "target": "Cart Aggregate",
          "event": "CartItemQuantityUpdated"
        },
        {
          "step": 8,
          "actor": "Cart Service",
          "action": "Return updated cart",
          "target": "Customer",
          "returns": "updated item, cart totals, warnings"
        }
      ],
      "outcome": {
        "success": "Cart item quantity updated, totals recalculated",
        "state_changes": [
          "CartItem.quantity = newQuantity",
          "Cart.totalPrice recalculated"
        ]
      },
      "exceptions": [
        {
          "condition": "Item not in cart",
          "step": 3,
          "handling": "Return ITEM_NOT_FOUND error"
        },
        {
          "condition": "Quantity exceeds stock",
          "step": 6,
          "handling": "Cap to available, return notification"
        }
      ],
      "relatedACs": [
        "AC-CART-004"
      ],
      "relatedBRs": [
        "BR-CART-002",
        "BR-CART-003"
      ]
    },
    {
      "id": "SEQ-CART-003",
      "name": "Remove Item from Cart Flow",
      "description": "Customer removes an item from their cart",
      "trigger": {
        "type": "user_action",
        "description": "Customer clicks 'Remove' on cart item"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "Cart Service",
          "type": "service"
        },
        {
          "name": "Cart Aggregate",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "Submit remove item request",
          "target": "Cart Service",
          "data": [
            "itemId"
          ]
        },
        {
          "step": 2,
          "actor": "Cart Service",
          "action": "Fetch cart",
          "target": "Cart Repository",
          "returns": "Cart with items"
        },
        {
          "step": 3,
          "actor": "Cart Service",
          "action": "Remove item from cart",
          "target": "Cart Aggregate",
          "event": "ItemRemovedFromCart"
        },
        {
          "step": 4,
          "actor": "Cart Service",
          "action": "Generate undo token (5 second TTL)",
          "target": "Cart Service (internal)",
          "returns": "undoToken"
        },
        {
          "step": 5,
          "actor": "Cart Service",
          "action": "Return updated cart with undo option",
          "target": "Customer",
          "returns": "cart totals, isEmpty flag, undoToken"
        }
      ],
      "outcome": {
        "success": "Item removed from cart, undo available for 5 seconds",
        "state_changes": [
          "Cart.items -= item",
          "Cart.totalPrice recalculated"
        ]
      },
      "exceptions": [
        {
          "condition": "Item not in cart",
          "step": 3,
          "handling": "Return ITEM_NOT_FOUND error"
        }
      ],
      "relatedACs": [
        "AC-CART-005",
        "AC-CART-006"
      ],
      "relatedBRs": []
    },
    {
      "id": "SEQ-CART-004",
      "name": "Merge Guest Cart on Login Flow",
      "description": "Guest cart items merged with customer cart after login",
      "trigger": {
        "type": "system_event",
        "description": "Guest user successfully logs in with existing cart"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "Auth Service",
          "type": "service"
        },
        {
          "name": "Cart Service",
          "type": "service"
        },
        {
          "name": "Cart Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Auth Service",
          "action": "Notify cart service of login with guest cart",
          "target": "Cart Service",
          "data": [
            "customerId",
            "guestCartId"
          ]
        },
        {
          "step": 2,
          "actor": "Cart Service",
          "action": "Fetch guest cart",
          "target": "Cart Repository",
          "returns": "Guest cart with items"
        },
        {
          "step": 3,
          "actor": "Cart Service",
          "action": "Fetch customer cart (or create)",
          "target": "Cart Repository",
          "returns": "Customer cart"
        },
        {
          "step": 4,
          "actor": "Cart Service",
          "action": "For each guest item, check stock",
          "target": "Inventory Service",
          "returns": "available quantities"
        },
        {
          "step": 5,
          "actor": "Cart Service",
          "action": "Merge items, cap quantities to stock",
          "target": "Cart Aggregate",
          "event": "CartMerged"
        },
        {
          "step": 6,
          "actor": "Cart Service",
          "action": "Delete guest cart",
          "target": "Cart Repository"
        },
        {
          "step": 7,
          "actor": "Cart Service",
          "action": "Return merged cart with notifications",
          "target": "Customer",
          "returns": "merged cart, merge notifications"
        }
      ],
      "outcome": {
        "success": "Guest cart merged into customer cart, quantities limited to stock",
        "state_changes": [
          "Customer Cart.items += guest items (merged)",
          "Guest Cart deleted"
        ]
      },
      "exceptions": [
        {
          "condition": "Merged quantity exceeds stock",
          "step": 5,
          "handling": "Cap to available stock, add notification"
        },
        {
          "condition": "Guest cart not found",
          "step": 2,
          "handling": "No merge needed, continue with customer cart"
        }
      ],
      "relatedACs": [
        "AC-CART-003"
      ],
      "relatedBRs": [
        "BR-CART-002"
      ]
    },
    {
      "id": "SEQ-ORDER-001",
      "name": "Place Order Flow",
      "description": "Complete flow from checkout to order confirmation with payment",
      "trigger": {
        "type": "user_action",
        "description": "Customer clicks 'Place Order' button at checkout"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "Order Service",
          "type": "service"
        },
        {
          "name": "Customer Service",
          "type": "service"
        },
        {
          "name": "Cart Service",
          "type": "service"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        },
        {
          "name": "Payment Service",
          "type": "service"
        },
        {
          "name": "Order Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Email Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "Submit order request",
          "target": "Order Service",
          "data": [
            "shippingAddressId",
            "paymentMethod"
          ]
        },
        {
          "step": 2,
          "actor": "Order Service",
          "action": "Validate customer is registered and verified",
          "target": "Customer Service",
          "returns": "customer status, emailVerified"
        },
        {
          "step": 3,
          "actor": "Order Service",
          "action": "Fetch cart contents",
          "target": "Cart Service",
          "returns": "Cart with items"
        },
        {
          "step": 4,
          "actor": "Order Service",
          "action": "Validate cart is not empty",
          "target": "Order Service (internal)"
        },
        {
          "step": 5,
          "actor": "Order Service",
          "action": "Validate shipping address",
          "target": "Customer Service",
          "returns": "Address object"
        },
        {
          "step": 6,
          "actor": "Order Service",
          "action": "Verify stock for all items",
          "target": "Inventory Service",
          "returns": "stock availability per item"
        },
        {
          "step": 7,
          "actor": "Order Service",
          "action": "Calculate order totals (subtotal, shipping, tax)",
          "target": "Order Service (internal)",
          "data": [
            "free shipping if subtotal \u003e $50"
          ]
        },
        {
          "step": 8,
          "actor": "Order Service",
          "action": "Authorize payment",
          "target": "Payment Service",
          "returns": "authorizationId, success/failure"
        },
        {
          "step": 9,
          "actor": "Order Service",
          "action": "Reserve inventory for all items",
          "target": "Inventory Service",
          "event": "InventoryReserved (per item)"
        },
        {
          "step": 10,
          "actor": "Order Service",
          "action": "Generate order number",
          "target": "Order Repository",
          "returns": "ORD-{YEAR}-{SEQUENCE}"
        },
        {
          "step": 11,
          "actor": "Order Service",
          "action": "Create order with line items (price snapshot)",
          "target": "Order Aggregate",
          "event": "OrderPlaced"
        },
        {
          "step": 12,
          "actor": "Order Service",
          "action": "Clear customer cart",
          "target": "Cart Service",
          "event": "CartCleared"
        },
        {
          "step": 13,
          "actor": "Order Service",
          "action": "Queue confirmation email (async)",
          "target": "Email Service",
          "data": [
            "orderId",
            "orderNumber",
            "items",
            "totals",
            "address"
          ]
        },
        {
          "step": 14,
          "actor": "Order Service",
          "action": "Return order confirmation",
          "target": "Customer",
          "returns": "orderId, orderNumber, status, totals"
        }
      ],
      "outcome": {
        "success": "Order created with 'pending' status, payment authorized, inventory reserved, cart cleared, email queued",
        "state_changes": [
          "Order.status = pending",
          "Order.lineItems = snapshots from cart",
          "Inventory.reservedQuantity += order quantities",
          "Cart.items = empty",
          "Payment.authorization = captured"
        ]
      },
      "exceptions": [
        {
          "condition": "Customer not verified",
          "step": 2,
          "handling": "Return EMAIL_NOT_VERIFIED error"
        },
        {
          "condition": "Cart is empty",
          "step": 4,
          "handling": "Return CART_EMPTY error"
        },
        {
          "condition": "Invalid shipping address",
          "step": 5,
          "handling": "Return INVALID_ADDRESS error"
        },
        {
          "condition": "Insufficient stock for item",
          "step": 6,
          "handling": "Return STOCK_UNAVAILABLE error with affected items"
        },
        {
          "condition": "Payment authorization fails",
          "step": 8,
          "handling": "Return PAYMENT_FAILED error, cart preserved"
        },
        {
          "condition": "Unsupported card type",
          "step": 8,
          "handling": "Return UNSUPPORTED_CARD_TYPE error"
        }
      ],
      "relatedACs": [
        "AC-ORDER-001",
        "AC-ORDER-002",
        "AC-ORDER-003",
        "AC-ORDER-004",
        "AC-ORDER-005",
        "AC-ORDER-011",
        "AC-PAY-001",
        "AC-PAY-002"
      ],
      "relatedBRs": [
        "BR-CUST-001",
        "BR-ORDER-001",
        "BR-ORDER-005",
        "BR-ORDER-006",
        "BR-INV-002",
        "BR-PAY-001",
        "BR-PAY-002",
        "BR-EMAIL-001",
        "BR-EMAIL-002"
      ]
    },
    {
      "id": "SEQ-ORDER-002",
      "name": "Cancel Order Flow",
      "description": "Customer or admin cancels a pending/confirmed order with refund",
      "trigger": {
        "type": "user_action",
        "description": "Customer or admin requests order cancellation"
      },
      "participants": [
        {
          "name": "Customer/Admin",
          "type": "actor"
        },
        {
          "name": "Order Service",
          "type": "service"
        },
        {
          "name": "Order Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        },
        {
          "name": "Payment Service",
          "type": "service"
        },
        {
          "name": "Email Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer/Admin",
          "action": "Submit cancellation request",
          "target": "Order Service",
          "data": [
            "orderId",
            "reason"
          ]
        },
        {
          "step": 2,
          "actor": "Order Service",
          "action": "Fetch order",
          "target": "Order Repository",
          "returns": "Order with line items"
        },
        {
          "step": 3,
          "actor": "Order Service",
          "action": "Validate cancellation allowed",
          "target": "Order Aggregate",
          "data": [
            "status must be pending or confirmed"
          ]
        },
        {
          "step": 4,
          "actor": "Order Service",
          "action": "Update order status to cancelled",
          "target": "Order Aggregate",
          "event": "OrderCancelled"
        },
        {
          "step": 5,
          "actor": "Order Service",
          "action": "Release reserved inventory",
          "target": "Inventory Service",
          "event": "InventoryReleased (per item)"
        },
        {
          "step": 6,
          "actor": "Order Service",
          "action": "Initiate refund to original payment",
          "target": "Payment Service",
          "event": "RefundInitiated"
        },
        {
          "step": 7,
          "actor": "Order Service",
          "action": "Queue cancellation email",
          "target": "Email Service",
          "data": [
            "orderId",
            "orderNumber",
            "reason",
            "refundAmount"
          ]
        },
        {
          "step": 8,
          "actor": "Order Service",
          "action": "Return cancellation confirmation",
          "target": "Customer/Admin",
          "returns": "orderId, status=cancelled, refundStatus"
        }
      ],
      "outcome": {
        "success": "Order cancelled, inventory released, refund initiated, email sent",
        "state_changes": [
          "Order.status = cancelled",
          "Order.cancellationReason = reason",
          "Inventory.reservedQuantity -= order quantities",
          "Payment.refund = initiated"
        ]
      },
      "exceptions": [
        {
          "condition": "Order not found",
          "step": 2,
          "handling": "Return ORDER_NOT_FOUND error"
        },
        {
          "condition": "Order already shipped",
          "step": 3,
          "handling": "Return ORDER_ALREADY_SHIPPED error"
        },
        {
          "condition": "Refund fails",
          "step": 6,
          "handling": "Log error, mark for manual processing, return REFUND_FAILED warning"
        }
      ],
      "relatedACs": [
        "AC-ORDER-008",
        "AC-ORDER-009",
        "AC-ORDER-010"
      ],
      "relatedBRs": [
        "BR-ORDER-002",
        "BR-ORDER-003",
        "BR-INV-003",
        "BR-PAY-003"
      ]
    },
    {
      "id": "SEQ-ORDER-003",
      "name": "Update Order Status to Shipped Flow",
      "description": "Admin updates order status to shipped with tracking number",
      "trigger": {
        "type": "admin_action",
        "description": "Admin marks order as shipped with tracking info"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "Order Service",
          "type": "service"
        },
        {
          "name": "Order Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        },
        {
          "name": "Email Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "Submit ship order request",
          "target": "Order Service",
          "data": [
            "orderId",
            "trackingNumber"
          ]
        },
        {
          "step": 2,
          "actor": "Order Service",
          "action": "Fetch order",
          "target": "Order Repository",
          "returns": "Order"
        },
        {
          "step": 3,
          "actor": "Order Service",
          "action": "Validate status transition (confirmed → shipped)",
          "target": "Order Aggregate"
        },
        {
          "step": 4,
          "actor": "Order Service",
          "action": "Deduct reserved inventory",
          "target": "Inventory Service",
          "event": "InventoryDeducted (per item)"
        },
        {
          "step": 5,
          "actor": "Order Service",
          "action": "Update status and tracking number",
          "target": "Order Aggregate",
          "event": "OrderShipped"
        },
        {
          "step": 6,
          "actor": "Order Service",
          "action": "Log status change with admin user",
          "target": "Order Service (internal)"
        },
        {
          "step": 7,
          "actor": "Order Service",
          "action": "Queue shipment notification email",
          "target": "Email Service",
          "data": [
            "orderId",
            "trackingNumber",
            "carrierUrl"
          ]
        },
        {
          "step": 8,
          "actor": "Order Service",
          "action": "Return updated order",
          "target": "Admin",
          "returns": "orderId, status=shipped, trackingNumber"
        }
      ],
      "outcome": {
        "success": "Order marked as shipped, inventory deducted, customer notified",
        "state_changes": [
          "Order.status = shipped",
          "Order.trackingNumber = trackingNumber",
          "Inventory.stockLevel -= quantities",
          "Inventory.reservedQuantity -= quantities"
        ]
      },
      "exceptions": [
        {
          "condition": "Order not found",
          "step": 2,
          "handling": "Return ORDER_NOT_FOUND error"
        },
        {
          "condition": "Invalid status transition",
          "step": 3,
          "handling": "Return INVALID_STATUS_TRANSITION error"
        }
      ],
      "relatedACs": [
        "AC-ADMIN-008"
      ],
      "relatedBRs": [
        "BR-ORDER-003"
      ]
    },
    {
      "id": "SEQ-ORDER-004",
      "name": "Order Status Confirmation Flow",
      "description": "Admin confirms a pending order",
      "trigger": {
        "type": "admin_action",
        "description": "Admin confirms order after payment verification"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "Order Service",
          "type": "service"
        },
        {
          "name": "Order Aggregate",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "Submit confirm order request",
          "target": "Order Service",
          "data": [
            "orderId"
          ]
        },
        {
          "step": 2,
          "actor": "Order Service",
          "action": "Fetch order",
          "target": "Order Repository",
          "returns": "Order"
        },
        {
          "step": 3,
          "actor": "Order Service",
          "action": "Validate status transition (pending → confirmed)",
          "target": "Order Aggregate"
        },
        {
          "step": 4,
          "actor": "Order Service",
          "action": "Update status to confirmed",
          "target": "Order Aggregate",
          "event": "OrderConfirmed"
        },
        {
          "step": 5,
          "actor": "Order Service",
          "action": "Return updated order",
          "target": "Admin",
          "returns": "orderId, status=confirmed"
        }
      ],
      "outcome": {
        "success": "Order confirmed, ready for fulfillment",
        "state_changes": [
          "Order.status = confirmed"
        ]
      },
      "exceptions": [
        {
          "condition": "Order not found",
          "step": 2,
          "handling": "Return ORDER_NOT_FOUND error"
        },
        {
          "condition": "Invalid status transition",
          "step": 3,
          "handling": "Return INVALID_STATUS_TRANSITION error"
        }
      ],
      "relatedACs": [],
      "relatedBRs": [
        "BR-ORDER-003"
      ]
    },
    {
      "id": "SEQ-INV-001",
      "name": "Set Inventory Quantity Flow",
      "description": "Admin sets absolute inventory quantity with audit",
      "trigger": {
        "type": "admin_action",
        "description": "Admin updates inventory level via admin panel"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        },
        {
          "name": "Inventory Aggregate",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "Submit set inventory request",
          "target": "Inventory Service",
          "data": [
            "productId",
            "quantity",
            "reason"
          ]
        },
        {
          "step": 2,
          "actor": "Inventory Service",
          "action": "Fetch current inventory",
          "target": "Inventory Repository",
          "returns": "Inventory with current stock"
        },
        {
          "step": 3,
          "actor": "Inventory Service",
          "action": "Validate quantity \u003e= 0",
          "target": "Inventory Service (internal)"
        },
        {
          "step": 4,
          "actor": "Inventory Service",
          "action": "Record previous value",
          "target": "Inventory Service (internal)",
          "returns": "previousValue"
        },
        {
          "step": 5,
          "actor": "Inventory Service",
          "action": "Update stock level",
          "target": "Inventory Aggregate",
          "event": "InventoryQuantitySet"
        },
        {
          "step": 6,
          "actor": "Inventory Service",
          "action": "Create audit log entry",
          "target": "Inventory Aggregate",
          "data": [
            "previousValue",
            "newValue",
            "reason",
            "adminId",
            "timestamp"
          ]
        },
        {
          "step": 7,
          "actor": "Inventory Service",
          "action": "Check low stock threshold",
          "target": "Inventory Aggregate",
          "event": "LowStockAlert (if below threshold)"
        },
        {
          "step": 8,
          "actor": "Inventory Service",
          "action": "Return update confirmation",
          "target": "Admin",
          "returns": "productId, previousValue, newValue, auditLogId"
        }
      ],
      "outcome": {
        "success": "Inventory updated with full audit trail",
        "state_changes": [
          "Inventory.stockLevel = newQuantity",
          "InventoryAuditLog += entry"
        ]
      },
      "exceptions": [
        {
          "condition": "Product not found",
          "step": 2,
          "handling": "Return PRODUCT_NOT_FOUND error"
        },
        {
          "condition": "Negative quantity",
          "step": 3,
          "handling": "Return INVALID_QUANTITY error"
        }
      ],
      "relatedACs": [
        "AC-ADMIN-009",
        "AC-ADMIN-012"
      ],
      "relatedBRs": [
        "BR-INV-001",
        "BR-INV-004"
      ]
    },
    {
      "id": "SEQ-INV-002",
      "name": "Adjust Inventory Delta Flow",
      "description": "Admin adjusts inventory by positive or negative delta",
      "trigger": {
        "type": "admin_action",
        "description": "Admin adjusts inventory level via admin panel"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        },
        {
          "name": "Inventory Aggregate",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "Submit adjust inventory request",
          "target": "Inventory Service",
          "data": [
            "productId",
            "adjustment",
            "reason"
          ]
        },
        {
          "step": 2,
          "actor": "Inventory Service",
          "action": "Fetch current inventory",
          "target": "Inventory Repository",
          "returns": "Inventory"
        },
        {
          "step": 3,
          "actor": "Inventory Service",
          "action": "Calculate new value",
          "target": "Inventory Service (internal)",
          "returns": "newValue = stockLevel + adjustment"
        },
        {
          "step": 4,
          "actor": "Inventory Service",
          "action": "Validate result \u003e= 0",
          "target": "Inventory Service (internal)"
        },
        {
          "step": 5,
          "actor": "Inventory Service",
          "action": "Apply adjustment",
          "target": "Inventory Aggregate",
          "event": "InventoryAdjusted"
        },
        {
          "step": 6,
          "actor": "Inventory Service",
          "action": "Create audit log entry",
          "target": "Inventory Aggregate",
          "data": [
            "previousValue",
            "adjustment",
            "newValue",
            "reason",
            "adminId"
          ]
        },
        {
          "step": 7,
          "actor": "Inventory Service",
          "action": "Check low stock / out of stock",
          "target": "Inventory Aggregate",
          "event": "LowStockAlert or OutOfStock (if applicable)"
        },
        {
          "step": 8,
          "actor": "Inventory Service",
          "action": "Return adjustment confirmation",
          "target": "Admin",
          "returns": "productId, adjustment, newValue, auditLogId"
        }
      ],
      "outcome": {
        "success": "Inventory adjusted with audit trail",
        "state_changes": [
          "Inventory.stockLevel += adjustment",
          "InventoryAuditLog += entry"
        ]
      },
      "exceptions": [
        {
          "condition": "Product not found",
          "step": 2,
          "handling": "Return PRODUCT_NOT_FOUND error"
        },
        {
          "condition": "Adjustment would result in negative stock",
          "step": 4,
          "handling": "Return INSUFFICIENT_STOCK error"
        }
      ],
      "relatedACs": [
        "AC-ADMIN-010"
      ],
      "relatedBRs": [
        "BR-INV-001",
        "BR-INV-004"
      ]
    },
    {
      "id": "SEQ-PROD-001",
      "name": "Create Product Flow",
      "description": "Admin creates a new product in the catalog",
      "trigger": {
        "type": "admin_action",
        "description": "Admin submits new product form"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "Product Service",
          "type": "service"
        },
        {
          "name": "Product Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Category Service",
          "type": "service"
        },
        {
          "name": "Inventory Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "Submit create product request",
          "target": "Product Service",
          "data": [
            "name",
            "description",
            "price",
            "categoryId"
          ]
        },
        {
          "step": 2,
          "actor": "Product Service",
          "action": "Validate product name length (2-200 chars)",
          "target": "Product Service (internal)"
        },
        {
          "step": 3,
          "actor": "Product Service",
          "action": "Validate price \u003e= $0.01",
          "target": "Product Service (internal)"
        },
        {
          "step": 4,
          "actor": "Product Service",
          "action": "Verify category exists",
          "target": "Category Service",
          "returns": "Category"
        },
        {
          "step": 5,
          "actor": "Product Service",
          "action": "Create product with status 'draft'",
          "target": "Product Aggregate",
          "event": "ProductCreated"
        },
        {
          "step": 6,
          "actor": "Product Service",
          "action": "Initialize inventory with stock = 0",
          "target": "Inventory Service",
          "returns": "Inventory record created"
        },
        {
          "step": 7,
          "actor": "Product Service",
          "action": "Return created product",
          "target": "Admin",
          "returns": "productId, name, status='draft'"
        }
      ],
      "outcome": {
        "success": "Product created in draft status with initial inventory",
        "state_changes": [
          "Product created with status=draft",
          "Inventory created with stockLevel=0"
        ]
      },
      "exceptions": [
        {
          "condition": "Name empty or too long",
          "step": 2,
          "handling": "Return NAME_REQUIRED or NAME_TOO_LONG error"
        },
        {
          "condition": "Price \u003c= 0",
          "step": 3,
          "handling": "Return INVALID_PRICE error"
        },
        {
          "condition": "Category not found",
          "step": 4,
          "handling": "Return CATEGORY_NOT_FOUND error"
        }
      ],
      "relatedACs": [
        "AC-ADMIN-001"
      ],
      "relatedBRs": [
        "BR-PROD-001",
        "BR-PROD-002"
      ]
    },
    {
      "id": "SEQ-PROD-002",
      "name": "Delete Product Flow",
      "description": "Admin removes a product from the catalog (soft delete)",
      "trigger": {
        "type": "admin_action",
        "description": "Admin clicks delete on product"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "Product Service",
          "type": "service"
        },
        {
          "name": "Product Aggregate",
          "type": "aggregate"
        },
        {
          "name": "Cart Service",
          "type": "service"
        },
        {
          "name": "Order Service",
          "type": "service"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "Submit delete product request",
          "target": "Product Service",
          "data": [
            "productId"
          ]
        },
        {
          "step": 2,
          "actor": "Product Service",
          "action": "Fetch product",
          "target": "Product Repository",
          "returns": "Product"
        },
        {
          "step": 3,
          "actor": "Product Service",
          "action": "Check for order history",
          "target": "Order Service",
          "returns": "hasOrderHistory"
        },
        {
          "step": 4,
          "actor": "Product Service",
          "action": "Apply soft delete (set isDeleted=true)",
          "target": "Product Aggregate",
          "event": "ProductDeleted"
        },
        {
          "step": 5,
          "actor": "Product Service",
          "action": "Remove product from all carts",
          "target": "Cart Service",
          "event": "ItemRemovedFromCart (async, per affected cart)"
        },
        {
          "step": 6,
          "actor": "Product Service",
          "action": "Return deletion confirmation",
          "target": "Admin",
          "returns": "productId, status='deleted'"
        }
      ],
      "outcome": {
        "success": "Product soft-deleted, removed from active carts, order history preserved",
        "state_changes": [
          "Product.isDeleted = true",
          "Product.isActive = false",
          "Affected carts updated"
        ]
      },
      "exceptions": [
        {
          "condition": "Product not found",
          "step": 2,
          "handling": "Return PRODUCT_NOT_FOUND error"
        }
      ],
      "relatedACs": [
        "AC-ADMIN-005"
      ],
      "relatedBRs": [
        "BR-PROD-003"
      ]
    },
    {
      "id": "SEQ-PAY-001",
      "name": "PayPal Payment Authorization Flow",
      "description": "Customer authorizes payment via PayPal redirect flow",
      "trigger": {
        "type": "user_action",
        "description": "Customer selects PayPal at checkout"
      },
      "participants": [
        {
          "name": "Customer",
          "type": "actor"
        },
        {
          "name": "Payment Service",
          "type": "service"
        },
        {
          "name": "PayPal Gateway",
          "type": "external"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Customer",
          "action": "Initiate PayPal payment",
          "target": "Payment Service",
          "data": [
            "amount",
            "returnUrl",
            "cancelUrl"
          ]
        },
        {
          "step": 2,
          "actor": "Payment Service",
          "action": "Create PayPal order",
          "target": "PayPal Gateway",
          "returns": "paypalOrderId, approvalUrl"
        },
        {
          "step": 3,
          "actor": "Payment Service",
          "action": "Return redirect URL",
          "target": "Customer",
          "returns": "authorizationUrl"
        },
        {
          "step": 4,
          "actor": "Customer",
          "action": "Complete PayPal authorization",
          "target": "PayPal Gateway",
          "data": [
            "login, approve payment"
          ]
        },
        {
          "step": 5,
          "actor": "PayPal Gateway",
          "action": "Redirect back with approval",
          "target": "Payment Service",
          "data": [
            "paypalOrderId",
            "payerId"
          ]
        },
        {
          "step": 6,
          "actor": "Payment Service",
          "action": "Capture PayPal payment",
          "target": "PayPal Gateway",
          "returns": "captureId, status"
        },
        {
          "step": 7,
          "actor": "Payment Service",
          "action": "Return payment token",
          "target": "Customer",
          "returns": "paymentToken for order creation"
        }
      ],
      "outcome": {
        "success": "PayPal payment authorized and captured, ready for order",
        "state_changes": [
          "PayPal authorization captured"
        ]
      },
      "exceptions": [
        {
          "condition": "User cancels at PayPal",
          "step": 4,
          "handling": "Return PAYMENT_CANCELLED, redirect to checkout"
        },
        {
          "condition": "PayPal service error",
          "step": 2,
          "handling": "Return PAYPAL_ERROR"
        }
      ],
      "relatedACs": [
        "AC-PAY-002"
      ],
      "relatedBRs": []
    },
    {
      "id": "SEQ-CAT-001",
      "name": "Create Category Flow",
      "description": "Admin creates a new product category",
      "trigger": {
        "type": "admin_action",
        "description": "Admin creates category via admin panel"
      },
      "participants": [
        {
          "name": "Admin",
          "type": "actor"
        },
        {
          "name": "Category Service",
          "type": "service"
        },
        {
          "name": "Category Aggregate",
          "type": "aggregate"
        }
      ],
      "steps": [
        {
          "step": 1,
          "actor": "Admin",
          "action": "Submit create category request",
          "target": "Category Service",
          "data": [
            "name",
            "description",
            "parentCategoryId"
          ]
        },
        {
          "step": 2,
          "actor": "Category Service",
          "action": "Validate name uniqueness",
          "target": "Category Repository",
          "returns": "boolean (exists)"
        },
        {
          "step": 3,
          "actor": "Category Service",
          "action": "If parent specified, validate parent exists",
          "target": "Category Repository",
          "returns": "parent Category"
        },
        {
          "step": 4,
          "actor": "Category Service",
          "action": "Calculate depth (parent.depth + 1)",
          "target": "Category Service (internal)"
        },
        {
          "step": 5,
          "actor": "Category Service",
          "action": "Validate depth \u003c= 3",
          "target": "Category Service (internal)"
        },
        {
          "step": 6,
          "actor": "Category Service",
          "action": "Create category",
          "target": "Category Aggregate",
          "event": "CategoryCreated"
        },
        {
          "step": 7,
          "actor": "Category Service",
          "action": "Return created category",
          "target": "Admin",
          "returns": "categoryId, name, depth"
        }
      ],
      "outcome": {
        "success": "Category created in hierarchy",
        "state_changes": [
          "Category created with calculated depth"
        ]
      },
      "exceptions": [
        {
          "condition": "Name already exists",
          "step": 2,
          "handling": "Return DUPLICATE_CATEGORY_NAME error"
        },
        {
          "condition": "Parent not found",
          "step": 3,
          "handling": "Return PARENT_NOT_FOUND error"
        },
        {
          "condition": "Depth exceeds 3 levels",
          "step": 5,
          "handling": "Return MAX_NESTING_EXCEEDED error"
        }
      ],
      "relatedACs": [
        "AC-ADMIN-013"
      ],
      "relatedBRs": [
        "BR-CAT-001"
      ]
    }
  ],
  "shared_types": [
    {
      "name": "Money",
      "fields": [
        {
          "name": "amount",
          "type": "decimal",
          "constraints": "\u003e= 0, precision 2"
        },
        {
          "name": "currency",
          "type": "string",
          "constraints": "ISO 4217, default USD"
        }
      ]
    },
    {
      "name": "Address",
      "fields": [
        {
          "name": "addressId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "street",
          "type": "string",
          "constraints": "1-200 chars"
        },
        {
          "name": "city",
          "type": "string",
          "constraints": "1-100 chars"
        },
        {
          "name": "state",
          "type": "string",
          "constraints": "required"
        },
        {
          "name": "postalCode",
          "type": "string",
          "constraints": "valid format"
        },
        {
          "name": "country",
          "type": "string",
          "constraints": "ISO 3166-1"
        },
        {
          "name": "recipientName",
          "type": "string",
          "constraints": "1-200 chars"
        }
      ]
    },
    {
      "name": "Email",
      "fields": [
        {
          "name": "value",
          "type": "string",
          "constraints": "RFC 5322 email format"
        }
      ]
    },
    {
      "name": "Quantity",
      "fields": [
        {
          "name": "value",
          "type": "integer",
          "constraints": "\u003e 0"
        }
      ]
    },
    {
      "name": "SKU",
      "fields": [
        {
          "name": "value",
          "type": "string",
          "constraints": "alphanumeric, unique"
        }
      ]
    },
    {
      "name": "OrderStatus",
      "fields": [
        {
          "name": "value",
          "type": "enum",
          "constraints": "pending | confirmed | shipped | delivered | cancelled"
        }
      ]
    },
    {
      "name": "PaymentMethod",
      "fields": [
        {
          "name": "type",
          "type": "enum",
          "constraints": "credit_card | paypal"
        },
        {
          "name": "token",
          "type": "string",
          "constraints": "payment gateway token"
        },
        {
          "name": "lastFourDigits",
          "type": "string",
          "constraints": "for credit card display"
        },
        {
          "name": "cardBrand",
          "type": "enum",
          "constraints": "visa | mastercard | amex"
        },
        {
          "name": "paypalEmail",
          "type": "string",
          "constraints": "for PayPal identification"
        }
      ]
    },
    {
      "name": "Pagination",
      "fields": [
        {
          "name": "page",
          "type": "integer",
          "constraints": "\u003e= 1"
        },
        {
          "name": "pageSize",
          "type": "integer",
          "constraints": "1-100"
        },
        {
          "name": "totalItems",
          "type": "integer",
          "constraints": "\u003e= 0"
        },
        {
          "name": "totalPages",
          "type": "integer",
          "constraints": "\u003e= 0"
        }
      ]
    },
    {
      "name": "CartItem",
      "fields": [
        {
          "name": "itemId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "productId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "variantId",
          "type": "UUID",
          "constraints": "nullable"
        },
        {
          "name": "productName",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "variantDescription",
          "type": "string",
          "constraints": "nullable"
        },
        {
          "name": "unitPrice",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "quantity",
          "type": "integer",
          "constraints": "\u003e 0"
        },
        {
          "name": "subtotal",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "isInStock",
          "type": "boolean",
          "constraints": ""
        },
        {
          "name": "availableQuantity",
          "type": "integer",
          "constraints": ""
        }
      ]
    },
    {
      "name": "OrderLineItem",
      "fields": [
        {
          "name": "lineItemId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "productId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "variantId",
          "type": "UUID",
          "constraints": "nullable"
        },
        {
          "name": "productName",
          "type": "string",
          "constraints": "snapshot"
        },
        {
          "name": "variantDescription",
          "type": "string",
          "constraints": "nullable, snapshot"
        },
        {
          "name": "unitPrice",
          "type": "Money",
          "constraints": "snapshot at order time"
        },
        {
          "name": "quantity",
          "type": "integer",
          "constraints": "\u003e 0"
        },
        {
          "name": "subtotal",
          "type": "Money",
          "constraints": ""
        }
      ]
    },
    {
      "name": "ProductSummary",
      "fields": [
        {
          "name": "productId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "name",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "price",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "primaryImageUrl",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "categoryName",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "isInStock",
          "type": "boolean",
          "constraints": ""
        },
        {
          "name": "hasVariants",
          "type": "boolean",
          "constraints": ""
        }
      ]
    },
    {
      "name": "ProductVariant",
      "fields": [
        {
          "name": "variantId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "sku",
          "type": "SKU",
          "constraints": ""
        },
        {
          "name": "size",
          "type": "string",
          "constraints": "nullable"
        },
        {
          "name": "color",
          "type": "string",
          "constraints": "nullable"
        },
        {
          "name": "priceAdjustment",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "finalPrice",
          "type": "Money",
          "constraints": "base + adjustment"
        },
        {
          "name": "availableQuantity",
          "type": "integer",
          "constraints": ""
        },
        {
          "name": "isInStock",
          "type": "boolean",
          "constraints": ""
        }
      ]
    },
    {
      "name": "ProductImage",
      "fields": [
        {
          "name": "imageId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "url",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "isPrimary",
          "type": "boolean",
          "constraints": ""
        },
        {
          "name": "displayOrder",
          "type": "integer",
          "constraints": ""
        }
      ]
    },
    {
      "name": "OrderSummary",
      "fields": [
        {
          "name": "orderId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "orderNumber",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "status",
          "type": "OrderStatus",
          "constraints": ""
        },
        {
          "name": "totalAmount",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "itemCount",
          "type": "integer",
          "constraints": ""
        },
        {
          "name": "createdAt",
          "type": "DateTime",
          "constraints": ""
        }
      ]
    },
    {
      "name": "AdminOrderSummary",
      "fields": [
        {
          "name": "orderId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "orderNumber",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "status",
          "type": "OrderStatus",
          "constraints": ""
        },
        {
          "name": "customerName",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "customerEmail",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "totalAmount",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "itemCount",
          "type": "integer",
          "constraints": ""
        },
        {
          "name": "createdAt",
          "type": "DateTime",
          "constraints": ""
        }
      ]
    },
    {
      "name": "Category",
      "fields": [
        {
          "name": "categoryId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "name",
          "type": "string",
          "constraints": "unique"
        },
        {
          "name": "description",
          "type": "string",
          "constraints": "nullable"
        },
        {
          "name": "parentCategoryId",
          "type": "UUID",
          "constraints": "nullable"
        },
        {
          "name": "depth",
          "type": "integer",
          "constraints": "1-3"
        },
        {
          "name": "children",
          "type": "array",
          "constraints": "nested categories"
        }
      ]
    },
    {
      "name": "SavedPaymentMethod",
      "fields": [
        {
          "name": "paymentMethodId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "type",
          "type": "enum",
          "constraints": "credit_card | paypal"
        },
        {
          "name": "lastFourDigits",
          "type": "string",
          "constraints": "for credit card"
        },
        {
          "name": "cardBrand",
          "type": "enum",
          "constraints": "visa | mastercard | amex"
        },
        {
          "name": "paypalEmail",
          "type": "string",
          "constraints": "for PayPal"
        },
        {
          "name": "isDefault",
          "type": "boolean",
          "constraints": ""
        },
        {
          "name": "expiresAt",
          "type": "string",
          "constraints": "MM/YY for cards"
        }
      ]
    },
    {
      "name": "InventoryAuditEntry",
      "fields": [
        {
          "name": "auditLogId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "productId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "previousValue",
          "type": "integer",
          "constraints": ""
        },
        {
          "name": "newValue",
          "type": "integer",
          "constraints": ""
        },
        {
          "name": "adjustment",
          "type": "integer",
          "constraints": ""
        },
        {
          "name": "reason",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "userId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "userName",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "timestamp",
          "type": "DateTime",
          "constraints": ""
        }
      ]
    },
    {
      "name": "PriceChange",
      "fields": [
        {
          "name": "itemId",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "productName",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "oldPrice",
          "type": "Money",
          "constraints": ""
        },
        {
          "name": "newPrice",
          "type": "Money",
          "constraints": ""
        }
      ]
    },
    {
      "name": "MergeNotification",
      "fields": [
        {
          "name": "productName",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "message",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "type",
          "type": "enum",
          "constraints": "quantity_limited | item_merged"
        }
      ]
    },
    {
      "name": "BulkUpdateError",
      "fields": [
        {
          "name": "rowNumber",
          "type": "integer",
          "constraints": ""
        },
        {
          "name": "sku",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "errorCode",
          "type": "string",
          "constraints": ""
        },
        {
          "name": "errorMessage",
          "type": "string",
          "constraints": ""
        }
      ]
    }
  ],
  "tables": [
    {
      "id": "TBL-CUSTOMER-001",
      "name": "customers",
      "aggregate": "Customer",
      "purpose": "Stores customer account information",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "email",
          "type": "VARCHAR(255)",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "password_hash",
          "type": "VARCHAR(255)",
          "constraints": "NOT NULL"
        },
        {
          "name": "first_name",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL"
        },
        {
          "name": "last_name",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL"
        },
        {
          "name": "registration_status",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL",
          "default": "'unverified'"
        },
        {
          "name": "email_verified",
          "type": "BOOLEAN",
          "constraints": "NOT NULL",
          "default": "false"
        },
        {
          "name": "verification_token",
          "type": "VARCHAR(255)",
          "constraints": ""
        },
        {
          "name": "verification_token_expires_at",
          "type": "TIMESTAMP",
          "constraints": ""
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_customers_email",
          "columns": [
            "email"
          ]
        },
        {
          "name": "idx_customers_verification_token",
          "columns": [
            "verification_token"
          ]
        }
      ],
      "foreignKeys": [],
      "checkConstraints": [
        {
          "name": "chk_customer_registration_status",
          "expression": "registration_status IN ('unverified', 'registered')"
        }
      ]
    },
    {
      "id": "TBL-CUSTOMER-002",
      "name": "customer_shipping_addresses",
      "aggregate": "Customer",
      "purpose": "Stores customer saved shipping addresses",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "customer_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "street",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "city",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL"
        },
        {
          "name": "state",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL"
        },
        {
          "name": "postal_code",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL"
        },
        {
          "name": "country",
          "type": "CHAR(2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "recipient_name",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "is_default",
          "type": "BOOLEAN",
          "constraints": "NOT NULL",
          "default": "false"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_shipping_addresses_customer",
          "columns": [
            "customer_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "customer_id"
          ],
          "references": "customers(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": []
    },
    {
      "id": "TBL-CART-001",
      "name": "carts",
      "aggregate": "Cart",
      "purpose": "Stores shopping cart header information",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "customer_id",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "is_guest",
          "type": "BOOLEAN",
          "constraints": "NOT NULL",
          "default": "false"
        },
        {
          "name": "guest_session_id",
          "type": "VARCHAR(255)",
          "constraints": ""
        },
        {
          "name": "total_price_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL",
          "default": "0.00"
        },
        {
          "name": "total_price_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "last_activity_date",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_carts_customer",
          "columns": [
            "customer_id"
          ]
        },
        {
          "name": "idx_carts_guest_session",
          "columns": [
            "guest_session_id"
          ]
        },
        {
          "name": "idx_carts_last_activity",
          "columns": [
            "last_activity_date"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "customer_id"
          ],
          "references": "customers(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_cart_total_price",
          "expression": "total_price_amount \u003e= 0"
        }
      ]
    },
    {
      "id": "TBL-CART-002",
      "name": "cart_items",
      "aggregate": "Cart",
      "purpose": "Stores individual items in shopping carts",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "cart_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "variant_id",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "product_name",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "variant_description",
          "type": "VARCHAR(200)",
          "constraints": ""
        },
        {
          "name": "unit_price_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "unit_price_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "quantity",
          "type": "INTEGER",
          "constraints": "NOT NULL"
        },
        {
          "name": "subtotal_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "subtotal_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "added_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_cart_items_cart",
          "columns": [
            "cart_id"
          ]
        },
        {
          "name": "idx_cart_items_product",
          "columns": [
            "product_id"
          ]
        },
        {
          "name": "idx_cart_items_cart_product",
          "columns": [
            "cart_id",
            "product_id",
            "variant_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "cart_id"
          ],
          "references": "carts(id)",
          "onDelete": "CASCADE"
        },
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "RESTRICT"
        },
        {
          "columns": [
            "variant_id"
          ],
          "references": "product_variants(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_cart_item_quantity",
          "expression": "quantity \u003e 0"
        },
        {
          "name": "chk_cart_item_price",
          "expression": "unit_price_amount \u003e= 0 AND subtotal_amount \u003e= 0"
        }
      ]
    },
    {
      "id": "TBL-ORDER-001",
      "name": "orders",
      "aggregate": "Order",
      "purpose": "Stores order header information",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "order_number",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "customer_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "status",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL",
          "default": "'pending'"
        },
        {
          "name": "subtotal_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "subtotal_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "shipping_cost_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_cost_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "tax_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL",
          "default": "0.00"
        },
        {
          "name": "tax_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "total_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "total_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "shipping_street",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_city",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_state",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_postal_code",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_country",
          "type": "CHAR(2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "shipping_recipient_name",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "payment_type",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL"
        },
        {
          "name": "payment_last_four_digits",
          "type": "CHAR(4)",
          "constraints": ""
        },
        {
          "name": "payment_card_brand",
          "type": "VARCHAR(20)",
          "constraints": ""
        },
        {
          "name": "payment_paypal_email",
          "type": "VARCHAR(255)",
          "constraints": ""
        },
        {
          "name": "payment_transaction_id",
          "type": "VARCHAR(255)",
          "constraints": ""
        },
        {
          "name": "tracking_number",
          "type": "VARCHAR(100)",
          "constraints": ""
        },
        {
          "name": "cancellation_reason",
          "type": "VARCHAR(500)",
          "constraints": ""
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_orders_order_number",
          "columns": [
            "order_number"
          ]
        },
        {
          "name": "idx_orders_customer",
          "columns": [
            "customer_id"
          ]
        },
        {
          "name": "idx_orders_status",
          "columns": [
            "status"
          ]
        },
        {
          "name": "idx_orders_created",
          "columns": [
            "created_at"
          ]
        },
        {
          "name": "idx_orders_customer_status",
          "columns": [
            "customer_id",
            "status"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "customer_id"
          ],
          "references": "customers(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_order_status",
          "expression": "status IN ('pending', 'confirmed', 'shipped', 'delivered', 'cancelled')"
        },
        {
          "name": "chk_order_amounts",
          "expression": "total_amount \u003e= 0 AND subtotal_amount \u003e= 0 AND shipping_cost_amount \u003e= 0 AND tax_amount \u003e= 0"
        },
        {
          "name": "chk_order_payment_type",
          "expression": "payment_type IN ('credit_card', 'paypal')"
        }
      ]
    },
    {
      "id": "TBL-ORDER-002",
      "name": "order_line_items",
      "aggregate": "Order",
      "purpose": "Stores order line items (immutable snapshots)",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "order_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "variant_id",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "product_name",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "variant_description",
          "type": "VARCHAR(200)",
          "constraints": ""
        },
        {
          "name": "unit_price_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "unit_price_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "quantity",
          "type": "INTEGER",
          "constraints": "NOT NULL"
        },
        {
          "name": "subtotal_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "subtotal_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_order_line_items_order",
          "columns": [
            "order_id"
          ]
        },
        {
          "name": "idx_order_line_items_product",
          "columns": [
            "product_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "order_id"
          ],
          "references": "orders(id)",
          "onDelete": "CASCADE"
        },
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_line_item_quantity",
          "expression": "quantity \u003e 0"
        },
        {
          "name": "chk_line_item_price",
          "expression": "unit_price_amount \u003e= 0 AND subtotal_amount \u003e= 0"
        }
      ]
    },
    {
      "id": "TBL-ORDER-003",
      "name": "order_number_sequence",
      "aggregate": "Order",
      "purpose": "Tracks order number sequence per year",
      "fields": [
        {
          "name": "year",
          "type": "INTEGER",
          "constraints": "NOT NULL"
        },
        {
          "name": "last_sequence",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "0"
        }
      ],
      "primaryKey": {
        "columns": [
          "year"
        ]
      },
      "indexes": [],
      "foreignKeys": [],
      "checkConstraints": [
        {
          "name": "chk_sequence_positive",
          "expression": "last_sequence \u003e= 0"
        }
      ]
    },
    {
      "id": "TBL-PRODUCT-001",
      "name": "products",
      "aggregate": "Product",
      "purpose": "Stores product catalog information",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "name",
          "type": "VARCHAR(200)",
          "constraints": "NOT NULL"
        },
        {
          "name": "description",
          "type": "TEXT",
          "constraints": ""
        },
        {
          "name": "price_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL"
        },
        {
          "name": "price_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "category_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "is_active",
          "type": "BOOLEAN",
          "constraints": "NOT NULL",
          "default": "true"
        },
        {
          "name": "is_deleted",
          "type": "BOOLEAN",
          "constraints": "NOT NULL",
          "default": "false"
        },
        {
          "name": "status",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL",
          "default": "'draft'"
        },
        {
          "name": "created_by",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "updated_by",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_products_category",
          "columns": [
            "category_id"
          ]
        },
        {
          "name": "idx_products_active",
          "columns": [
            "is_active",
            "is_deleted"
          ]
        },
        {
          "name": "idx_products_name",
          "columns": [
            "name"
          ]
        },
        {
          "name": "idx_products_created",
          "columns": [
            "created_at"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "category_id"
          ],
          "references": "categories(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_product_price",
          "expression": "price_amount \u003e= 0.01"
        },
        {
          "name": "chk_product_name_length",
          "expression": "LENGTH(name) \u003e= 2 AND LENGTH(name) \u003c= 200"
        },
        {
          "name": "chk_product_status",
          "expression": "status IN ('draft', 'active', 'inactive')"
        }
      ]
    },
    {
      "id": "TBL-PRODUCT-002",
      "name": "product_variants",
      "aggregate": "Product",
      "purpose": "Stores product variant information (size, color, etc.)",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "sku",
          "type": "VARCHAR(50)",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "size",
          "type": "VARCHAR(50)",
          "constraints": ""
        },
        {
          "name": "color",
          "type": "VARCHAR(50)",
          "constraints": ""
        },
        {
          "name": "price_adjustment_amount",
          "type": "DECIMAL(10,2)",
          "constraints": "NOT NULL",
          "default": "0.00"
        },
        {
          "name": "price_adjustment_currency",
          "type": "CHAR(3)",
          "constraints": "NOT NULL",
          "default": "'USD'"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_product_variants_product",
          "columns": [
            "product_id"
          ]
        },
        {
          "name": "idx_product_variants_sku",
          "columns": [
            "sku"
          ]
        },
        {
          "name": "idx_product_variants_combination",
          "columns": [
            "product_id",
            "size",
            "color"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_variant_has_attribute",
          "expression": "size IS NOT NULL OR color IS NOT NULL"
        }
      ]
    },
    {
      "id": "TBL-PRODUCT-003",
      "name": "product_images",
      "aggregate": "Product",
      "purpose": "Stores product image URLs and metadata",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "url",
          "type": "VARCHAR(500)",
          "constraints": "NOT NULL"
        },
        {
          "name": "is_primary",
          "type": "BOOLEAN",
          "constraints": "NOT NULL",
          "default": "false"
        },
        {
          "name": "display_order",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "0"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_product_images_product",
          "columns": [
            "product_id"
          ]
        },
        {
          "name": "idx_product_images_primary",
          "columns": [
            "product_id",
            "is_primary"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": []
    },
    {
      "id": "TBL-CATEGORY-001",
      "name": "categories",
      "aggregate": "Category",
      "purpose": "Stores product category hierarchy",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "name",
          "type": "VARCHAR(100)",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "description",
          "type": "TEXT",
          "constraints": ""
        },
        {
          "name": "parent_category_id",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "depth",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "1"
        },
        {
          "name": "display_order",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "0"
        },
        {
          "name": "is_active",
          "type": "BOOLEAN",
          "constraints": "NOT NULL",
          "default": "true"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_categories_name",
          "columns": [
            "name"
          ]
        },
        {
          "name": "idx_categories_parent",
          "columns": [
            "parent_category_id"
          ]
        },
        {
          "name": "idx_categories_active",
          "columns": [
            "is_active"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "parent_category_id"
          ],
          "references": "categories(id)",
          "onDelete": "RESTRICT"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_category_depth",
          "expression": "depth \u003e= 1 AND depth \u003c= 3"
        },
        {
          "name": "chk_category_not_self_parent",
          "expression": "parent_category_id IS NULL OR parent_category_id != id"
        }
      ]
    },
    {
      "id": "TBL-INVENTORY-001",
      "name": "inventory",
      "aggregate": "Inventory",
      "purpose": "Tracks product stock levels and reservations",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL UNIQUE"
        },
        {
          "name": "stock_level",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "0"
        },
        {
          "name": "reserved_quantity",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "0"
        },
        {
          "name": "low_stock_threshold",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "10"
        },
        {
          "name": "version",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "1"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_inventory_product",
          "columns": [
            "product_id"
          ]
        },
        {
          "name": "idx_inventory_low_stock",
          "columns": [
            "stock_level",
            "low_stock_threshold"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_inventory_stock_level",
          "expression": "stock_level \u003e= 0"
        },
        {
          "name": "chk_inventory_reserved",
          "expression": "reserved_quantity \u003e= 0 AND reserved_quantity \u003c= stock_level"
        },
        {
          "name": "chk_inventory_threshold",
          "expression": "low_stock_threshold \u003e= 0"
        }
      ]
    },
    {
      "id": "TBL-INVENTORY-002",
      "name": "inventory_audit_log",
      "aggregate": "Inventory",
      "purpose": "Tracks all inventory changes for audit purposes",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "inventory_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "product_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "previous_value",
          "type": "INTEGER",
          "constraints": "NOT NULL"
        },
        {
          "name": "new_value",
          "type": "INTEGER",
          "constraints": "NOT NULL"
        },
        {
          "name": "adjustment",
          "type": "INTEGER",
          "constraints": "NOT NULL"
        },
        {
          "name": "reason",
          "type": "VARCHAR(255)",
          "constraints": "NOT NULL"
        },
        {
          "name": "operation_type",
          "type": "VARCHAR(50)",
          "constraints": "NOT NULL"
        },
        {
          "name": "user_id",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "order_id",
          "type": "UUID",
          "constraints": ""
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_inventory_audit_inventory",
          "columns": [
            "inventory_id"
          ]
        },
        {
          "name": "idx_inventory_audit_product",
          "columns": [
            "product_id"
          ]
        },
        {
          "name": "idx_inventory_audit_created",
          "columns": [
            "created_at"
          ]
        },
        {
          "name": "idx_inventory_audit_user",
          "columns": [
            "user_id"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "inventory_id"
          ],
          "references": "inventory(id)",
          "onDelete": "CASCADE"
        },
        {
          "columns": [
            "product_id"
          ],
          "references": "products(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_audit_operation_type",
          "expression": "operation_type IN ('set', 'adjust', 'reserve', 'release', 'deduct', 'restock')"
        }
      ]
    },
    {
      "id": "TBL-PAYMENT-001",
      "name": "saved_payment_methods",
      "aggregate": "Customer",
      "purpose": "Stores customer saved payment methods (tokenized)",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "customer_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "payment_type",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL"
        },
        {
          "name": "token",
          "type": "VARCHAR(255)",
          "constraints": "NOT NULL"
        },
        {
          "name": "last_four_digits",
          "type": "CHAR(4)",
          "constraints": ""
        },
        {
          "name": "card_brand",
          "type": "VARCHAR(20)",
          "constraints": ""
        },
        {
          "name": "paypal_email",
          "type": "VARCHAR(255)",
          "constraints": ""
        },
        {
          "name": "expires_at",
          "type": "VARCHAR(7)",
          "constraints": ""
        },
        {
          "name": "is_default",
          "type": "BOOLEAN",
          "constraints": "NOT NULL",
          "default": "false"
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_saved_payments_customer",
          "columns": [
            "customer_id"
          ]
        },
        {
          "name": "idx_saved_payments_default",
          "columns": [
            "customer_id",
            "is_default"
          ]
        }
      ],
      "foreignKeys": [
        {
          "columns": [
            "customer_id"
          ],
          "references": "customers(id)",
          "onDelete": "CASCADE"
        }
      ],
      "checkConstraints": [
        {
          "name": "chk_payment_method_type",
          "expression": "payment_type IN ('credit_card', 'paypal')"
        },
        {
          "name": "chk_payment_card_brand",
          "expression": "card_brand IS NULL OR card_brand IN ('visa', 'mastercard', 'amex')"
        }
      ]
    },
    {
      "id": "TBL-EMAIL-001",
      "name": "email_queue",
      "aggregate": "System",
      "purpose": "Queue for outbound emails with deduplication",
      "fields": [
        {
          "name": "id",
          "type": "UUID",
          "constraints": "NOT NULL",
          "default": "gen_random_uuid()"
        },
        {
          "name": "email_type",
          "type": "VARCHAR(50)",
          "constraints": "NOT NULL"
        },
        {
          "name": "recipient_email",
          "type": "VARCHAR(255)",
          "constraints": "NOT NULL"
        },
        {
          "name": "subject",
          "type": "VARCHAR(255)",
          "constraints": "NOT NULL"
        },
        {
          "name": "reference_type",
          "type": "VARCHAR(50)",
          "constraints": "NOT NULL"
        },
        {
          "name": "reference_id",
          "type": "UUID",
          "constraints": "NOT NULL"
        },
        {
          "name": "payload",
          "type": "JSONB",
          "constraints": "NOT NULL"
        },
        {
          "name": "status",
          "type": "VARCHAR(20)",
          "constraints": "NOT NULL",
          "default": "'pending'"
        },
        {
          "name": "retry_count",
          "type": "INTEGER",
          "constraints": "NOT NULL",
          "default": "0"
        },
        {
          "name": "last_error",
          "type": "TEXT",
          "constraints": ""
        },
        {
          "name": "sent_at",
          "type": "TIMESTAMP",
          "constraints": ""
        },
        {
          "name": "created_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        },
        {
          "name": "updated_at",
          "type": "TIMESTAMP",
          "constraints": "NOT NULL",
          "default": "NOW()"
        }
      ],
      "primaryKey": {
        "columns": [
          "id"
        ]
      },
      "indexes": [
        {
          "name": "idx_email_queue_status",
          "columns": [
            "status"
          ]
        },
        {
          "name": "idx_email_queue_reference",
          "columns": [
            "reference_type",
            "reference_id"
          ]
        },
        {
          "name": "idx_email_queue_dedup",
          "columns": [
            "email_type",
            "reference_type",
            "reference_id"
          ]
        }
      ],
      "foreignKeys": [],
      "checkConstraints": [
        {
          "name": "chk_email_status",
          "expression": "status IN ('pending', 'processing', 'sent', 'failed')"
        },
        {
          "name": "chk_email_type",
          "expression": "email_type IN ('order_confirmation', 'order_shipped', 'order_cancelled', 'verification', 'password_reset')"
        }
      ]
    }
  ],
  "tech_specs": [
    {
      "id": "TS-BR-CUST-001",
      "name": "Order placement authorization",
      "br_ref": "BR-CUST-001",
      "rule": "Only registered and email-verified customers can place orders",
      "implementation": "Check customer registration status and email verification flag before order creation in order service",
      "validation_points": [
        "Order creation API",
        "Checkout flow initiation"
      ],
      "data_requirements": [
        {
          "field": "customerId",
          "type": "UUID",
          "constraints": "NOT NULL, valid reference",
          "source": "BR-CUST-001"
        },
        {
          "field": "registrationStatus",
          "type": "enum",
          "constraints": "= 'registered'",
          "source": "BR-CUST-001"
        },
        {
          "field": "emailVerified",
          "type": "boolean",
          "constraints": "= true",
          "source": "BR-CUST-001"
        }
      ],
      "error_handling": [
        {
          "condition": "registrationStatus != 'registered'",
          "error_code": "UNAUTHORIZED_ORDER",
          "message": "Registration required to place orders",
          "http_status": 403
        },
        {
          "condition": "emailVerified != true",
          "error_code": "EMAIL_NOT_VERIFIED",
          "message": "Please verify your email before ordering",
          "http_status": 403
        }
      ],
      "related_acs": [
        "AC-CUST-002",
        "AC-ORDER-001"
      ]
    },
    {
      "id": "TS-BR-CUST-002",
      "name": "Unique email constraint",
      "br_ref": "BR-CUST-002",
      "rule": "Each customer account must have a unique email address",
      "implementation": "Add UNIQUE constraint on email column, check before insert in registration service",
      "validation_points": [
        "Customer registration API",
        "Email update API"
      ],
      "data_requirements": [
        {
          "field": "email",
          "type": "varchar(255)",
          "constraints": "UNIQUE, NOT NULL, valid email format",
          "source": "BR-CUST-002"
        }
      ],
      "error_handling": [
        {
          "condition": "email already exists in database",
          "error_code": "DUPLICATE_EMAIL",
          "message": "Email already registered. Please login or reset password",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-CUST-001"
      ]
    },
    {
      "id": "TS-BR-CUST-003",
      "name": "Password validation rules",
      "br_ref": "BR-CUST-003",
      "rule": "Customer passwords must be at least 8 characters with at least one number",
      "implementation": "Regex validation pattern: ^(?=.*[0-9]).{8,}$ applied before password hashing",
      "validation_points": [
        "Registration API",
        "Password change API",
        "Password reset API"
      ],
      "data_requirements": [
        {
          "field": "password",
          "type": "varchar(255)",
          "constraints": "length \u003e= 8, contains digit",
          "source": "BR-CUST-003"
        }
      ],
      "error_handling": [
        {
          "condition": "password.length \u003c 8",
          "error_code": "INVALID_PASSWORD",
          "message": "Password must be at least 8 characters",
          "http_status": 400
        },
        {
          "condition": "!password.match(/[0-9]/)",
          "error_code": "INVALID_PASSWORD",
          "message": "Password must contain at least one number",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-CUST-001"
      ]
    },
    {
      "id": "TS-BR-PROD-001",
      "name": "Product price validation",
      "br_ref": "BR-PROD-001",
      "rule": "Product prices must be positive with minimum $0.01",
      "implementation": "Decimal validation with 2 decimal places, minimum value check in product service",
      "validation_points": [
        "Product creation API",
        "Product edit API"
      ],
      "data_requirements": [
        {
          "field": "price",
          "type": "decimal(10,2)",
          "constraints": "\u003e= 0.01",
          "source": "BR-PROD-001"
        }
      ],
      "error_handling": [
        {
          "condition": "price \u003c 0.01",
          "error_code": "INVALID_PRICE",
          "message": "Price must be at least $0.01",
          "http_status": 400
        },
        {
          "condition": "price has more than 2 decimals",
          "error_code": "INVALID_PRICE",
          "message": "Price must have exactly 2 decimal places",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ADMIN-001"
      ]
    },
    {
      "id": "TS-BR-PROD-002",
      "name": "Product name length validation",
      "br_ref": "BR-PROD-002",
      "rule": "Product names must be between 2 and 200 characters",
      "implementation": "String length validation in product service before database insert/update",
      "validation_points": [
        "Product creation API",
        "Product edit API"
      ],
      "data_requirements": [
        {
          "field": "name",
          "type": "varchar(200)",
          "constraints": "2 \u003c= length \u003c= 200, NOT NULL",
          "source": "BR-PROD-002"
        }
      ],
      "error_handling": [
        {
          "condition": "name.length \u003c 2 || name is empty",
          "error_code": "NAME_REQUIRED",
          "message": "Product name is required",
          "http_status": 400
        },
        {
          "condition": "name.length \u003e 200",
          "error_code": "NAME_TOO_LONG",
          "message": "Product name cannot exceed 200 characters",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ADMIN-001"
      ]
    },
    {
      "id": "TS-BR-PROD-003",
      "name": "Product soft delete implementation",
      "br_ref": "BR-PROD-003",
      "rule": "Products with order history must be soft-deleted, not permanently deleted",
      "implementation": "Check OrderLineItem references before delete; set isDeleted=true and deletedAt timestamp instead of physical delete",
      "validation_points": [
        "Product delete API"
      ],
      "data_requirements": [
        {
          "field": "isDeleted",
          "type": "boolean",
          "constraints": "default false",
          "source": "BR-PROD-003"
        },
        {
          "field": "deletedAt",
          "type": "timestamp",
          "constraints": "nullable",
          "source": "BR-PROD-003"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-ADMIN-005"
      ]
    },
    {
      "id": "TS-BR-PROD-004",
      "name": "Variant SKU uniqueness",
      "br_ref": "BR-PROD-004",
      "rule": "Each product variant must have a unique SKU",
      "implementation": "Add UNIQUE constraint on sku column in product_variants table",
      "validation_points": [
        "Variant creation API",
        "Variant edit API",
        "Bulk import"
      ],
      "data_requirements": [
        {
          "field": "sku",
          "type": "varchar(50)",
          "constraints": "UNIQUE, NOT NULL",
          "source": "BR-PROD-004"
        }
      ],
      "error_handling": [
        {
          "condition": "sku already exists",
          "error_code": "DUPLICATE_SKU",
          "message": "SKU already exists",
          "http_status": 409
        }
      ],
      "related_acs": [
        "AC-PROD-003"
      ]
    },
    {
      "id": "TS-BR-CART-001",
      "name": "Stock availability for cart add",
      "br_ref": "BR-CART-001",
      "rule": "Products must be in stock to be added to cart",
      "implementation": "Query inventory.availableQuantity before cart item insert; reject if zero",
      "validation_points": [
        "Add to cart API",
        "Cart UI add button"
      ],
      "data_requirements": [
        {
          "field": "productId",
          "type": "UUID",
          "constraints": "valid product reference",
          "source": "BR-CART-001"
        },
        {
          "field": "availableQuantity",
          "type": "integer",
          "constraints": "\u003e 0 for add",
          "source": "BR-CART-001"
        }
      ],
      "error_handling": [
        {
          "condition": "availableQuantity == 0",
          "error_code": "OUT_OF_STOCK",
          "message": "Product is out of stock",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-CART-001"
      ]
    },
    {
      "id": "TS-BR-CART-002",
      "name": "Cart quantity stock limit",
      "br_ref": "BR-CART-002",
      "rule": "Cart item quantity cannot exceed available stock",
      "implementation": "Cap requested quantity to availableQuantity; return notification if capped",
      "validation_points": [
        "Add to cart API",
        "Update quantity API"
      ],
      "data_requirements": [
        {
          "field": "quantity",
          "type": "integer",
          "constraints": "\u003c= availableQuantity",
          "source": "BR-CART-002"
        },
        {
          "field": "availableQuantity",
          "type": "integer",
          "constraints": "from inventory table",
          "source": "BR-CART-002"
        }
      ],
      "error_handling": [
        {
          "condition": "requestedQty \u003e availableQuantity",
          "error_code": "QUANTITY_LIMITED",
          "message": "Only {available} available",
          "http_status": 200
        }
      ],
      "related_acs": [
        "AC-CART-001",
        "AC-CART-002",
        "AC-CART-004"
      ]
    },
    {
      "id": "TS-BR-CART-003",
      "name": "Positive cart quantity enforcement",
      "br_ref": "BR-CART-003",
      "rule": "Cart item quantities must be at least 1",
      "implementation": "If quantity set to 0 or less, remove item from cart instead of rejecting",
      "validation_points": [
        "Update quantity API"
      ],
      "data_requirements": [
        {
          "field": "quantity",
          "type": "integer",
          "constraints": "\u003e= 1 or triggers removal",
          "source": "BR-CART-003"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-CART-004"
      ]
    },
    {
      "id": "TS-BR-CART-004",
      "name": "Cart expiration mechanism",
      "br_ref": "BR-CART-004",
      "rule": "Inactive carts expire after 30 days (logged-in) or 7 days (guest)",
      "implementation": "Background job runs daily to clear expired carts; lazy check on cart access",
      "validation_points": [
        "Cart access API",
        "Background scheduler"
      ],
      "data_requirements": [
        {
          "field": "lastActivityDate",
          "type": "timestamp",
          "constraints": "NOT NULL, updated on cart ops",
          "source": "BR-CART-004"
        },
        {
          "field": "isGuest",
          "type": "boolean",
          "constraints": "determines expiry threshold",
          "source": "BR-CART-004"
        }
      ],
      "error_handling": [
        {
          "condition": "cart expired on access",
          "error_code": "CART_EXPIRED",
          "message": "Your cart has expired",
          "http_status": 410
        }
      ],
      "related_acs": [
        "AC-CART-009"
      ]
    },
    {
      "id": "TS-BR-CART-005",
      "name": "Variant selection requirement",
      "br_ref": "BR-CART-005",
      "rule": "For products with variants, a specific variant must be selected before adding to cart",
      "implementation": "Check if product.hasVariants; require variantId in add-to-cart if true",
      "validation_points": [
        "Add to cart API",
        "Product detail UI"
      ],
      "data_requirements": [
        {
          "field": "variantId",
          "type": "UUID",
          "constraints": "required if product has variants",
          "source": "BR-CART-005"
        },
        {
          "field": "hasVariants",
          "type": "boolean",
          "constraints": "from product",
          "source": "BR-CART-005"
        }
      ],
      "error_handling": [
        {
          "condition": "hasVariants \u0026\u0026 !variantId",
          "error_code": "VARIANT_REQUIRED",
          "message": "Please select a variant",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-PROD-003",
        "AC-CART-001"
      ]
    },
    {
      "id": "TS-BR-ORDER-001",
      "name": "Free shipping calculation",
      "br_ref": "BR-ORDER-001",
      "rule": "Orders over $50 qualify for free shipping",
      "implementation": "If subtotal \u003e 50.00, set shippingCost = 0.00; else apply standard rate",
      "validation_points": [
        "Checkout totals calculation",
        "Order creation"
      ],
      "data_requirements": [
        {
          "field": "subtotal",
          "type": "decimal(10,2)",
          "constraints": "sum of line items",
          "source": "BR-ORDER-001"
        },
        {
          "field": "shippingCost",
          "type": "decimal(10,2)",
          "constraints": "0.00 if subtotal \u003e 50",
          "source": "BR-ORDER-001"
        },
        {
          "field": "freeShippingThreshold",
          "type": "decimal",
          "constraints": "config value = 50.00",
          "source": "BR-ORDER-001"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-ORDER-001",
        "AC-ORDER-002"
      ]
    },
    {
      "id": "TS-BR-ORDER-002",
      "name": "Order cancellation status check",
      "br_ref": "BR-ORDER-002",
      "rule": "Orders can only be cancelled before shipping",
      "implementation": "Verify order.status in ('pending', 'confirmed') before allowing cancel",
      "validation_points": [
        "Cancel order API"
      ],
      "data_requirements": [
        {
          "field": "status",
          "type": "enum",
          "constraints": "pending|confirmed for cancel",
          "source": "BR-ORDER-002"
        }
      ],
      "error_handling": [
        {
          "condition": "status in ('shipped', 'delivered', 'cancelled')",
          "error_code": "ORDER_ALREADY_SHIPPED",
          "message": "Cannot cancel shipped order",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ORDER-008",
        "AC-ORDER-009",
        "AC-ORDER-010"
      ]
    },
    {
      "id": "TS-BR-ORDER-003",
      "name": "Order status state machine",
      "br_ref": "BR-ORDER-003",
      "rule": "Order status can only transition through valid states",
      "implementation": "State machine with allowed transitions map; validate before update",
      "validation_points": [
        "Update order status API"
      ],
      "data_requirements": [
        {
          "field": "currentStatus",
          "type": "enum",
          "constraints": "valid order status",
          "source": "BR-ORDER-003"
        },
        {
          "field": "newStatus",
          "type": "enum",
          "constraints": "valid transition from current",
          "source": "BR-ORDER-003"
        }
      ],
      "error_handling": [
        {
          "condition": "invalid transition",
          "error_code": "INVALID_STATUS_TRANSITION",
          "message": "Cannot transition from {current} to {new}",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ADMIN-008"
      ]
    },
    {
      "id": "TS-BR-ORDER-004",
      "name": "Order immutability after shipping",
      "br_ref": "BR-ORDER-004",
      "rule": "Orders cannot be modified after shipping",
      "implementation": "Check status before any modification operation; reject if shipped/delivered/cancelled",
      "validation_points": [
        "All order modification endpoints"
      ],
      "data_requirements": [
        {
          "field": "status",
          "type": "enum",
          "constraints": "must not be shipped/delivered/cancelled",
          "source": "BR-ORDER-004"
        }
      ],
      "error_handling": [
        {
          "condition": "status in ('shipped', 'delivered', 'cancelled')",
          "error_code": "ORDER_NOT_MODIFIABLE",
          "message": "Order cannot be modified",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ORDER-008",
        "AC-ORDER-010"
      ]
    },
    {
      "id": "TS-BR-ORDER-005",
      "name": "Minimum line item validation",
      "br_ref": "BR-ORDER-005",
      "rule": "Orders must contain at least one line item",
      "implementation": "Validate lineItems array length \u003e= 1 before order creation",
      "validation_points": [
        "Place order API"
      ],
      "data_requirements": [
        {
          "field": "lineItems",
          "type": "array",
          "constraints": "length \u003e= 1",
          "source": "BR-ORDER-005"
        }
      ],
      "error_handling": [
        {
          "condition": "lineItems.length == 0",
          "error_code": "EMPTY_ORDER",
          "message": "Order must contain at least one item",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ORDER-001"
      ]
    },
    {
      "id": "TS-BR-ORDER-006",
      "name": "Price snapshot implementation",
      "br_ref": "BR-ORDER-006",
      "rule": "Order line items must capture the price at order placement, not current price",
      "implementation": "Copy product.price to orderLineItem.unitPrice at order creation; store as immutable",
      "validation_points": [
        "Place order API"
      ],
      "data_requirements": [
        {
          "field": "unitPrice",
          "type": "decimal(10,2)",
          "constraints": "copied from product, immutable",
          "source": "BR-ORDER-006"
        },
        {
          "field": "productPriceAtOrder",
          "type": "decimal(10,2)",
          "constraints": "snapshot value",
          "source": "BR-ORDER-006"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-ORDER-004"
      ]
    },
    {
      "id": "TS-BR-INV-001",
      "name": "Non-negative inventory enforcement",
      "br_ref": "BR-INV-001",
      "rule": "Inventory stock level cannot go below zero",
      "implementation": "Database CHECK constraint; validate before adjustment operations",
      "validation_points": [
        "Inventory adjustment API",
        "Order placement stock decrement"
      ],
      "data_requirements": [
        {
          "field": "stockLevel",
          "type": "integer",
          "constraints": "\u003e= 0, CHECK constraint",
          "source": "BR-INV-001"
        }
      ],
      "error_handling": [
        {
          "condition": "adjustment would result in negative",
          "error_code": "INSUFFICIENT_STOCK",
          "message": "Insufficient stock available",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ADMIN-009",
        "AC-ADMIN-010"
      ]
    },
    {
      "id": "TS-BR-INV-002",
      "name": "Stock validation at checkout",
      "br_ref": "BR-INV-002",
      "rule": "Products cannot be sold when out of stock (no backorders)",
      "implementation": "Validate all cart items have sufficient stock atomically before order creation",
      "validation_points": [
        "Place order API"
      ],
      "data_requirements": [
        {
          "field": "requestedQuantity",
          "type": "integer",
          "constraints": "from cart item",
          "source": "BR-INV-002"
        },
        {
          "field": "availableQuantity",
          "type": "integer",
          "constraints": "\u003e= requestedQuantity",
          "source": "BR-INV-002"
        }
      ],
      "error_handling": [
        {
          "condition": "availableQuantity \u003c requestedQuantity",
          "error_code": "STOCK_UNAVAILABLE",
          "message": "{product} has insufficient stock",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ORDER-001"
      ]
    },
    {
      "id": "TS-BR-INV-003",
      "name": "Inventory restoration on cancel",
      "br_ref": "BR-INV-003",
      "rule": "Cancelled orders must restore inventory automatically",
      "implementation": "In cancel operation, iterate line items and increment stock by quantity",
      "validation_points": [
        "Cancel order API"
      ],
      "data_requirements": [
        {
          "field": "lineItems",
          "type": "array",
          "constraints": "order line items with quantities",
          "source": "BR-INV-003"
        },
        {
          "field": "stockLevel",
          "type": "integer",
          "constraints": "incremented by cancelled qty",
          "source": "BR-INV-003"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-ORDER-008",
        "AC-ORDER-009"
      ]
    },
    {
      "id": "TS-BR-INV-004",
      "name": "Inventory audit logging",
      "br_ref": "BR-INV-004",
      "rule": "All inventory changes must be logged with before/after values and reason",
      "implementation": "Create audit log entry in same transaction as inventory change",
      "validation_points": [
        "All inventory modification operations"
      ],
      "data_requirements": [
        {
          "field": "previousValue",
          "type": "integer",
          "constraints": "stock before change",
          "source": "BR-INV-004"
        },
        {
          "field": "newValue",
          "type": "integer",
          "constraints": "stock after change",
          "source": "BR-INV-004"
        },
        {
          "field": "reason",
          "type": "varchar(255)",
          "constraints": "NOT NULL",
          "source": "BR-INV-004"
        },
        {
          "field": "userId",
          "type": "UUID",
          "constraints": "user who made change",
          "source": "BR-INV-004"
        },
        {
          "field": "timestamp",
          "type": "timestamp",
          "constraints": "auto-generated",
          "source": "BR-INV-004"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-ADMIN-009",
        "AC-ADMIN-010"
      ]
    },
    {
      "id": "TS-BR-PAY-001",
      "name": "Payment authorization flow",
      "br_ref": "BR-PAY-001",
      "rule": "Payment must be authorized before order is created",
      "implementation": "Call payment gateway authorization; only create order if authorization succeeds",
      "validation_points": [
        "Place order API - before order insert"
      ],
      "data_requirements": [
        {
          "field": "paymentMethodId",
          "type": "UUID",
          "constraints": "valid payment method",
          "source": "BR-PAY-001"
        },
        {
          "field": "amount",
          "type": "decimal(10,2)",
          "constraints": "order total",
          "source": "BR-PAY-001"
        },
        {
          "field": "authorizationId",
          "type": "varchar(100)",
          "constraints": "from gateway response",
          "source": "BR-PAY-001"
        }
      ],
      "error_handling": [
        {
          "condition": "authorization fails",
          "error_code": "PAYMENT_FAILED",
          "message": "Payment authorization failed",
          "http_status": 402
        }
      ],
      "related_acs": [
        "AC-ORDER-001",
        "AC-PAY-001"
      ]
    },
    {
      "id": "TS-BR-PAY-002",
      "name": "Credit card type validation",
      "br_ref": "BR-PAY-002",
      "rule": "Only Visa, Mastercard, and American Express credit cards are accepted",
      "implementation": "Detect card type from BIN; reject if not in allowed list",
      "validation_points": [
        "Payment method creation",
        "Checkout payment"
      ],
      "data_requirements": [
        {
          "field": "cardType",
          "type": "enum",
          "constraints": "visa|mastercard|amex",
          "source": "BR-PAY-002"
        },
        {
          "field": "cardNumber",
          "type": "varchar(19)",
          "constraints": "for BIN detection",
          "source": "BR-PAY-002"
        }
      ],
      "error_handling": [
        {
          "condition": "cardType not in allowed list",
          "error_code": "UNSUPPORTED_CARD_TYPE",
          "message": "Card type not accepted. Use Visa, Mastercard, or Amex",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-PAY-001"
      ]
    },
    {
      "id": "TS-BR-PAY-003",
      "name": "Automatic refund on cancellation",
      "br_ref": "BR-PAY-003",
      "rule": "Cancelled orders must be refunded to the original payment method",
      "implementation": "Call payment gateway refund API with original transaction reference",
      "validation_points": [
        "Cancel order API - after status change"
      ],
      "data_requirements": [
        {
          "field": "originalTransactionId",
          "type": "varchar(100)",
          "constraints": "from order payment",
          "source": "BR-PAY-003"
        },
        {
          "field": "refundAmount",
          "type": "decimal(10,2)",
          "constraints": "order total",
          "source": "BR-PAY-003"
        }
      ],
      "error_handling": [
        {
          "condition": "refund API fails",
          "error_code": "REFUND_FAILED",
          "message": "Refund processing failed",
          "http_status": 500
        }
      ],
      "related_acs": [
        "AC-ORDER-008"
      ]
    },
    {
      "id": "TS-BR-SHIP-001",
      "name": "Domestic shipping validation",
      "br_ref": "BR-SHIP-001",
      "rule": "Shipping is only available within the domestic country",
      "implementation": "Compare address country to configured domestic country code",
      "validation_points": [
        "Address save API",
        "Checkout shipping step"
      ],
      "data_requirements": [
        {
          "field": "country",
          "type": "varchar(2)",
          "constraints": "ISO country code",
          "source": "BR-SHIP-001"
        },
        {
          "field": "domesticCountry",
          "type": "varchar(2)",
          "constraints": "config value",
          "source": "BR-SHIP-001"
        }
      ],
      "error_handling": [
        {
          "condition": "country != domesticCountry",
          "error_code": "UNSUPPORTED_SHIPPING_REGION",
          "message": "Shipping not available to this country",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-CUST-003"
      ]
    },
    {
      "id": "TS-BR-SHIP-002",
      "name": "Required address fields validation",
      "br_ref": "BR-SHIP-002",
      "rule": "Shipping addresses must include all required fields",
      "implementation": "Validate all required fields are non-empty before save",
      "validation_points": [
        "Address save API",
        "Checkout shipping step"
      ],
      "data_requirements": [
        {
          "field": "street",
          "type": "varchar(255)",
          "constraints": "NOT NULL, NOT EMPTY",
          "source": "BR-SHIP-002"
        },
        {
          "field": "city",
          "type": "varchar(100)",
          "constraints": "NOT NULL, NOT EMPTY",
          "source": "BR-SHIP-002"
        },
        {
          "field": "state",
          "type": "varchar(100)",
          "constraints": "NOT NULL, NOT EMPTY",
          "source": "BR-SHIP-002"
        },
        {
          "field": "postalCode",
          "type": "varchar(20)",
          "constraints": "NOT NULL, NOT EMPTY",
          "source": "BR-SHIP-002"
        },
        {
          "field": "country",
          "type": "varchar(2)",
          "constraints": "NOT NULL, NOT EMPTY",
          "source": "BR-SHIP-002"
        },
        {
          "field": "recipientName",
          "type": "varchar(200)",
          "constraints": "NOT NULL, NOT EMPTY",
          "source": "BR-SHIP-002"
        }
      ],
      "error_handling": [
        {
          "condition": "any required field empty",
          "error_code": "INVALID_ADDRESS",
          "message": "Missing required field: {fieldName}",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-CUST-003"
      ]
    },
    {
      "id": "TS-BR-CAT-001",
      "name": "Category nesting depth limit",
      "br_ref": "BR-CAT-001",
      "rule": "Category hierarchy is limited to 3 levels deep",
      "implementation": "Calculate depth by traversing parent chain; reject if would exceed 3",
      "validation_points": [
        "Category creation API",
        "Category move API"
      ],
      "data_requirements": [
        {
          "field": "parentId",
          "type": "UUID",
          "constraints": "nullable, valid category ref",
          "source": "BR-CAT-001"
        },
        {
          "field": "depth",
          "type": "integer",
          "constraints": "\u003c= 3",
          "source": "BR-CAT-001"
        }
      ],
      "error_handling": [
        {
          "condition": "calculated depth \u003e 3",
          "error_code": "MAX_NESTING_EXCEEDED",
          "message": "Category nesting limited to 3 levels",
          "http_status": 400
        }
      ],
      "related_acs": [
        "AC-ADMIN-013"
      ]
    },
    {
      "id": "TS-BR-EMAIL-001",
      "name": "Async email delivery",
      "br_ref": "BR-EMAIL-001",
      "rule": "Email delivery failures must not block order completion",
      "implementation": "Publish email event to message queue; process async with retry logic",
      "validation_points": [
        "Order creation - after commit"
      ],
      "data_requirements": [
        {
          "field": "orderId",
          "type": "UUID",
          "constraints": "for email content",
          "source": "BR-EMAIL-001"
        },
        {
          "field": "customerEmail",
          "type": "varchar(255)",
          "constraints": "recipient",
          "source": "BR-EMAIL-001"
        },
        {
          "field": "emailType",
          "type": "enum",
          "constraints": "order_confirmation",
          "source": "BR-EMAIL-001"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-ORDER-011"
      ]
    },
    {
      "id": "TS-BR-EMAIL-002",
      "name": "Email deduplication",
      "br_ref": "BR-EMAIL-002",
      "rule": "Duplicate email sends must be prevented",
      "implementation": "Check email_sent table for orderId+emailType before sending; mark sent atomically",
      "validation_points": [
        "Email processor - before send"
      ],
      "data_requirements": [
        {
          "field": "orderId",
          "type": "UUID",
          "constraints": "unique with emailType",
          "source": "BR-EMAIL-002"
        },
        {
          "field": "emailType",
          "type": "enum",
          "constraints": "part of unique key",
          "source": "BR-EMAIL-002"
        },
        {
          "field": "sentAt",
          "type": "timestamp",
          "constraints": "when email was sent",
          "source": "BR-EMAIL-002"
        }
      ],
      "error_handling": [],
      "related_acs": [
        "AC-ORDER-011"
      ]
    }
  ],
  "test_cases": [
    {
      "id": "TC-CUST-001-01",
      "name": "Register new customer successfully",
      "type": "happy_path",
      "ac_ref": "AC-CUST-001",
      "br_refs": [],
      "preconditions": [
        "Email not registered"
      ],
      "test_data": [
        {
          "field": "email",
          "value": "john@example.com",
          "notes": "Valid"
        },
        {
          "field": "password",
          "value": "SecurePass1",
          "notes": "Valid"
        },
        {
          "field": "first_name",
          "value": "John",
          "notes": ""
        },
        {
          "field": "last_name",
          "value": "Doe",
          "notes": ""
        }
      ],
      "steps": [
        "Submit registration form"
      ],
      "expected_results": [
        "Account created with unverified status",
        "Verification email sent"
      ]
    },
    {
      "id": "TC-CUST-001-02",
      "name": "Register with duplicate email fails",
      "type": "error_case",
      "ac_ref": "AC-CUST-001",
      "br_refs": [],
      "preconditions": [
        "Email already registered"
      ],
      "test_data": [
        {
          "field": "email",
          "value": "existing@example.com",
          "notes": "Existing"
        }
      ],
      "steps": [
        "Submit registration with existing email"
      ],
      "expected_results": [
        "DUPLICATE_EMAIL error",
        "Login suggestion shown"
      ]
    },
    {
      "id": "TC-CUST-002-01",
      "name": "Unverified user cannot place order",
      "type": "happy_path",
      "ac_ref": "AC-CUST-002",
      "br_refs": [],
      "preconditions": [
        "Customer registered",
        "Email unverified",
        "Cart has items"
      ],
      "test_data": [],
      "steps": [
        "Attempt to place order"
      ],
      "expected_results": [
        "EMAIL_NOT_VERIFIED error",
        "Verify email prompt shown"
      ]
    },
    {
      "id": "TC-CUST-003-01",
      "name": "Add new shipping address",
      "type": "happy_path",
      "ac_ref": "AC-CUST-003",
      "br_refs": [],
      "preconditions": [
        "Customer logged in",
        "One address exists"
      ],
      "test_data": [
        {
          "field": "street",
          "value": "456 Oak Ave",
          "notes": ""
        },
        {
          "field": "city",
          "value": "Boston",
          "notes": ""
        },
        {
          "field": "state",
          "value": "MA",
          "notes": ""
        },
        {
          "field": "postal_code",
          "value": "02101",
          "notes": ""
        },
        {
          "field": "country",
          "value": "US",
          "notes": ""
        }
      ],
      "steps": [
        "Add new address"
      ],
      "expected_results": [
        "Address saved",
        "Available for selection"
      ]
    },
    {
      "id": "TC-CUST-003-02",
      "name": "Add address with invalid postal code",
      "type": "error_case",
      "ac_ref": "AC-CUST-003",
      "br_refs": [],
      "preconditions": [
        "Customer logged in"
      ],
      "test_data": [
        {
          "field": "postal_code",
          "value": "INVALID",
          "notes": "Invalid format"
        }
      ],
      "steps": [
        "Submit address with bad postal code"
      ],
      "expected_results": [
        "INVALID_POSTAL_CODE error"
      ]
    },
    {
      "id": "TC-CUST-004-01",
      "name": "GDPR data erasure request",
      "type": "happy_path",
      "ac_ref": "AC-CUST-004",
      "br_refs": [],
      "preconditions": [
        "Customer registered",
        "No pending orders"
      ],
      "test_data": [],
      "steps": [
        "Request account deletion",
        "Confirm erasure"
      ],
      "expected_results": [
        "Personal data deleted",
        "Orders anonymized",
        "Confirmation sent"
      ]
    },
    {
      "id": "TC-CUST-004-02",
      "name": "GDPR erasure blocked by pending order",
      "type": "error_case",
      "ac_ref": "AC-CUST-004",
      "br_refs": [],
      "preconditions": [
        "Customer has pending order"
      ],
      "test_data": [],
      "steps": [
        "Request account deletion"
      ],
      "expected_results": [
        "PENDING_ORDERS_EXIST error"
      ]
    },
    {
      "id": "TC-PROD-001-01",
      "name": "Filter products by category and price",
      "type": "happy_path",
      "ac_ref": "AC-PROD-001",
      "br_refs": [],
      "preconditions": [
        "Products exist in multiple categories"
      ],
      "test_data": [
        {
          "field": "category",
          "value": "Electronics",
          "notes": ""
        },
        {
          "field": "price_min",
          "value": "50",
          "notes": ""
        },
        {
          "field": "price_max",
          "value": "200",
          "notes": ""
        },
        {
          "field": "availability",
          "value": "in stock",
          "notes": ""
        }
      ],
      "steps": [
        "Apply filters"
      ],
      "expected_results": [
        "Matching products shown",
        "Sorted by newest",
        "20 per page"
      ]
    },
    {
      "id": "TC-PROD-001-02",
      "name": "No products match filters",
      "type": "error_case",
      "ac_ref": "AC-PROD-001",
      "br_refs": [],
      "preconditions": [
        "No products match criteria"
      ],
      "test_data": [],
      "steps": [
        "Apply restrictive filters"
      ],
      "expected_results": [
        "No products found message",
        "Clear filters option"
      ]
    },
    {
      "id": "TC-PROD-002-01",
      "name": "View out-of-stock product",
      "type": "happy_path",
      "ac_ref": "AC-PROD-002",
      "br_refs": [],
      "preconditions": [
        "Product has zero stock"
      ],
      "test_data": [
        {
          "field": "product",
          "value": "Widget Pro",
          "notes": "Out of stock"
        }
      ],
      "steps": [
        "View product listing"
      ],
      "expected_results": [
        "Out of Stock indicator shown",
        "Add to Cart disabled"
      ]
    },
    {
      "id": "TC-PROD-003-01",
      "name": "View product with variants",
      "type": "happy_path",
      "ac_ref": "AC-PROD-003",
      "br_refs": [],
      "preconditions": [
        "Product has size and color variants"
      ],
      "test_data": [
        {
          "field": "product",
          "value": "T-Shirt",
          "notes": "Has variants"
        }
      ],
      "steps": [
        "View product detail",
        "Select variant"
      ],
      "expected_results": [
        "Variant options displayed",
        "Price/stock updates"
      ]
    },
    {
      "id": "TC-PROD-003-02",
      "name": "Selected variant out of stock",
      "type": "error_case",
      "ac_ref": "AC-PROD-003",
      "br_refs": [],
      "preconditions": [
        "Specific variant has no stock"
      ],
      "test_data": [
        {
          "field": "variant",
          "value": "Size L, Red",
          "notes": "Out of stock"
        }
      ],
      "steps": [
        "Select out-of-stock variant"
      ],
      "expected_results": [
        "Out of Stock shown for variant"
      ]
    },
    {
      "id": "TC-CART-001-01",
      "name": "Add product to cart",
      "type": "happy_path",
      "ac_ref": "AC-CART-001",
      "br_refs": [],
      "preconditions": [
        "Product in stock"
      ],
      "test_data": [
        {
          "field": "product",
          "value": "Widget",
          "notes": "10 in stock"
        },
        {
          "field": "quantity",
          "value": "2",
          "notes": ""
        },
        {
          "field": "price",
          "value": "25.00",
          "notes": ""
        }
      ],
      "steps": [
        "Add 2 units to cart"
      ],
      "expected_results": [
        "Cart shows qty 2",
        "Subtotal $50.00",
        "Toast notification"
      ]
    },
    {
      "id": "TC-CART-001-02",
      "name": "Add out-of-stock product fails",
      "type": "error_case",
      "ac_ref": "AC-CART-001",
      "br_refs": [],
      "preconditions": [
        "Product out of stock"
      ],
      "test_data": [],
      "steps": [
        "Attempt to add to cart"
      ],
      "expected_results": [
        "OUT_OF_STOCK error"
      ]
    },
    {
      "id": "TC-CART-002-01",
      "name": "Add existing item increases quantity",
      "type": "happy_path",
      "ac_ref": "AC-CART-002",
      "br_refs": [],
      "preconditions": [
        "Cart has Widget qty 2"
      ],
      "test_data": [
        {
          "field": "add_quantity",
          "value": "3",
          "notes": ""
        }
      ],
      "steps": [
        "Add 3 more Widget"
      ],
      "expected_results": [
        "Cart shows Widget qty 5",
        "Single line item"
      ]
    },
    {
      "id": "TC-CART-003-01",
      "name": "Guest cart merges on login",
      "type": "happy_path",
      "ac_ref": "AC-CART-003",
      "br_refs": [],
      "preconditions": [
        "Guest has cart items",
        "Account has cart items"
      ],
      "test_data": [],
      "steps": [
        "Add items as guest",
        "Log in"
      ],
      "expected_results": [
        "Carts merged"
      ]
    },
    {
      "id": "TC-CART-004-01",
      "name": "Update cart item quantity",
      "type": "happy_path",
      "ac_ref": "AC-CART-004",
      "br_refs": [],
      "preconditions": [
        "Cart has Widget qty 3",
        "10 in stock"
      ],
      "test_data": [
        {
          "field": "new_quantity",
          "value": "5",
          "notes": ""
        }
      ],
      "steps": [
        "Change quantity to 5"
      ],
      "expected_results": [
        "Quantity updates to 5",
        "Totals recalculate"
      ]
    },
    {
      "id": "TC-CART-004-02",
      "name": "Quantity exceeds stock limited",
      "type": "error_case",
      "ac_ref": "AC-CART-004",
      "br_refs": [],
      "preconditions": [
        "10 units in stock"
      ],
      "test_data": [
        {
          "field": "new_quantity",
          "value": "15",
          "notes": "Exceeds stock"
        }
      ],
      "steps": [
        "Set quantity to 15"
      ],
      "expected_results": [
        "Limited to 10",
        "Only 10 available notification"
      ]
    },
    {
      "id": "TC-CART-005-01",
      "name": "Remove item from cart",
      "type": "happy_path",
      "ac_ref": "AC-CART-005",
      "br_refs": [],
      "preconditions": [
        "Cart has Widget and Gadget"
      ],
      "test_data": [],
      "steps": [
        "Remove Widget"
      ],
      "expected_results": [
        "Widget removed",
        "Undo option for 5 seconds"
      ]
    },
    {
      "id": "TC-CART-006-01",
      "name": "Remove last item shows empty cart",
      "type": "happy_path",
      "ac_ref": "AC-CART-006",
      "br_refs": [],
      "preconditions": [
        "Cart has only Widget"
      ],
      "test_data": [],
      "steps": [
        "Remove Widget"
      ],
      "expected_results": [
        "Empty cart displayed",
        "Continue Shopping link"
      ]
    },
    {
      "id": "TC-CART-007-01",
      "name": "Cart item goes out of stock",
      "type": "happy_path",
      "ac_ref": "AC-CART-007",
      "br_refs": [],
      "preconditions": [
        "Cart has Widget qty 2"
      ],
      "test_data": [],
      "steps": [
        "Inventory drops to 0",
        "View cart"
      ],
      "expected_results": [
        "Out of Stock warning",
        "Checkout blocked"
      ]
    },
    {
      "id": "TC-CART-008-01",
      "name": "Cart price update notification",
      "type": "happy_path",
      "ac_ref": "AC-CART-008",
      "br_refs": [],
      "preconditions": [
        "Cart has Widget at $25.00"
      ],
      "test_data": [],
      "steps": [
        "Admin changes price to $30.00",
        "View cart"
      ],
      "expected_results": [
        "Price shows $30.00",
        "Price change notification"
      ]
    },
    {
      "id": "TC-CART-009-01",
      "name": "Cart expires after 30 days",
      "type": "happy_path",
      "ac_ref": "AC-CART-009",
      "br_refs": [],
      "preconditions": [
        "Cart inactive 30 days"
      ],
      "test_data": [],
      "steps": [
        "Expiration passes",
        "Customer logs in"
      ],
      "expected_results": [
        "Cart cleared",
        "Customer notified"
      ]
    },
    {
      "id": "TC-ORDER-001-01",
      "name": "Place order with free shipping",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-001",
      "br_refs": [],
      "preconditions": [
        "Verified customer",
        "Cart $75+",
        "Valid payment"
      ],
      "test_data": [
        {
          "field": "subtotal",
          "value": "75.00",
          "notes": "Free shipping"
        }
      ],
      "steps": [
        "Place order"
      ],
      "expected_results": [
        "Order pending",
        "Shipping $0",
        "Cart cleared"
      ]
    },
    {
      "id": "TC-ORDER-001-02",
      "name": "Order fails with payment declined",
      "type": "error_case",
      "ac_ref": "AC-ORDER-001",
      "br_refs": [],
      "preconditions": [
        "Payment will fail"
      ],
      "test_data": [],
      "steps": [
        "Place order"
      ],
      "expected_results": [
        "PAYMENT_FAILED error",
        "Cart preserved"
      ]
    },
    {
      "id": "TC-ORDER-002-01",
      "name": "Place order with paid shipping",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-002",
      "br_refs": [],
      "preconditions": [
        "Verified customer",
        "Cart $35"
      ],
      "test_data": [
        {
          "field": "subtotal",
          "value": "35.00",
          "notes": "Below free shipping"
        }
      ],
      "steps": [
        "Place order"
      ],
      "expected_results": [
        "Shipping $5.99",
        "Total $40.99 + tax"
      ]
    },
    {
      "id": "TC-ORDER-003-01",
      "name": "Order number generated correctly",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-003",
      "br_refs": [],
      "preconditions": [
        "Last order ORD-2024-00042"
      ],
      "test_data": [],
      "steps": [
        "Place new order"
      ],
      "expected_results": [
        "Order number ORD-2024-00043"
      ]
    },
    {
      "id": "TC-ORDER-004-01",
      "name": "Order stores price snapshot",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-004",
      "br_refs": [],
      "preconditions": [
        "Widget price $25.00"
      ],
      "test_data": [],
      "steps": [
        "Place order",
        "Admin changes price"
      ],
      "expected_results": [
        "Order line item shows $25.00"
      ]
    },
    {
      "id": "TC-ORDER-005-01",
      "name": "Tax calculated for California",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-005",
      "br_refs": [],
      "preconditions": [
        "Subtotal $100",
        "Shipping to CA"
      ],
      "test_data": [
        {
          "field": "tax_rate",
          "value": "7.25%",
          "notes": "CA rate"
        }
      ],
      "steps": [
        "Calculate order total"
      ],
      "expected_results": [
        "Tax $7.25"
      ]
    },
    {
      "id": "TC-ORDER-006-01",
      "name": "View order history",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-006",
      "br_refs": [],
      "preconditions": [
        "Customer has multiple orders"
      ],
      "test_data": [],
      "steps": [
        "View order history"
      ],
      "expected_results": [
        "Orders with pagination",
        "Shows status and details"
      ]
    },
    {
      "id": "TC-ORDER-007-01",
      "name": "View shipped order with tracking",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-007",
      "br_refs": [],
      "preconditions": [
        "Order shipped with tracking"
      ],
      "test_data": [
        {
          "field": "tracking",
          "value": "1Z999AA10123456784",
          "notes": ""
        }
      ],
      "steps": [
        "View order details"
      ],
      "expected_results": [
        "Tracking number shown",
        "Carrier link provided"
      ]
    },
    {
      "id": "TC-ORDER-008-01",
      "name": "Cancel pending order",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-008",
      "br_refs": [],
      "preconditions": [
        "Order status pending"
      ],
      "test_data": [
        {
          "field": "reason",
          "value": "Changed mind",
          "notes": ""
        }
      ],
      "steps": [
        "Request cancellation"
      ],
      "expected_results": [
        "Status cancelled",
        "Inventory restored",
        "Refund initiated"
      ]
    },
    {
      "id": "TC-ORDER-009-01",
      "name": "Cancel confirmed order",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-009",
      "br_refs": [],
      "preconditions": [
        "Order status confirmed"
      ],
      "test_data": [],
      "steps": [
        "Request cancellation"
      ],
      "expected_results": [
        "Status cancelled",
        "Refund initiated"
      ]
    },
    {
      "id": "TC-ORDER-010-01",
      "name": "Cannot cancel shipped order",
      "type": "error_case",
      "ac_ref": "AC-ORDER-010",
      "br_refs": [],
      "preconditions": [
        "Order status shipped"
      ],
      "test_data": [],
      "steps": [
        "Attempt cancellation"
      ],
      "expected_results": [
        "ORDER_ALREADY_SHIPPED error"
      ]
    },
    {
      "id": "TC-ORDER-011-01",
      "name": "Order confirmation email sent",
      "type": "happy_path",
      "ac_ref": "AC-ORDER-011",
      "br_refs": [],
      "preconditions": [
        "Order just placed"
      ],
      "test_data": [],
      "steps": [
        "Complete order placement"
      ],
      "expected_results": [
        "Email queued with order details"
      ]
    },
    {
      "id": "TC-ADMIN-001-01",
      "name": "Admin adds new product",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-001",
      "br_refs": [],
      "preconditions": [
        "Admin logged in"
      ],
      "test_data": [
        {
          "field": "name",
          "value": "Super Widget",
          "notes": ""
        },
        {
          "field": "price",
          "value": "29.99",
          "notes": ""
        },
        {
          "field": "category",
          "value": "Electronics",
          "notes": ""
        }
      ],
      "steps": [
        "Create product"
      ],
      "expected_results": [
        "Product created as draft",
        "UUID assigned"
      ]
    },
    {
      "id": "TC-ADMIN-001-02",
      "name": "Add product with invalid price",
      "type": "error_case",
      "ac_ref": "AC-ADMIN-001",
      "br_refs": [],
      "preconditions": [
        "Admin logged in"
      ],
      "test_data": [
        {
          "field": "price",
          "value": "-5.00",
          "notes": "Invalid"
        }
      ],
      "steps": [
        "Submit product with negative price"
      ],
      "expected_results": [
        "INVALID_PRICE error"
      ]
    },
    {
      "id": "TC-ADMIN-002-01",
      "name": "Upload product images",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-002",
      "br_refs": [],
      "preconditions": [
        "Product in draft status"
      ],
      "test_data": [
        {
          "field": "images",
          "value": "3 images",
          "notes": ""
        }
      ],
      "steps": [
        "Upload images",
        "Set primary"
      ],
      "expected_results": [
        "Images uploaded",
        "Primary marked"
      ]
    },
    {
      "id": "TC-ADMIN-002-02",
      "name": "Upload exceeds max images",
      "type": "error_case",
      "ac_ref": "AC-ADMIN-002",
      "br_refs": [],
      "preconditions": [
        "Product exists"
      ],
      "test_data": [
        {
          "field": "images",
          "value": "11 images",
          "notes": "Exceeds limit"
        }
      ],
      "steps": [
        "Upload 11 images"
      ],
      "expected_results": [
        "MAX_IMAGES_EXCEEDED error"
      ]
    },
    {
      "id": "TC-ADMIN-003-01",
      "name": "Edit product price",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-003",
      "br_refs": [],
      "preconditions": [
        "Widget price $25.00"
      ],
      "test_data": [
        {
          "field": "new_price",
          "value": "30.00",
          "notes": ""
        }
      ],
      "steps": [
        "Change price"
      ],
      "expected_results": [
        "Price updated",
        "Change logged"
      ]
    },
    {
      "id": "TC-ADMIN-004-01",
      "name": "Concurrent edit shows conflict",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-004",
      "br_refs": [],
      "preconditions": [
        "Two admins editing same product"
      ],
      "test_data": [],
      "steps": [
        "Admin A saves",
        "Admin B saves"
      ],
      "expected_results": [
        "Admin B overwrites",
        "Conflict warning shown"
      ]
    },
    {
      "id": "TC-ADMIN-005-01",
      "name": "Soft delete product with orders",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-005",
      "br_refs": [],
      "preconditions": [
        "Product has order history"
      ],
      "test_data": [],
      "steps": [
        "Confirm removal"
      ],
      "expected_results": [
        "Product soft-deleted",
        "History preserved"
      ]
    },
    {
      "id": "TC-ADMIN-006-01",
      "name": "Filter orders by status and date",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-006",
      "br_refs": [],
      "preconditions": [
        "100 orders exist"
      ],
      "test_data": [
        {
          "field": "status",
          "value": "shipped",
          "notes": ""
        },
        {
          "field": "date_range",
          "value": "last 7 days",
          "notes": ""
        }
      ],
      "steps": [
        "Apply filters"
      ],
      "expected_results": [
        "Matching orders displayed"
      ]
    },
    {
      "id": "TC-ADMIN-007-01",
      "name": "Export orders to CSV",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-007",
      "br_refs": [],
      "preconditions": [
        "Filtered list with 25 orders"
      ],
      "test_data": [],
      "steps": [
        "Click Export CSV"
      ],
      "expected_results": [
        "CSV file downloads"
      ]
    },
    {
      "id": "TC-ADMIN-008-01",
      "name": "Update order status to shipped",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-008",
      "br_refs": [],
      "preconditions": [
        "Order status confirmed"
      ],
      "test_data": [
        {
          "field": "tracking",
          "value": "1Z999AA10123456784",
          "notes": ""
        }
      ],
      "steps": [
        "Update to shipped with tracking"
      ],
      "expected_results": [
        "Status shipped",
        "Tracking stored",
        "Email sent"
      ]
    },
    {
      "id": "TC-ADMIN-008-02",
      "name": "Invalid status transition rejected",
      "type": "error_case",
      "ac_ref": "AC-ADMIN-008",
      "br_refs": [],
      "preconditions": [
        "Order status pending"
      ],
      "test_data": [],
      "steps": [
        "Try to set status to shipped"
      ],
      "expected_results": [
        "INVALID_STATUS_TRANSITION error"
      ]
    },
    {
      "id": "TC-ADMIN-009-01",
      "name": "Set inventory quantity",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-009",
      "br_refs": [],
      "preconditions": [
        "Widget stock 50"
      ],
      "test_data": [
        {
          "field": "new_stock",
          "value": "100",
          "notes": ""
        },
        {
          "field": "reason",
          "value": "Shipment received",
          "notes": ""
        }
      ],
      "steps": [
        "Set stock to 100"
      ],
      "expected_results": [
        "Stock 100",
        "Audit log created"
      ]
    },
    {
      "id": "TC-ADMIN-010-01",
      "name": "Adjust inventory delta",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-010",
      "br_refs": [],
      "preconditions": [
        "Widget stock 50"
      ],
      "test_data": [
        {
          "field": "adjustment",
          "value": "-5",
          "notes": ""
        },
        {
          "field": "reason",
          "value": "Damaged goods",
          "notes": ""
        }
      ],
      "steps": [
        "Adjust by -5"
      ],
      "expected_results": [
        "Stock 45",
        "Audit log created"
      ]
    },
    {
      "id": "TC-ADMIN-010-02",
      "name": "Adjustment causing negative stock fails",
      "type": "error_case",
      "ac_ref": "AC-ADMIN-010",
      "br_refs": [],
      "preconditions": [
        "Widget stock 5"
      ],
      "test_data": [
        {
          "field": "adjustment",
          "value": "-10",
          "notes": "Would go negative"
        }
      ],
      "steps": [
        "Adjust by -10"
      ],
      "expected_results": [
        "INSUFFICIENT_STOCK error"
      ]
    },
    {
      "id": "TC-ADMIN-011-01",
      "name": "Bulk inventory update via CSV",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-011",
      "br_refs": [],
      "preconditions": [
        "CSV with 50 SKUs"
      ],
      "test_data": [],
      "steps": [
        "Import CSV"
      ],
      "expected_results": [
        "Valid rows updated",
        "Errors reported"
      ]
    },
    {
      "id": "TC-ADMIN-012-01",
      "name": "Low stock alert triggered",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-012",
      "br_refs": [],
      "preconditions": [
        "Threshold 10",
        "Current stock 15"
      ],
      "test_data": [],
      "steps": [
        "Stock drops to 8"
      ],
      "expected_results": [
        "Low stock alert triggered"
      ]
    },
    {
      "id": "TC-ADMIN-013-01",
      "name": "Create category hierarchy",
      "type": "happy_path",
      "ac_ref": "AC-ADMIN-013",
      "br_refs": [],
      "preconditions": [
        "Electronics category exists"
      ],
      "test_data": [
        {
          "field": "name",
          "value": "Smartphones",
          "notes": ""
        },
        {
          "field": "parent",
          "value": "Electronics",
          "notes": ""
        }
      ],
      "steps": [
        "Create subcategory"
      ],
      "expected_results": [
        "Subcategory created with parent ref"
      ]
    },
    {
      "id": "TC-ADMIN-013-02",
      "name": "Category exceeds max nesting",
      "type": "error_case",
      "ac_ref": "AC-ADMIN-013",
      "br_refs": [],
      "preconditions": [
        "3 levels already exist"
      ],
      "test_data": [],
      "steps": [
        "Create 4th level category"
      ],
      "expected_results": [
        "MAX_NESTING_EXCEEDED error"
      ]
    },
    {
      "id": "TC-PAY-001-01",
      "name": "Pay with credit card",
      "type": "happy_path",
      "ac_ref": "AC-PAY-001",
      "br_refs": [],
      "preconditions": [
        "Customer at checkout"
      ],
      "test_data": [
        {
          "field": "card",
          "value": "Visa 4242",
          "notes": "Valid"
        }
      ],
      "steps": [
        "Submit payment"
      ],
      "expected_results": [
        "Payment authorized",
        "Order created"
      ]
    },
    {
      "id": "TC-PAY-001-02",
      "name": "Card declined",
      "type": "error_case",
      "ac_ref": "AC-PAY-001",
      "br_refs": [],
      "preconditions": [
        "Invalid card"
      ],
      "test_data": [],
      "steps": [
        "Submit payment"
      ],
      "expected_results": [
        "PAYMENT_DECLINED error with reason"
      ]
    },
    {
      "id": "TC-PAY-002-01",
      "name": "Pay with PayPal",
      "type": "happy_path",
      "ac_ref": "AC-PAY-002",
      "br_refs": [],
      "preconditions": [
        "Customer selects PayPal"
      ],
      "test_data": [],
      "steps": [
        "Complete PayPal authorization"
      ],
      "expected_results": [
        "Payment authorized",
        "Order created"
      ]
    },
    {
      "id": "TC-PAY-002-02",
      "name": "PayPal cancelled",
      "type": "error_case",
      "ac_ref": "AC-PAY-002",
      "br_refs": [],
      "preconditions": [
        "Customer at PayPal"
      ],
      "test_data": [],
      "steps": [
        "Cancel PayPal authorization"
      ],
      "expected_results": [
        "PAYMENT_CANCELLED",
        "Return to checkout"
      ]
    },
    {
      "id": "TC-PAY-003-01",
      "name": "Save payment method for future",
      "type": "happy_path",
      "ac_ref": "AC-PAY-003",
      "br_refs": [],
      "preconditions": [
        "Customer completing order"
      ],
      "test_data": [],
      "steps": [
        "Select save for future",
        "Complete order"
      ],
      "expected_results": [
        "Token stored",
        "Available for future use"
      ]
    }
  ]
}